<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>RerootToRawDataModule.cxx Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.16 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>RerootToRawDataModule.cxx</h1><a href="RerootToRawDataModule_8cxx.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 
00002 <font class="comment">// $Id: RerootToRawDataModule.cxx,v 1.40 2002/08/22 22:51:33 rhatcher Exp $</font>
00003 <font class="comment">//</font>
00004 <font class="comment">// A JobControl Module for filling RawData from REROOT</font>
00005 <font class="comment">//</font>
00006 <font class="comment">// rhatcher@fnal.gov</font>
00008 <font class="comment"></font>
00009 <font class="preprocessor">#include "<a class="code" href="RerootToRawDataModule_8h.html">RerootExodus/RerootToRawDataModule.h</a>"</font>
00010 <font class="preprocessor">#include "<a class="code" href="RerootExodus_8h.html">RerootExodus/RerootExodus.h</a>"</font>
00011 
00012 <font class="preprocessor">#include "<a class="code" href="MomNavigator_8h.html">MinosObjectMap/MomNavigator.h</a>"</font>
00013 
00014 <font class="preprocessor">#include "<a class="code" href="MsgService_8h.html">MessageService/MsgService.h</a>"</font>
00015 <font class="preprocessor">#include "<a class="code" href="JobCModuleRegistry_8h.html">JobControl/JobCModuleRegistry.h</a>"</font>
00016 <font class="preprocessor">#include "<a class="code" href="JobCommand_8h.html">JobControl/JobCommand.h</a>"</font>
00017 
00018 <font class="preprocessor">#include "<a class="code" href="MINFast_8h.html">MINF_Classes/MINFast.h</a>"</font>
00019 <font class="preprocessor">#include "<a class="code" href="REROOT__GeomMisc_8h.html">REROOT_Classes/REROOT_GeomMisc.h</a>"</font>
00020 <font class="preprocessor">#include "<a class="code" href="REROOT__PlanePos_8h.html">REROOT_Classes/REROOT_PlanePos.h</a>"</font>
00021 <font class="preprocessor">#include "<a class="code" href="REROOT__PlaneSpec_8h.html">REROOT_Classes/REROOT_PlaneSpec.h</a>"</font>
00022 <font class="preprocessor">#include "<a class="code" href="REROOT__CellPos_8h.html">REROOT_Classes/REROOT_CellPos.h</a>"</font>
00023 
00024 <font class="preprocessor">#include "<a class="code" href="PlexHandle_8h.html">Plex/PlexHandle.h</a>"</font>
00025 
00026 <font class="preprocessor">#include "<a class="code" href="RawRecord_8h.html">RawData/RawRecord.h</a>"</font>
00027 <font class="preprocessor">#include "<a class="code" href="RawDaqSnarlHeader_8h.html">RawData/RawDaqSnarlHeader.h</a>"</font>
00028 <font class="preprocessor">#include "<a class="code" href="RawDigitDataBlock_8h.html">RawData/RawDigitDataBlock.h</a>"</font>
00029 <font class="preprocessor">#include "<a class="code" href="RawBlockRegistry_8h.html">RawData/RawBlockRegistry.h</a>"</font>
00030 <font class="preprocessor">#include "<a class="code" href="RawBlockId_8h.html">RawData/RawBlockId.h</a>"</font>
00031 <font class="preprocessor">#include "<a class="code" href="RawDigit_8h.html">RawData/RawDigit.h</a>"</font>
00032 <font class="preprocessor">#include "<a class="code" href="RawMCDigitMixIn_8h.html">RawData/RawMCDigitMixIn.h</a>"</font>
00033 
00034 <font class="preprocessor">#include "TMath.h"</font>
00035 
<a name="l00036"></a><a class="code" href="RerootToRawDataModule_8cxx.html#a0">00036</a> <font class="keyword">const</font> UInt_t <a class="code" href="RerootToRawDataModule_8cxx.html#a0">dbg_DumpAddToCrate</a>         = 0x0001;
<a name="l00037"></a><a class="code" href="RerootToRawDataModule_8cxx.html#a1">00037</a> <font class="keyword">const</font> UInt_t <a class="code" href="RerootToRawDataModule_8cxx.html#a1">dbg_DumpNewCrate</a>           = 0x0002;
<a name="l00038"></a><a class="code" href="RerootToRawDataModule_8cxx.html#a2">00038</a> <font class="keyword">const</font> UInt_t <a class="code" href="RerootToRawDataModule_8cxx.html#a2">dbg_PrintRawDigitDataBlock</a> = 0x0004;
<a name="l00039"></a><a class="code" href="RerootToRawDataModule_8cxx.html#a3">00039</a> <font class="keyword">const</font> UInt_t <a class="code" href="RerootToRawDataModule_8cxx.html#a3">dbg_WarnAllMissingRCId</a>     = 0x0008;
00040 
<a name="l00041"></a><a class="code" href="RerootToRawDataModule_8cxx.html#a4">00041</a> <a class="code" href="VldValidate_8cxx.html#a1">ClassImp</a>(<a class="code" href="classRerootToRawDataModule.html">RerootToRawDataModule</a>)
00042 
00043 <font class="comment">//......................................................................</font>
00044 
00045 <a class="code" href="MsgService_8h.html#a0">CVSID</a>(<font class="stringliteral">"$Id: RerootToRawDataModule.cxx,v 1.40 2002/08/22 22:51:33 rhatcher Exp $"</font>);
00046 <a class="code" href="JobCModuleRegistry_8h.html#a0">JOBMODULE</a>(<a class="code" href="classRerootToRawDataModule.html">RerootToRawDataModule</a>, <font class="stringliteral">"RerootToRawDataModule"</font>,
00047          <font class="stringliteral">"Builds RawRecord with RawDigitDataBlock"</font>);
00048 
00049 <font class="comment">//......................................................................</font>
00050 
00051 <a class="code" href="classRerootToRawDataModule.html#a0">RerootToRawDataModule::RerootToRawDataModule</a>() 
00052    : random(0), fDebugFlags(0), fRawPeCut(0.2999), 
00053    ncrates(0), workingcrates(0), cratesizeused(0),
00054    workingarray(0), display(0),
00055    Nplaneshit(0), ofMplanes(0)
00056 {
00057    <font class="comment">// construct a new "RerootToRawDataModule" JobControl module</font>
00058 
00059    <font class="comment">// we'll use a random # generator to set fake "trigbits"</font>
00060    <font class="comment">// the generator can live as long as the module</font>
00061    random = <font class="keyword">new</font> TRandom();
00062 
00063    <font class="comment">// initialize detector to non-legal value</font>
00064    detector = <a class="code" href="classDetectorType.html#s8">DetectorType::EDetectorType</a>(0);
00065 
00066    ncrates = 128;
00067    cratesizeused  = <font class="keyword">new</font> TArrayI(ncrates);
00068    workingcrates  = <font class="keyword">new</font> TArrayI [ncrates];
00069 
00070    Int_t init_alloc = 5 + 100*3;
00071    <font class="keywordflow">for</font> (Int_t <a class="code" href="TCL_8cxx.html#a11">i</a>=0; <a class="code" href="TCL_8cxx.html#a11">i</a>&lt;ncrates; <a class="code" href="TCL_8cxx.html#a11">i</a>++) {
00072       cratesizeused-&gt;AddAt(0,<a class="code" href="TCL_8cxx.html#a11">i</a>);
00073       workingcrates[<a class="code" href="TCL_8cxx.html#a11">i</a>].Set(init_alloc);
00074    }
00075 
00076    nwordsblock = 0;
00077    workingarray = <font class="keyword">new</font> TArrayI(2);
00078 
00079 
00080 }
00081 
00082 <font class="comment">//......................................................................</font>
00083 
<a name="l00084"></a><a class="code" href="classRerootToRawDataModule.html#a1">00084</a> <a class="code" href="classRerootToRawDataModule.html#a1">RerootToRawDataModule::~RerootToRawDataModule</a>() 
00085 {
00086   <a class="code" href="MsgService_8h.html#a1">MSG</a>(<font class="stringliteral">"Exodus"</font>, <a class="code" href="classMsg.html#p1">Msg::kVerbose</a>) &lt;&lt; <font class="stringliteral">"RerootToRawDataModule::Destructor\n"</font>;
00087 
00088   <font class="keywordflow">if</font> (random) <font class="keyword">delete</font> <a class="code" href="classRerootToRawDataModule.html#o0">random</a>;
00089   <a class="code" href="classRerootToRawDataModule.html#o0">random</a> = 0;
00090 
00091   <font class="keywordflow">if</font> (ncrates) {
00092      <font class="keyword">delete</font> [] <a class="code" href="classRerootToRawDataModule.html#o5">workingcrates</a>;
00093      <a class="code" href="classRerootToRawDataModule.html#o5">workingcrates</a> = 0;
00094 
00095      <font class="keyword">delete</font> <a class="code" href="classRerootToRawDataModule.html#o6">cratesizeused</a>;
00096      <a class="code" href="classRerootToRawDataModule.html#o6">cratesizeused</a> = 0;
00097 
00098      <a class="code" href="classRerootToRawDataModule.html#o4">ncrates</a> = 0;
00099   }
00100 
00101   <font class="keywordflow">if</font> (workingarray) <font class="keyword">delete</font> <a class="code" href="classRerootToRawDataModule.html#o8">workingarray</a>;
00102   <a class="code" href="classRerootToRawDataModule.html#o8">workingarray</a> = 0;
00103 
00104   <font class="keywordflow">if</font> (display) <font class="keyword">delete</font> <a class="code" href="classRerootToRawDataModule.html#o9">display</a>;
00105   <a class="code" href="classRerootToRawDataModule.html#o9">display</a> = 0;
00106 
00107 }
00108 
00109 <font class="comment">//......................................................................</font>
00110 
<a name="l00111"></a><a class="code" href="classRerootToRawDataModule.html#a2">00111</a> <a class="code" href="classJobCResult.html">JobCResult</a> <a class="code" href="classRerootToRawDataModule.html#a2">RerootToRawDataModule::Get</a>(<a class="code" href="classMomNavigator.html">MomNavigator</a> *mom)
00112 {
00113    <font class="comment">// Create RawRecord from the current REROOT event</font>
00114    <font class="comment">// available via gMINFast.</font>
00115 
00116   <font class="keywordflow">if</font> (!gMINFast) {
00117     <font class="keyword">static</font> <font class="keywordtype">int</font> nmsg = 10;
00118     <font class="keywordflow">if</font> (nmsg) {
00119       <a class="code" href="MsgService_8h.html#a1">MSG</a>(<font class="stringliteral">"Exodus"</font>,<a class="code" href="classMsg.html#p6">Msg::kFatal</a>) 
00120         &lt;&lt; <font class="stringliteral">"RerootToRawDataModule lacked gMINFast"</font> &lt;&lt; endl
00121         &lt;&lt; <font class="stringliteral">"   perhaps the input isn't a REROOT file"</font>
00122         &lt;&lt; endl;
00123       nmsg--;
00124       <font class="keywordflow">if</font> (!nmsg) <a class="code" href="MsgService_8h.html#a1">MSG</a>(<font class="stringliteral">"Exodus"</font>,<a class="code" href="classMsg.html#p6">Msg::kFatal</a>) 
00125         &lt;&lt; <font class="stringliteral">" ... last such message"</font> &lt;&lt; endl;
00126     }
00127     <font class="keywordflow">return</font> <a class="code" href="classJobCResult.html#s15s5">JobCResult::kError</a>;
00128   }
00129 
00130   <font class="comment">// Prepare to start by getting current REROOT pointers</font>
00131   <font class="comment">// and clearing out the working array</font>
00132   <a class="code" href="classRerootToRawDataModule.html#c0">InitWorkingArray</a>();
00133 
00134   <a class="code" href="classRerootToRawDataModule.html#o10">ndigitsPerPlane</a>.Reset();
00135 
00136   <font class="comment">// For a PlexHandle we need a context</font>
00137   <a class="code" href="classVldContext.html">VldContext</a> vldc = <a class="code" href="classRerootExodus.html#d1">RerootExodus::BuildVldContext</a>();
00138 
00139   <font class="comment">// Get a PlexHandle for PlexStripEndId to RawChannelId conversions</font>
00140   <a class="code" href="classPlexHandle.html">PlexHandle</a> ph(vldc);
00141 
00142   <font class="comment">// Prepare to loop over REROOT digits</font>
00143   <font class="keyword">const</font> TClonesArray *flsdigits   = <a class="code" href="classRerootExodus.html#d29">RerootExodus::GetFLSDigitList</a>();
00144   <a class="code" href="classREROOT__FLSDigit.html">REROOT_FLSDigit</a>    *flsdigit = 0;
00145   TIter diter(flsdigits);
00146 
00147   <a class="code" href="classPlexStripEndId.html">PlexStripEndId</a> seid;
00148   <a class="code" href="classRawChannelId.html">RawChannelId</a>   rcid;
00149   Float_t raw, tdc;
00150   Int_t   isAB;
00151 
00152   <font class="comment">// ADAMO unfilled entries have special values</font>
00153   <font class="comment">// but exact testing doesn't seem to work...</font>
00154   Float_t ADAMO_RNULL =  699050. * (Float_t) (16&lt;&lt;26); <font class="comment">// 699050*16.0**26</font>
00155 
00156   <font class="comment">// loop over all digits</font>
00157   <font class="keywordflow">while</font> ( ( flsdigit = (<a class="code" href="classREROOT__FLSDigit.html">REROOT_FLSDigit</a>*) diter.Next() ) ) {
00158 
00159      <font class="keyword">static</font> <font class="keywordtype">int</font> nmsgIsNull = 20; <font class="comment">// default, limit to 20 messages</font>
00160 
00161      <font class="comment">// process A side</font>
00162      raw  = flsdigit-&gt;<a class="code" href="classREROOT__FLSDigit.html#a11">RawA</a>();
00163      tdc  = flsdigit-&gt;<a class="code" href="classREROOT__FLSDigit.html#a16">TDCA</a>();
00164      isAB = 0;
00165      <font class="keywordflow">if</font> ( raw &gt; 0.0 &amp;&amp; raw &lt; ADAMO_RNULL ) {
00166         seid = <a class="code" href="classRerootExodus.html#d13">RerootExodus::PECAB2SEId</a>(flsdigit-&gt;<a class="code" href="classREROOT__FLSDigit.html#a7">IPln</a>(),flsdigit-&gt;<a class="code" href="classREROOT__FLSDigit.html#a8">IExtr</a>(),
00167                                         flsdigit-&gt;<a class="code" href="classREROOT__FLSDigit.html#a9">ICell</a>(),isAB);
00168         <font class="comment">// make an entry</font>
00169         rcid = ph.<a class="code" href="classPlexHandle.html#a4">GetRawChannelId</a>(seid);
00170         <font class="keywordflow">if</font> (rcid.<a class="code" href="classRawChannelId.html#a27">IsNull</a>()) {
00171            <font class="keywordflow">if</font> (( <a class="code" href="classRerootToRawDataModule.html#o1">fDebugFlags</a> &amp; <a class="code" href="RerootToRawDataModule_8cxx.html#a3">dbg_WarnAllMissingRCId</a>) || nmsgIsNull&gt;0)
00172               <a class="code" href="MsgService_8h.html#a1">MSG</a>(<font class="stringliteral">"Exodus"</font>,<a class="code" href="classMsg.html#p4">Msg::kWarning</a>) 
00173                  &lt;&lt; <font class="stringliteral">"rcid.IsNull() on A side "</font> &lt;&lt; seid.<a class="code" href="classPlexStripEndId.html#a6">AsString</a>() &lt;&lt; endl;
00174            <font class="keywordflow">if</font> (nmsgIsNull==1 &amp; !(<a class="code" href="classRerootToRawDataModule.html#o1">fDebugFlags</a>&amp;<a class="code" href="RerootToRawDataModule_8cxx.html#a3">dbg_WarnAllMissingRCId</a>)) 
00175               <a class="code" href="MsgService_8h.html#a1">MSG</a>(<font class="stringliteral">"Exodus"</font>,<a class="code" href="classMsg.html#p4">Msg::kWarning</a>)
00176                  &lt;&lt; <font class="stringliteral">" ... last IsNull message"</font> &lt;&lt; endl;
00177            nmsgIsNull--;
00178         }
00179         <font class="comment">// add no matter if rcid.IsNull, so we see MC truth</font>
00180         <a class="code" href="classRerootToRawDataModule.html#c1">AddToCrate</a>(seid,rcid,raw,tdc);
00181      }
00182 
00183      <font class="comment">// process B side</font>
00184      raw  = flsdigit-&gt;<a class="code" href="classREROOT__FLSDigit.html#a12">RawB</a>();
00185      tdc  = flsdigit-&gt;<a class="code" href="classREROOT__FLSDigit.html#a17">TDCB</a>();
00186      isAB = 1;
00187      <font class="keywordflow">if</font> ( raw &gt; 0.0 &amp;&amp; raw &lt; ADAMO_RNULL ) {
00188         seid = <a class="code" href="classRerootExodus.html#d13">RerootExodus::PECAB2SEId</a>(flsdigit-&gt;<a class="code" href="classREROOT__FLSDigit.html#a7">IPln</a>(),flsdigit-&gt;<a class="code" href="classREROOT__FLSDigit.html#a8">IExtr</a>(),
00189                                         flsdigit-&gt;<a class="code" href="classREROOT__FLSDigit.html#a9">ICell</a>(),isAB);
00190         <font class="comment">// make an entry</font>
00191         rcid = ph.<a class="code" href="classPlexHandle.html#a4">GetRawChannelId</a>(seid);
00192         <font class="keywordflow">if</font> (rcid.<a class="code" href="classRawChannelId.html#a27">IsNull</a>()) {
00193            <font class="keywordflow">if</font> (( <a class="code" href="classRerootToRawDataModule.html#o1">fDebugFlags</a> &amp; <a class="code" href="RerootToRawDataModule_8cxx.html#a3">dbg_WarnAllMissingRCId</a>) || nmsgIsNull&gt;0)
00194               <a class="code" href="MsgService_8h.html#a1">MSG</a>(<font class="stringliteral">"Exodus"</font>,<a class="code" href="classMsg.html#p4">Msg::kWarning</a>) 
00195                  &lt;&lt; <font class="stringliteral">"rcid.IsNull() on B side "</font> &lt;&lt; seid.<a class="code" href="classPlexStripEndId.html#a6">AsString</a>() &lt;&lt; endl;
00196            <font class="keywordflow">if</font> (nmsgIsNull==1 &amp; !(<a class="code" href="classRerootToRawDataModule.html#o1">fDebugFlags</a>&amp;<a class="code" href="RerootToRawDataModule_8cxx.html#a3">dbg_WarnAllMissingRCId</a>)) 
00197               <a class="code" href="MsgService_8h.html#a1">MSG</a>(<font class="stringliteral">"Exodus"</font>,<a class="code" href="classMsg.html#p4">Msg::kWarning</a>)
00198                  &lt;&lt; <font class="stringliteral">" ... last IsNull message"</font> &lt;&lt; endl;
00199            nmsgIsNull--;
00200         }
00201         <font class="comment">// add no matter if rcid.IsNull, so we see MC truth</font>
00202         <a class="code" href="classRerootToRawDataModule.html#c1">AddToCrate</a>(seid,rcid,raw,tdc);
00203      }
00204   }
00205 
00206   <font class="comment">// Finalize the working array, produce RawDigitDataBlock</font>
00207   <a class="code" href="classRawDataBlock.html">RawDataBlock</a> *rrdb = <a class="code" href="classRerootToRawDataModule.html#c2">FinalizeWorkingArray</a>();
00208 
00209   <font class="keywordflow">if</font> (<a class="code" href="classRerootToRawDataModule.html#o1">fDebugFlags</a> &amp; <a class="code" href="RerootToRawDataModule_8cxx.html#a2">dbg_PrintRawDigitDataBlock</a>) rrdb-&gt;<a class="code" href="classRawDataBlock.html#a9">Print</a>();
00210 
00211   <font class="comment">// produce a RawDaqSnarlHeader (specialized RawHeader)</font>
00212   <font class="comment">// which the RawRecord will adopt</font>
00213 
00214   Int_t   run      = <a class="code" href="classRerootExodus.html#d3">RerootExodus::GetRunNo</a>();
00215   Int_t   snarl    = <a class="code" href="classRerootExodus.html#d4">RerootExodus::GetEventNo</a>();
00216   Int_t   trigbits = <a class="code" href="classRerootToRawDataModule.html#o0">random</a>-&gt;Integer(0x0fffffff);
00217   Short_t subrun = 0;
00218   Short_t runtype = 0;
00219   Int_t   errcode = 0;
00220   <font class="keyword">static</font> Int_t tf = 0;
00221 
00222   <a class="code" href="classRawDaqSnarlHeader.html">RawDaqSnarlHeader</a> *head = 
00223      <font class="keyword">new</font> <a class="code" href="classRawDaqSnarlHeader.html">RawDaqSnarlHeader</a>(vldc,run,subrun,runtype,++tf,snarl,trigbits,errcode);
00224 
00225   <font class="comment">// produce a RawRecord, have it adopt the header</font>
00226   
00227   <a class="code" href="classRawRecord.html">RawRecord</a> *rawrec = <font class="keyword">new</font> <a class="code" href="classRawRecord.html">RawRecord</a>(head);
00228 
00229   <font class="comment">// give the block to the RawRecord</font>
00230 
00231   rawrec-&gt;<a class="code" href="classRawRecord.html#a7">AdoptRawBlock</a>(rrdb);
00232 
00233   <font class="comment">// tag this RawRecord AS IF it had come from the DaqSnarl stream</font>
00234 
00235   rawrec-&gt;<a class="code" href="classRecMinos.html#a10">GetTempTags</a>().<a class="code" href="classRegistry.html#a31">Set</a>(<font class="stringliteral">"stream"</font>,<font class="stringliteral">"DaqSnarl"</font>);
00236 
00237   <font class="comment">// give the RawRecord to MOM to hold as a "fragment"</font>
00238   
00239   mom-&gt;<a class="code" href="classMomNavigator.html#a2">AdoptFragment</a>(rawrec);
00240 
00241   <font class="comment">// </font>
00242 
00243   <font class="keywordflow">return</font> <a class="code" href="classRerootToRawDataModule.html#c3">ApplyTrigger</a>(); <font class="comment">// result depends on trigger</font>
00244 }
00245 
00246 <font class="comment">//......................................................................</font>
00247 
<a name="l00248"></a><a class="code" href="classRerootToRawDataModule.html#c3">00248</a> <a class="code" href="classJobCResult.html">JobCResult</a> <a class="code" href="classRerootToRawDataModule.html#c3">RerootToRawDataModule::ApplyTrigger</a>()
00249 {
00250   <font class="comment">// Apply the N of M trigger for the far detector</font>
00251   <font class="comment">// ?? for CalDet ??</font>
00252 
00253   <font class="keywordflow">if</font> (<a class="code" href="classDetectorType.html#s8s2">DetectorType::kNear</a> == <a class="code" href="classRerootToRawDataModule.html#o2">detector</a>) <font class="keywordflow">return</font> <a class="code" href="classJobCResult.html#s16s7">JobCResult::kPassed</a>;
00254 
00255   <font class="comment">// if no test then always pass</font>
00256   <font class="keywordflow">if</font> (<a class="code" href="classRerootToRawDataModule.html#o11">Nplaneshit</a>&lt;=0) <font class="keywordflow">return</font> <a class="code" href="classJobCResult.html#s16s7">JobCResult::kPassed</a>;
00257 
00258   <font class="comment">// find first &amp; last plane with digits</font>
00259   Int_t first = 0;
00260   Int_t last  = <a class="code" href="classRerootToRawDataModule.html#o10">ndigitsPerPlane</a>.GetSize()-1;
00261   <font class="keywordflow">for</font> ( ; last&gt;first; last-- ) <font class="keywordflow">if</font> (<a class="code" href="classRerootToRawDataModule.html#o10">ndigitsPerPlane</a>[last]&gt;0) <font class="keywordflow">break</font>;
00262   <font class="keywordflow">for</font> ( ; first&lt;last; first++) if (ndigitsPerPlane[first]&gt;0) <font class="keywordflow">break</font>;
00263 
00264   <font class="comment">// if impossibly short then don't bother further, it fails</font>
00265   <font class="keywordflow">if</font> (last-first+1&lt;<a class="code" href="classRerootToRawDataModule.html#o11">Nplaneshit</a>) <font class="keywordflow">return</font> <a class="code" href="classJobCResult.html#s16s8">JobCResult::kFailed</a>;  
00266 
00267   Int_t running_total = 0;
00268   Int_t excluded_plns = 0;
00269   <font class="keywordflow">for</font> (Int_t plane = first; plane&lt;=last; plane++) {
00270 
00271     <font class="comment">// check for uninstrumented plane</font>
00272     <a class="code" href="classPlexPlaneId.html">PlexPlaneId</a> pid(<a class="code" href="classRerootToRawDataModule.html#o2">detector</a>,plane);
00273     <font class="keywordflow">if</font> (pid.<a class="code" href="classPlexPlaneId.html#a8">GetPlaneCoverage</a>() == <a class="code" href="classPlaneCoverage.html#s11s2">PlaneCoverage::kNoActive</a>) {
00274       excluded_plns++;
00275       <font class="keywordflow">if</font> (<a class="code" href="classRerootToRawDataModule.html#o10">ndigitsPerPlane</a>[plane]&gt;0)
00276         <a class="code" href="MsgService_8h.html#a1">MSG</a>(<font class="stringliteral">"Exodus"</font>,<a class="code" href="classMsg.html#p4">Msg::kWarning</a>)
00277           &lt;&lt; <font class="stringliteral">"saw "</font> &lt;&lt; <a class="code" href="classRerootToRawDataModule.html#o10">ndigitsPerPlane</a>[plane]
00278           &lt;&lt; <font class="stringliteral">" digits in uninstrumented plane "</font>
00279           &lt;&lt; pid &lt;&lt; endl;
00280       <font class="keywordflow">else</font>
00281         <a class="code" href="classRerootToRawDataModule.html#o10">ndigitsPerPlane</a>[plane] = -1; <font class="comment">// mark it as to be excluded</font>
00282     }
00283     
00284     <font class="comment">// if appropriate, add this plane into total</font>
00285     <font class="keywordflow">if</font> (<a class="code" href="classRerootToRawDataModule.html#o10">ndigitsPerPlane</a>[plane]&gt;0) running_total++;
00286 
00287     <font class="comment">// start subtracting</font>
00288     Int_t window = <a class="code" href="classRerootToRawDataModule.html#o12">ofMplanes</a> + excluded_plns;
00289     <font class="keywordflow">if</font> (plane&gt;=window-1) { <font class="comment">// -1 for zero based indexing</font>
00290       Int_t ngoingout = <a class="code" href="classRerootToRawDataModule.html#o10">ndigitsPerPlane</a>[plane-window];
00291       <font class="keywordflow">if</font>      (ngoingout &lt; 0) excluded_plns--;
00292       <font class="keywordflow">else</font> <font class="keywordflow">if</font> (ngoingout &gt; 0) running_total--;
00293     }
00294 
00295     <font class="comment">// test if valid</font>
00296     <font class="keywordflow">if</font> ( running_total &gt;= <a class="code" href="classRerootToRawDataModule.html#o11">Nplaneshit</a> ) <font class="keywordflow">return</font> <a class="code" href="classJobCResult.html#s16s7">JobCResult::kPassed</a>;
00297 
00298   }
00299   <font class="comment">// fell through without passing?  failed!</font>
00300   <font class="keywordflow">return</font> <a class="code" href="classJobCResult.html#s16s8">JobCResult::kFailed</a>;
00301 }
00302 
00303 <font class="comment">//......................................................................</font>
00304 
<a name="l00305"></a><a class="code" href="classRerootToRawDataModule.html#a3">00305</a> <a class="code" href="classJobCResult.html">JobCResult</a> <a class="code" href="classRerootToRawDataModule.html#a3">RerootToRawDataModule::Reco</a>(<a class="code" href="classMomNavigator.html">MomNavigator</a> *mom)
00306 {
00307   <font class="comment">// A test job for "reconstruction"</font>
00308   <font class="comment">// This example code unpacks the RawDataBlocks in the RawRecord</font>
00309   <font class="comment">// and displays them on a CheezyDisplay using the Plex</font>
00310   <font class="comment">// to convert from RawRecordId into PlexStripEndId's</font>
00311   
00312   <font class="comment">//  MSG("Exodus", Msg::kVerbose) &lt;&lt; "RerootToRawDataModule::Reco\n";</font>
00313 
00314   TObject   *obj;
00315 
00316   <font class="comment">// Get the RawRecord from Mom</font>
00317   <a class="code" href="classRawRecord.html">RawRecord</a> *rawrec = dynamic_cast&lt;RawRecord *&gt;
00318                                         (mom-&gt;<a class="code" href="classMomNavigator.html#a3">GetFragment</a>(<font class="stringliteral">"RawRecord"</font>));
00319   <font class="keywordflow">if</font> ( ! rawrec ) {
00320      <a class="code" href="MsgService_8h.html#a1">MSG</a>(<font class="stringliteral">"Exodus"</font>,<a class="code" href="classMsg.html#p6">Msg::kFatal</a>) &lt;&lt; <font class="stringliteral">"RerootToRawDataModule::Reco"</font> &lt;&lt;
00321         <font class="stringliteral">" failed to fin a \"RawRecord\""</font> &lt;&lt; endl;
00322      <font class="keywordflow">return</font> <a class="code" href="classJobCResult.html#s15s5">JobCResult::kError</a>;
00323   }
00324   
00325   <font class="comment">// For a PlexHandle we need a context</font>
00326   <a class="code" href="classVldContext.html">VldContext</a> vldc = rawrec-&gt;<a class="code" href="classRawRecord.html#a3">GetRawHeader</a>()-&gt;<a class="code" href="classRecMinosHdr.html#a3">GetVldContext</a>();
00327 
00328   <font class="comment">// Get a PlexHandle for PlexStripEndId to RawChannelId conversions</font>
00329   <a class="code" href="classPlexHandle.html">PlexHandle</a> ph(vldc);
00330 
00331   <font class="comment">// Create (if necessary) a display</font>
00332   <font class="keywordflow">if</font> ( ! <a class="code" href="classRerootToRawDataModule.html#o9">display</a> ) <a class="code" href="classRerootToRawDataModule.html#o9">display</a> = 
00333                       <font class="keyword">new</font> <a class="code" href="classCheezyDisplay.html">CheezyDisplay</a>(<font class="stringliteral">"RerootToRawDataModule"</font>,
00334                                         <font class="stringliteral">"RerootToRawDataModule display"</font>);
00335   <a class="code" href="classRerootToRawDataModule.html#o9">display</a>-&gt;<a class="code" href="classCheezyDisplay.html#a4">ClearLists</a>();
00336   <a class="code" href="classRerootToRawDataModule.html#o9">display</a>-&gt;<a class="code" href="classCheezyDisplay.html#a3">SetVldContext</a>(vldc);
00337 
00338 
00339   <font class="comment">// from the RawRecord loop over the RawDataBlocks</font>
00340   <a class="code" href="classRawDigitDataBlock.html">RawDigitDataBlock</a>     *digitblk  = 0;
00341   TIter blkiter = rawrec-&gt;<a class="code" href="classRawRecord.html#a6">GetRawBlockIter</a>();
00342   <font class="keywordflow">while</font> ( ( obj = blkiter.Next() ) ) {
00343      digitblk  = dynamic_cast&lt;RawDigitDataBlock*&gt;(obj);
00344      <font class="keywordflow">if</font> (digitblk) {
00345 
00346         <font class="comment">// Loop over the digits make counts</font>
00347         <a class="code" href="classRawDigit.html">RawDigit</a>       *digit = 0;
00348         TIter diter = digitblk-&gt;<a class="code" href="classRawDigitDataBlock.html#a9">GetDatumIter</a>();
00349 
00350         <font class="keywordflow">while</font> ( ( digit = (<a class="code" href="classRawDigit.html">RawDigit</a>*) diter.Next() ) ) {
00351            
00352            <font class="comment">// if it came from a Raw{Qie,Va}MCDigit then there</font>
00353            <font class="comment">// is Truth(TM) info available</font>
00354            <font class="comment">// cast the digit correctly and retrieve it</font>
00355            <a class="code" href="classRawMCDigitMixIn.html">RawMCDigitMixIn</a> *truthDigit = dynamic_cast&lt;RawMCDigitMixIn*&gt;(digit);
00356            <font class="keywordflow">if</font> (truthDigit) {
00357               <a class="code" href="classPlexStripEndId.html">PlexStripEndId</a> seid(truthDigit-&gt;<a class="code" href="classRawMCDigitMixIn.html#a3">GetTrueSEIdEncoded</a>());
00358               <a class="code" href="classRerootToRawDataModule.html#o9">display</a>-&gt;<a class="code" href="classCheezyDisplay.html#a5">AddStripEndId</a>(seid,kTRUE);
00359            }           
00360 
00361            <font class="comment">// ALT LIST</font>
00362            <a class="code" href="classRawChannelId.html">RawChannelId</a> rcid = digit-&gt;<a class="code" href="classRawDigit.html#a3">GetChannel</a>();
00363            <a class="code" href="classPlexSEIdAltL.html">PlexSEIdAltL</a> altlist = ph.<a class="code" href="classPlexHandle.html#a7">GetSEIdAltL</a>(rcid);
00364            altlist.<a class="code" href="classPlexSEIdAltL.html#a28">SetFirst</a>();
00365            <font class="keywordflow">while</font> ( altlist.<a class="code" href="classPlexSEIdAltL.html#a25">IsValid</a>() ) {
00366               <a class="code" href="classPlexStripEndId.html">PlexStripEndId</a> seid = altlist.<a class="code" href="classPlexSEIdAltL.html#a14">GetCurrentSEId</a>();
00367               <a class="code" href="classRerootToRawDataModule.html#o9">display</a>-&gt;<a class="code" href="classCheezyDisplay.html#a5">AddStripEndId</a>(seid,kFALSE);
00368               altlist.<a class="code" href="classPlexSEIdAltL.html#a26">Next</a>();
00369            }
00370         }
00371 
00372      }
00373   }
00374      
00375   <font class="comment">// Now actually draw these things</font>
00376   <a class="code" href="classRerootToRawDataModule.html#o9">display</a>-&gt;<a class="code" href="classCheezyDisplay.html#a7">Draw</a>();
00377 
00378   <font class="keywordflow">return</font> <a class="code" href="classJobCResult.html#s15s3">JobCResult::kAOK</a>;
00379 
00380 }
00381 
00382 <font class="comment">//......................................................................</font>
00383 
<a name="l00384"></a><a class="code" href="classRerootToRawDataModule.html#c0">00384</a> <font class="keywordtype">void</font> <a class="code" href="classRerootToRawDataModule.html#c0">RerootToRawDataModule::InitWorkingArray</a>(<font class="keywordtype">void</font>)
00385 {
00386    <font class="comment">// Initialize for new "Get"</font>
00387 
00388    <font class="comment">// zero out used sizes ...</font>
00389    <font class="keywordflow">for</font> (Int_t <a class="code" href="TCL_8cxx.html#a11">i</a>=0; <a class="code" href="TCL_8cxx.html#a11">i</a>&lt;<a class="code" href="classRerootToRawDataModule.html#o4">ncrates</a>; <a class="code" href="TCL_8cxx.html#a11">i</a>++) {
00390       <a class="code" href="classRerootToRawDataModule.html#o6">cratesizeused</a>-&gt;AddAt(0,<a class="code" href="TCL_8cxx.html#a11">i</a>);
00391    }
00392    <a class="code" href="classRerootToRawDataModule.html#o7">nwordsblock</a> = 0;
00393 
00394    <a class="code" href="classRerootToRawDataModule.html#o2">detector</a> = <a class="code" href="classRerootExodus.html#d0">RerootExodus::GetDetector</a>();
00395 }
00396 
00397 <font class="comment">//......................................................................</font>
00398 
<a name="l00399"></a><a class="code" href="classRerootToRawDataModule.html#c1">00399</a> <font class="keywordtype">void</font> <a class="code" href="classRerootToRawDataModule.html#c1">RerootToRawDataModule::AddToCrate</a>(<font class="keyword">const</font> <a class="code" href="classPlexStripEndId.html">PlexStripEndId</a>&amp; seid,
00400                                        <font class="keyword">const</font> <a class="code" href="classRawChannelId.html">RawChannelId</a>&amp;   rcid,
00401                                        Float_t raw, Float_t tdc)
00402 {
00403    <font class="comment">// Add this entry into the crate array</font>
00404 
00405    <font class="comment">// apply the cut if necessary</font>
00406    <font class="keywordflow">if</font> (raw &lt; <a class="code" href="classRerootToRawDataModule.html#o3">fRawPeCut</a> ) {
00407       <font class="keyword">static</font> Float_t last_cut_msg = -1;
00408       <font class="keywordflow">if</font> (last_cut_msg != <a class="code" href="classRerootToRawDataModule.html#o3">fRawPeCut</a>) {
00409          <font class="comment">// one warning for any given cut level</font>
00410          last_cut_msg = <a class="code" href="classRerootToRawDataModule.html#o3">fRawPeCut</a>;
00411          <a class="code" href="MsgService_8h.html#a1">MSG</a>(<font class="stringliteral">"Exodus"</font>,<a class="code" href="classMsg.html#p3">Msg::kInfo</a>)
00412             &lt;&lt; <font class="stringliteral">"::AddToCrate cutting all raw values &lt; "</font>
00413             &lt;&lt; <a class="code" href="classRerootToRawDataModule.html#o3">fRawPeCut</a> &lt;&lt; endl;
00414       }
00415       <font class="keywordflow">return</font>;
00416    }
00417 
00418    <font class="comment">// keep track of # of digits in each plane (above threshold)</font>
00419    Int_t plane = seid.<a class="code" href="classPlexPlaneId.html#a7">GetPlane</a>();
00420    <font class="keywordflow">if</font> (<a class="code" href="classRerootToRawDataModule.html#o10">ndigitsPerPlane</a>.GetSize()&lt;plane+1) <a class="code" href="classRerootToRawDataModule.html#o10">ndigitsPerPlane</a>.Set(plane+1);
00421    <a class="code" href="classRerootToRawDataModule.html#o10">ndigitsPerPlane</a>[plane]++;
00422 
00423    Int_t crate = rcid.<a class="code" href="classRawChannelId.html#a13">GetCrate</a>();
00424    <font class="keywordflow">if</font> (crate&gt;=<a class="code" href="classRerootToRawDataModule.html#o4">ncrates</a>) {
00425       <a class="code" href="MsgService_8h.html#a1">MSG</a>(<font class="stringliteral">"Exodus"</font>,<a class="code" href="classMsg.html#p6">Msg::kFatal</a>) 
00426          &lt;&lt; <font class="stringliteral">"RerootToRawDataModule::AddToCrate "</font>
00427          &lt;&lt; crate &lt;&lt; <font class="stringliteral">" larger than allocated "</font> &lt;&lt; <a class="code" href="classRerootToRawDataModule.html#o4">ncrates</a> &lt;&lt; endl;
00428       <font class="keywordflow">return</font>;
00429    }
00430 
00431    TArrayI *wcrate = &amp;<a class="code" href="classRerootToRawDataModule.html#o5">workingcrates</a>[crate];
00432 
00433    <font class="comment">//  Crate block format is:</font>
00434    <font class="comment">//-------------------------</font>
00435    <font class="comment">//   0: Crate #</font>
00436    <font class="comment">//   1: # ndigits in crate (N)</font>
00437    <font class="comment">//   2: GPS T0 sec</font>
00438    <font class="comment">//   3: GPS T0 nsec</font>
00439    <font class="comment">//   4: readout 1 word 1</font>
00440    <font class="comment">//   5: readout 1 word 2</font>
00441    <font class="comment">//   6: PlexStripEndId.fEncoded truth</font>
00442    <font class="comment">//   7: readout 2 word 1</font>
00443    <font class="comment">//   8: readout 2 word 2</font>
00444    <font class="comment">//   9: PlexStripEndId.fEncoded truth</font>
00445 
00446    <font class="keyword">const</font> Int_t hsize        = 4; <font class="comment">// header size</font>
00447    <font class="keyword">const</font> Int_t ndigits_indx = 1; <font class="comment">// index for pair count</font>
00448    <font class="keyword">const</font> Int_t nw_digit     = 3; <font class="comment">// 3 words per digit</font>
00449 
00450    <font class="comment">// if allocated size is too small make it bigger</font>
00451    Int_t used = <a class="code" href="classRerootToRawDataModule.html#o6">cratesizeused</a>-&gt;At(crate);
00452    Int_t need = used + nw_digit;  <font class="comment">// each new entry adds three words</font>
00453    <font class="keywordflow">if</font> (0 == used) need += hsize;
00454 
00455    <font class="keyword">const</font> Int_t slop = 100; <font class="comment">// min extra allocation</font>
00456 
00457    <font class="keywordflow">if</font> (wcrate-&gt;GetSize() &lt; need) {
00458       wcrate-&gt;Set(need+slop);
00459    }
00460 
00461    <font class="comment">// add in header stuff if necessary</font>
00462    <font class="keywordflow">if</font> (0 == used) {
00463       <font class="comment">// crate # + ped/common modes + electronics flag</font>
00464       <font class="keyword">const</font> Int_t modes = 0x07;
00465       Int_t etype = rcid.<a class="code" href="classRawChannelId.html#a9">GetElecType</a>();
00466       Int_t packedCrate = (modes &lt;&lt; 8) |
00467          (etype &lt;&lt; 6) | (crate &amp; 0x0000003f);
00468       wcrate-&gt;AddAt(packedCrate,used++);
00469       <font class="comment">// # digits</font>
00470       <font class="keywordflow">if</font> (used != ndigits_indx) {
00471          <font class="comment">// this should never happen</font>
00472          <a class="code" href="MsgService_8h.html#a1">MSG</a>(<font class="stringliteral">"Exodus"</font>,<a class="code" href="classMsg.html#p6">Msg::kFatal</a>) 
00473             &lt;&lt; <font class="stringliteral">"RerootToRawDataModule::AddToCrate ndigits_indx "</font>
00474             &lt;&lt; ndigits_indx &lt;&lt; <font class="stringliteral">" != "</font> &lt;&lt; used &lt;&lt; endl;
00475       }
00476       wcrate-&gt;AddAt(0,used++);
00477       <font class="comment">// GPS T0 (sec,nsec)</font>
00478       <a class="code" href="classVldTimeStamp.html">VldTimeStamp</a> vts = <a class="code" href="classRerootExodus.html#d1">RerootExodus::BuildVldContext</a>().<a class="code" href="classVldContext.html#a6">GetTimeStamp</a>();
00479       wcrate-&gt;AddAt(vts.<a class="code" href="classVldTimeStamp.html#a11">GetSec</a>(),used++);
00480       wcrate-&gt;AddAt(vts.<a class="code" href="classVldTimeStamp.html#a12">GetNanoSec</a>(),used++);
00481       <font class="comment">// if flag is set dump what we just did</font>
00482       <font class="keywordflow">if</font> (<a class="code" href="classRerootToRawDataModule.html#o1">fDebugFlags</a> &amp; <a class="code" href="RerootToRawDataModule_8cxx.html#a1">dbg_DumpNewCrate</a>) {
00483          printf(<font class="stringliteral">"new header for crate %3d %#8.8x\n"</font>,crate,packedCrate);
00484       }
00485    }
00486 
00487    <font class="comment">//       3         2         1         0</font>
00488    <font class="comment">//      10987654321098765432109876543210</font>
00489    <font class="comment">//  U:  1PXcccccccccccchhaaaaaaaaaaaaaa   X=common mode,c=chan, h=hdr a=adc</font>
00490    <font class="comment">//  L:  0Pttttttttttttttttttttttttttttt   P=parity, t=tdc</font>
00491    <font class="comment">//  X:  PlexStripEndId::fEncoded</font>
00492 
00493    <font class="keyword">const</font> <font class="keywordtype">int</font> signbit    = 0x80000000;
00494 <font class="comment">//rwh:not_used_yet   const int hdrmask    = 0x0000c000;</font>
00495 <font class="comment">//rwh:not_used_yet   const int parityb    = 0x40000000;</font>
00496 <font class="comment">//rwh:not_used_yet   const int cmodeb     = 0x20000000;</font>
00497    <font class="keyword">const</font> <font class="keywordtype">int</font> chaddmask  = 0x1fff;
00498    <font class="keyword">const</font> <font class="keywordtype">int</font> chaddshift = 16;
00499    <font class="keyword">const</font> <font class="keywordtype">int</font> adcmask    = 0x00003fff;
00500    <font class="keyword">const</font> <font class="keywordtype">int</font> tdcmask    = 0x3fffffff;
00501 
00502    <font class="comment">// ADC = FLSDigit.RawA|B * 100  :  max RawX = (2^17-1)/100 = 1310.7pe</font>
00503    <font class="comment">// TDC = FLSDigit.TdcA|B *  10  :  max TdcX = (2^28-1)/10  = 26.8msec</font>
00504 
00505    <font class="comment">// create the three words we'll be putting in</font>
00506 <font class="comment">//rwh:not_used_yet   Int_t err     = 0;</font>
00507    Int_t chadd   = rcid.<a class="code" href="classRawChannelId.html#a14">GetChAdd</a>();
00508    <font class="keywordflow">if</font> (chadd &gt; chaddmask) {
00509       <font class="comment">// this should never happen</font>
00510       <font class="keyword">static</font> <font class="keywordtype">int</font> nmsg_chadd = 5;
00511       <font class="keywordflow">if</font> (nmsg_chadd) {
00512          <a class="code" href="MsgService_8h.html#a1">MSG</a>(<font class="stringliteral">"Exodus"</font>,<a class="code" href="classMsg.html#p6">Msg::kFatal</a>) 
00513             &lt;&lt; <font class="stringliteral">"RerootToRawDataModule::AddToCrate chadd "</font>
00514             &lt;&lt; hex &lt;&lt; chadd &lt;&lt; dec &lt;&lt; <font class="stringliteral">" truncated from "</font> 
00515             &lt;&lt; hex &lt;&lt; rcid.<a class="code" href="classRawChannelId.html#a14">GetChAdd</a>() &lt;&lt; dec &lt;&lt; endl;
00516          nmsg_chadd--;
00517          <font class="keywordflow">if</font> (nmsg_chadd==0) 
00518             <a class="code" href="MsgService_8h.html#a1">MSG</a>(<font class="stringliteral">"Exodus"</font>,<a class="code" href="classMsg.html#p6">Msg::kFatal</a>) 
00519                &lt;&lt; <font class="stringliteral">" ... last of these messages"</font> &lt;&lt; endl;
00520       }
00521    }
00522    chadd &amp;= chaddmask;
00523 
00524    Int_t iadc     = TMath::Nint( raw * 100.0 );
00525    <font class="keywordflow">if</font> (iadc &gt; adcmask ) {
00526       <font class="comment">// this should never happen</font>
00527       <font class="keyword">static</font> <font class="keywordtype">int</font> nmsg_adc = 5;
00528       <font class="keywordflow">if</font> (nmsg_adc) {
00529          <a class="code" href="MsgService_8h.html#a1">MSG</a>(<font class="stringliteral">"Exodus"</font>,<a class="code" href="classMsg.html#p4">Msg::kWarning</a>) 
00530             &lt;&lt; <font class="stringliteral">"RerootToRawDataModule::AddToCrate iadc "</font>
00531             &lt;&lt; iadc &lt;&lt; <font class="stringliteral">" does not fit in field  (max "</font> 
00532             &lt;&lt; adcmask &lt;&lt; <font class="stringliteral">")"</font> &lt;&lt; endl;
00533          nmsg_adc--;
00534          <font class="keywordflow">if</font> (nmsg_adc==0)
00535             <a class="code" href="MsgService_8h.html#a1">MSG</a>(<font class="stringliteral">"Exodus"</font>,<a class="code" href="classMsg.html#p4">Msg::kWarning</a>) 
00536                &lt;&lt; <font class="stringliteral">" ... last of these messages"</font> &lt;&lt; endl;
00537       }     
00538       iadc = TMath::Max(0,TMath::Min(iadc,adcmask));
00539    }
00540    iadc &amp;= adcmask;
00541 
00542 <font class="comment">// Convert from 0.1*Munits:ns to standard Munits base time units (sec).</font>
00543    Float_t tdc_convert = 0.1; <font class="comment">// REROOT, non-VA, non-QIE scale factor</font>
00544    <font class="keywordflow">switch</font> (rcid.<a class="code" href="classRawChannelId.html#a9">GetElecType</a>()) {
00545    <font class="keywordflow">case</font> (ElecType::kVA):  
00546      <font class="comment">// VA electronics, tick = 1.5625 ns (640MHz)</font>
00547      tdc_convert = 1.5625;
00548      <font class="keywordflow">break</font>;
00549    <font class="keywordflow">case</font> (ElecType::kQIE):
00550      <font class="comment">// QIE electronics, tick = 18.832 ns (RF clock)</font>
00551      tdc_convert =  1000./53.1;  <font class="comment">// clock is 53.1MHz</font>
00552      <font class="comment">// CalDet has yet a different clock frequency</font>
00553      <font class="keywordflow">if</font> (rcid.<a class="code" href="classRawChannelId.html#a8">GetDetector</a>() == <a class="code" href="classDetectorType.html#s8s4">DetectorType::kCalDet</a>)
00554        tdc_convert = 1.5625*16.0*58.0/77.0;
00555      <font class="keywordflow">break</font>;
00556    <font class="keywordflow">default</font>: <font class="comment">// handle non-VA, non-QIE by original initialization</font>
00557       <font class="keywordflow">break</font>;
00558    }
00559    Int_t itdc     = TMath::Nint( tdc / tdc_convert );
00560 
00561    <font class="keywordflow">if</font> (itdc &gt; tdcmask ) {
00562       <font class="comment">// this should never happen</font>
00563       <font class="keyword">static</font> <font class="keywordtype">int</font> nmsg_tdc = 5;
00564       <font class="keywordflow">if</font> (nmsg_tdc) {
00565          <a class="code" href="MsgService_8h.html#a1">MSG</a>(<font class="stringliteral">"Exodus"</font>,<a class="code" href="classMsg.html#p4">Msg::kWarning</a>) 
00566             &lt;&lt; <font class="stringliteral">"RerootToRawDataModule::AddToCrate itdc "</font>
00567             &lt;&lt; itdc &lt;&lt; <font class="stringliteral">" does not fit in field (max "</font> 
00568             &lt;&lt; tdcmask &lt;&lt; <font class="stringliteral">")"</font> &lt;&lt; endl;
00569          nmsg_tdc--;
00570          <font class="keywordflow">if</font> (nmsg_tdc==0)
00571             <a class="code" href="MsgService_8h.html#a1">MSG</a>(<font class="stringliteral">"Exodus"</font>,<a class="code" href="classMsg.html#p4">Msg::kWarning</a>) 
00572                &lt;&lt; <font class="stringliteral">" ... last of these messages"</font> &lt;&lt; endl;
00573       }     
00574       itdc = TMath::Max(0,TMath::Min(itdc,tdcmask));
00575    }
00576    itdc &amp;= tdcmask;
00577 
00578    <font class="comment">// if flag is set dump what we're about to do</font>
00579    <font class="keywordflow">if</font> (<a class="code" href="classRerootToRawDataModule.html#o1">fDebugFlags</a> &amp; <a class="code" href="RerootToRawDataModule_8cxx.html#a0">dbg_DumpAddToCrate</a>) {
00580       <a class="code" href="MsgService_8h.html#a1">MSG</a>(<font class="stringliteral">"Exodus"</font>,<a class="code" href="classMsg.html#p3">Msg::kInfo</a>) 
00581          &lt;&lt; <font class="stringliteral">"AddToCrate "</font> &lt;&lt; rcid.<a class="code" href="classRawChannelId.html#a7">AsString</a>() 
00582          &lt;&lt; <font class="stringliteral">" seid "</font> &lt;&lt; seid.<a class="code" href="classPlexStripEndId.html#a6">AsString</a>(<font class="stringliteral">"c"</font>) 
00583          &lt;&lt; <font class="stringliteral">" raw "</font> &lt;&lt; raw &lt;&lt; <font class="stringliteral">" time "</font> &lt;&lt; tdc 
00584          &lt;&lt; endl
00585          &lt;&lt; hex &lt;&lt; setfill(<font class="charliteral">'0'</font>)
00586          &lt;&lt; <font class="stringliteral">" stored as adc 0x"</font> &lt;&lt; setw(8) &lt;&lt; iadc
00587          &lt;&lt; <font class="stringliteral">" tdc 0x"</font> &lt;&lt; setw(8) &lt;&lt; itdc
00588          &lt;&lt; setfill(<font class="charliteral">' '</font>) &lt;&lt; dec
00589          &lt;&lt; endl;
00590    }
00591 
00592 
00593    <font class="comment">// missing parity bits and "hrd"</font>
00594    Int_t upper = signbit | (chadd&lt;&lt;chaddshift) | iadc;
00595    Int_t lower = itdc;
00596    Int_t extra = seid.<a class="code" href="classPlexStripEndId.html#a5">GetEncoded</a>();
00597       
00598    <font class="comment">// push the words in</font>
00599    wcrate-&gt;AddAt(upper,used++);
00600    wcrate-&gt;AddAt(lower,used++);
00601    wcrate-&gt;AddAt(extra,used++);
00602 
00603    <font class="comment">// update pair count</font>
00604    Int_t npairs = (used-hsize)/nw_digit;
00605    wcrate-&gt;AddAt(npairs,ndigits_indx);
00606 
00607    <font class="comment">// update used size</font>
00608    <a class="code" href="classRerootToRawDataModule.html#o6">cratesizeused</a>-&gt;AddAt(used,crate);
00609 
00610 }
00611 
00612 <font class="comment">//......................................................................</font>
00613 
<a name="l00614"></a><a class="code" href="classRerootToRawDataModule.html#c2">00614</a> <a class="code" href="classRawDataBlock.html">RawDataBlock</a>* <a class="code" href="classRerootToRawDataModule.html#c2">RerootToRawDataModule::FinalizeWorkingArray</a>(<font class="keywordtype">void</font>)
00615 {
00616    <font class="comment">// Build final array from crate arrays</font>
00617 
00618    <font class="comment">//  Block format is:</font>
00619    <font class="comment">//---------------------</font>
00620    <font class="comment">//  # words in block</font>
00621    <font class="comment">//  checksum</font>
00622    <font class="comment">//  Block Id</font>
00623    <font class="comment">//  Crate #</font>
00624    <font class="comment">//  GPS T0 sec</font>
00625    <font class="comment">//  GPS T0 nsec</font>
00626    <font class="comment">//  Crate status</font>
00627    <font class="comment">//  # pairs in crate (N)</font>
00628    <font class="comment">//  readout 1 word 1</font>
00629    <font class="comment">//  readout 1 word 2</font>
00630    <font class="comment">//   &lt; truth PlexStripEndId if Reroot data&gt;</font>
00631    <font class="comment">//  readout 2 word 1</font>
00632    <font class="comment">//  readout 2 word 2</font>
00633    <font class="comment">//  ...</font>
00634    <font class="comment">//  readout N word 1</font>
00635    <font class="comment">//  readout N word 2</font>
00636    <font class="comment">//  Crate #</font>
00637    <font class="comment">//  GPS T0 sec</font>
00638    <font class="comment">//  GPS T0 nsec</font>
00639    <font class="comment">//  Crate status</font>
00640    <font class="comment">//  # pairs in crate (N)</font>
00641    <font class="comment">//  readout 1 word 1</font>
00642 
00643    Int_t need = 3;  <font class="comment">// #words, checksum, blockid</font>
00644    <font class="keywordflow">for</font> (Int_t crate=0; crate &lt; <a class="code" href="classRerootToRawDataModule.html#o4">ncrates</a>; crate++) {
00645       need += <a class="code" href="classRerootToRawDataModule.html#o6">cratesizeused</a>-&gt;At(crate);
00646    }
00647 
00648    <font class="comment">// float to highwater mark without copying contents</font>
00649    <font class="keywordflow">if</font> (<a class="code" href="classRerootToRawDataModule.html#o8">workingarray</a>-&gt;GetSize() &lt; need) {
00650       <a class="code" href="classRerootToRawDataModule.html#o8">workingarray</a>-&gt;Set(0);    <font class="comment">// deletes old array</font>
00651       <a class="code" href="classRerootToRawDataModule.html#o8">workingarray</a>-&gt;Set(need); <font class="comment">// set to necessary size</font>
00652    }
00653 
00654    <a class="code" href="classRawBlockRegistry.html">RawBlockRegistry</a>&amp; rbr = <a class="code" href="classRawBlockRegistry.html#d0">RawBlockRegistry::Instance</a>();
00655    <a class="code" href="classRawBlockProxy.html">RawBlockProxy</a>*    rbp = rbr.<a class="code" href="classRawBlockRegistry.html#a3">LookUp</a>(<font class="stringliteral">"RawDigitDataBlock"</font>);
00656 
00657    Bool_t isDCS   = rbp-&gt;<a class="code" href="classRawBlockProxy.html#a3">IsDCS</a>();
00658    Int_t  majorId = rbp-&gt;<a class="code" href="classRawBlockProxy.html#a4">GetMajorId</a>();
00659 
00660    <a class="code" href="classRawBlockProxy.html">RawBlockProxy</a>*    rbp2 = rbr.<a class="code" href="classRawBlockRegistry.html#a3">LookUp</a>(isDCS,majorId);
00661    <font class="keywordflow">if</font> ( rbp2 != rbp ) cout &lt;&lt; <font class="stringliteral">"RawBlockProxy cross check failed"</font> &lt;&lt; endl;
00662 
00663    Int_t  minorId = 0;
00664    <a class="code" href="classRawBlockId.html">RawBlockId</a> rbid(majorId,minorId,isDCS,<a class="code" href="classRerootToRawDataModule.html#o2">detector</a>,<a class="code" href="classSimFlag.html#s6s5">SimFlag::kReroot</a>);
00665    <a class="code" href="MsgService_8h.html#a1">MSG</a>(<font class="stringliteral">"Exodus"</font>, <a class="code" href="classMsg.html#p2">Msg::kDebug</a>)
00666       &lt;&lt; <font class="stringliteral">" to be stored with RawBlockId "</font> 
00667       &lt;&lt; <font class="stringliteral">" 0x"</font> &lt;&lt; hex &lt;&lt; rbid.<a class="code" href="classRawBlockId.html#a4">GetEncoded</a>() &lt;&lt; dec
00668       &lt;&lt; <font class="stringliteral">" == "</font> &lt;&lt; rbid.<a class="code" href="classRawBlockId.html#a5">AsString</a>() &lt;&lt; endl
00669       &lt;&lt; <font class="stringliteral">" majorId "</font> &lt;&lt; majorId &lt;&lt; <font class="stringliteral">" minorId "</font> &lt;&lt; minorId
00670       &lt;&lt; ((isDCS) ? <font class="stringliteral">" DCS "</font> : <font class="stringliteral">" DAQ "</font>)
00671       &lt;&lt; <font class="stringliteral">" "</font> &lt;&lt; <a class="code" href="classDetectorType.html#d1">DetectorType::AsString</a>(<a class="code" href="classRerootToRawDataModule.html#o2">detector</a>) &lt;&lt; endl;
00672 
00673    Int_t checksum = 0xdeadbeef;
00674 
00675    Int_t&amp; indx = <a class="code" href="classRerootToRawDataModule.html#o7">nwordsblock</a>;  <font class="comment">// set "next" index to # words in block</font>
00676    indx = 0;
00677    <a class="code" href="classRerootToRawDataModule.html#o8">workingarray</a>-&gt;AddAt(need,indx++);
00678    <a class="code" href="classRerootToRawDataModule.html#o8">workingarray</a>-&gt;AddAt(checksum,indx++);
00679    <a class="code" href="classRerootToRawDataModule.html#o8">workingarray</a>-&gt;AddAt(rbid.<a class="code" href="classRawBlockId.html#a4">GetEncoded</a>(),indx++);
00680    <font class="keywordflow">for</font> (Int_t crate=0; crate&lt;<a class="code" href="classRerootToRawDataModule.html#o4">ncrates</a>; crate++) {
00681       Int_t csize = <a class="code" href="classRerootToRawDataModule.html#o6">cratesizeused</a>-&gt;At(crate);
00682       TArrayI *wcrate = &amp;<a class="code" href="classRerootToRawDataModule.html#o5">workingcrates</a>[crate];
00683       Int_t   *array  = wcrate-&gt;GetArray();  <font class="comment">// gawd, it's guts are public</font>
00684       <font class="keywordflow">for</font> (Int_t <a class="code" href="TCL_8cxx.html#a11">i</a>=0; <a class="code" href="TCL_8cxx.html#a11">i</a>&lt;csize; <a class="code" href="TCL_8cxx.html#a11">i</a>++) {
00685          <a class="code" href="classRerootToRawDataModule.html#o8">workingarray</a>-&gt;AddAt(array[<a class="code" href="TCL_8cxx.html#a11">i</a>],indx++);
00686       }
00687    }     
00688    
00689    <font class="comment">// fill in the true checksum</font>
00690    <font class="keywordtype">int</font> xsum_version = 0;
00691    <a class="code" href="rdChecksum_8c.html#a1">rdxsum_fill</a>((<font class="keywordtype">long</font>*)<a class="code" href="classRerootToRawDataModule.html#o8">workingarray</a>-&gt;GetArray(),xsum_version);
00692    
00693    <font class="comment">// use the proxy to actually create a block</font>
00694    <font class="keywordflow">return</font> rbp-&gt;<a class="code" href="classRawBlockProxy.html#a5">CreateRawDataBlock</a>(<a class="code" href="classRerootToRawDataModule.html#o8">workingarray</a>-&gt;GetArray());
00695 
00696 }
00697 
00698 <font class="comment">//......................................................................</font>
00699 
<a name="l00700"></a><a class="code" href="classRerootToRawDataModule.html#a4">00700</a> <font class="keywordtype">void</font> <a class="code" href="classRerootToRawDataModule.html#a4">RerootToRawDataModule::HandleCommand</a>(<a class="code" href="classJobCommand.html">JobCommand</a> *command) 
00701 {
00702 <font class="comment">//</font>
00703 <font class="comment">// Process configuration commands</font>
00704 <font class="comment">//</font>
00705   TString cmd = command-&gt;<a class="code" href="classJobCommand.html#a5">PopCmd</a>();
00706   <font class="keywordflow">if</font> (cmd == <font class="stringliteral">"Set"</font>) {
00707      TString opt = command-&gt;<a class="code" href="classJobCommand.html#a6">PopOpt</a>();
00708      <font class="keywordflow">if</font>      (opt == <font class="stringliteral">"fRawPeCut"</font>)   <a class="code" href="classRerootToRawDataModule.html#o3">fRawPeCut</a>   = command-&gt;<a class="code" href="classJobCommand.html#a10">PopFloatOpt</a>();
00709      <font class="keywordflow">else</font> <font class="keywordflow">if</font> (opt ==  <font class="stringliteral">"RawPeCut"</font>)   <a class="code" href="classRerootToRawDataModule.html#o3">fRawPeCut</a>   = command-&gt;<a class="code" href="classJobCommand.html#a10">PopFloatOpt</a>();
00710      <font class="keywordflow">else</font> <font class="keywordflow">if</font> (opt == <font class="stringliteral">"fDebugFlags"</font>) <a class="code" href="classRerootToRawDataModule.html#o1">fDebugFlags</a> = command-&gt;<a class="code" href="classJobCommand.html#a9">PopIntOpt</a>();
00711      <font class="keywordflow">else</font> <font class="keywordflow">if</font> (opt == <font class="stringliteral">"Trigger"</font>) {
00712        <a class="code" href="classRerootToRawDataModule.html#o11">Nplaneshit</a> = command-&gt;<a class="code" href="classJobCommand.html#a9">PopIntOpt</a>();
00713        <a class="code" href="classRerootToRawDataModule.html#o12">ofMplanes</a>  = command-&gt;<a class="code" href="classJobCommand.html#a9">PopIntOpt</a>();
00714        <a class="code" href="MsgService_8h.html#a1">MSG</a>(<font class="stringliteral">"Exodus"</font>, <a class="code" href="classMsg.html#p3">Msg::kInfo</a>)
00715            &lt;&lt; <font class="stringliteral">"RerootToRawDataModule: Trigger is "</font> 
00716            &lt;&lt; <a class="code" href="classRerootToRawDataModule.html#o11">Nplaneshit</a> &lt;&lt; <font class="stringliteral">" of "</font> &lt;&lt; <a class="code" href="classRerootToRawDataModule.html#o12">ofMplanes</a> &lt;&lt; endl;
00717      }
00718      <font class="keywordflow">else</font> {
00719         <a class="code" href="MsgService_8h.html#a1">MSG</a>(<font class="stringliteral">"Exodus"</font>, <a class="code" href="classMsg.html#p4">Msg::kWarning</a>)
00720            &lt;&lt; <font class="stringliteral">"RerootToRawDataModule: Unrecognized option "</font> &lt;&lt; opt &lt;&lt; endl;
00721      }
00722   } <font class="keywordflow">else</font> {
00723      <a class="code" href="MsgService_8h.html#a1">MSG</a>(<font class="stringliteral">"Exodus"</font>, <a class="code" href="classMsg.html#p4">Msg::kWarning</a>)
00724         &lt;&lt; <font class="stringliteral">"RerootToRawDataModule: Unrecognized command "</font> &lt;&lt; cmd &lt;&lt; endl;
00725   }
00726 }
00727 
00728 <font class="comment">//......................................................................</font>
</pre></div><hr><address align="right"><small>Generated on Wed Sep 4 19:01:19 2002 for loon by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.16 </small></address>
</body>
</html>
