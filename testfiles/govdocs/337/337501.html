<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>loon: RerootToRawDataModule.cxx Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.5 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>RerootToRawDataModule.cxx</h1><a href="RerootToRawDataModule_8cxx.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 
00002 <span class="comment">// $Id: RerootToRawDataModule.cxx,v 1.49 2005/08/26 19:07:29 rhatcher Exp $</span>
00003 <span class="comment">//</span>
00004 <span class="comment">// A JobControl Module for filling RawData from REROOT</span>
00005 <span class="comment">//</span>
00006 <span class="comment">// rhatcher@fnal.gov</span>
00008 <span class="comment"></span>
00009 <span class="preprocessor">#include "<a class="code" href="RerootToRawDataModule_8h.html">RerootExodus/RerootToRawDataModule.h</a>"</span>
00010 <span class="preprocessor">#include "<a class="code" href="RerootExodus_8h.html">RerootExodus/RerootExodus.h</a>"</span>
00011 
00012 <span class="preprocessor">#include "<a class="code" href="MomNavigator_8h.html">MinosObjectMap/MomNavigator.h</a>"</span>
00013 
00014 <span class="preprocessor">#include "<a class="code" href="MsgService_8h.html">MessageService/MsgService.h</a>"</span>
00015 <span class="preprocessor">#include "<a class="code" href="JobCModuleRegistry_8h.html">JobControl/JobCModuleRegistry.h</a>"</span>
00016 <span class="preprocessor">#include "<a class="code" href="JobCommand_8h.html">JobControl/JobCommand.h</a>"</span>
00017 
00018 <span class="preprocessor">#include "<a class="code" href="MINFast_8h.html">MINF_Classes/MINFast.h</a>"</span>
00019 <span class="preprocessor">#include "<a class="code" href="REROOT__GeomMisc_8h.html">REROOT_Classes/REROOT_GeomMisc.h</a>"</span>
00020 <span class="preprocessor">#include "<a class="code" href="REROOT__PlanePos_8h.html">REROOT_Classes/REROOT_PlanePos.h</a>"</span>
00021 <span class="preprocessor">#include "<a class="code" href="REROOT__PlaneSpec_8h.html">REROOT_Classes/REROOT_PlaneSpec.h</a>"</span>
00022 <span class="preprocessor">#include "<a class="code" href="REROOT__CellPos_8h.html">REROOT_Classes/REROOT_CellPos.h</a>"</span>
00023 
00024 <span class="preprocessor">#include "<a class="code" href="PlexHandle_8h.html">Plex/PlexHandle.h</a>"</span>
00025 
00026 <span class="preprocessor">#include "<a class="code" href="RawRecord_8h.html">RawData/RawRecord.h</a>"</span>
00027 <span class="preprocessor">#include "<a class="code" href="RawDaqSnarlHeader_8h.html">RawData/RawDaqSnarlHeader.h</a>"</span>
00028 <span class="preprocessor">#include "<a class="code" href="RawDigitDataBlock_8h.html">RawData/RawDigitDataBlock.h</a>"</span>
00029 <span class="preprocessor">#include "<a class="code" href="RawBlockRegistry_8h.html">RawData/RawBlockRegistry.h</a>"</span>
00030 <span class="preprocessor">#include "<a class="code" href="RawBlockId_8h.html">RawData/RawBlockId.h</a>"</span>
00031 <span class="preprocessor">#include "<a class="code" href="RawDigit_8h.html">RawData/RawDigit.h</a>"</span>
00032 <span class="preprocessor">#include "<a class="code" href="RawMCDigitMixIn_8h.html">RawData/RawMCDigitMixIn.h</a>"</span>
00033 
00034 <span class="preprocessor">#include "TMath.h"</span>
00035 
<a name="l00036"></a><a class="code" href="RerootToRawDataModule_8cxx.html#a0">00036</a> <span class="keyword">const</span> UInt_t <a class="code" href="RerootToRawDataModule_8cxx.html#a0">dbg_DumpAddToCrate</a>         = 0x0001;
<a name="l00037"></a><a class="code" href="RerootToRawDataModule_8cxx.html#a1">00037</a> <span class="keyword">const</span> UInt_t <a class="code" href="RerootToRawDataModule_8cxx.html#a1">dbg_DumpNewCrate</a>           = 0x0002;
<a name="l00038"></a><a class="code" href="RerootToRawDataModule_8cxx.html#a2">00038</a> <span class="keyword">const</span> UInt_t <a class="code" href="RerootToRawDataModule_8cxx.html#a2">dbg_PrintRawDigitDataBlock</a> = 0x0004;
<a name="l00039"></a><a class="code" href="RerootToRawDataModule_8cxx.html#a3">00039</a> <span class="keyword">const</span> UInt_t <a class="code" href="RerootToRawDataModule_8cxx.html#a3">dbg_WarnAllMissingRCId</a>     = 0x0008;
00040 
00041 ClassImp(<a class="code" href="classRerootToRawDataModule.html">RerootToRawDataModule</a>)
00042 
00043 
00044 <span class="comment">//......................................................................</span>
00045 
00046 <a class="code" href="MsgService_8h.html#a3">CVSID</a>(<span class="stringliteral">"$Id: RerootToRawDataModule.cxx,v 1.49 2005/08/26 19:07:29 rhatcher Exp $"</span>);
00047 <a class="code" href="JobCModuleRegistry_8h.html#a0">JOBMODULE</a>(<a class="code" href="classRerootToRawDataModule.html">RerootToRawDataModule</a>, <span class="stringliteral">"RerootToRawDataModule"</span>,
00048          <span class="stringliteral">"Builds RawRecord with RawDigitDataBlock"</span>);
00049 
00050 <span class="comment">//......................................................................</span>
00051 
00052 
<a name="l00053"></a><a class="code" href="classRerootToRawDataModule.html#a0">00053</a> <a class="code" href="classRerootToRawDataModule.html#a0">RerootToRawDataModule::RerootToRawDataModule</a>() 
00054    : random(0), fDebugFlags(0), fRawPeCut(0.2999), 
00055    ncrates(0), workingcrates(0), cratesizeused(0),
00056    workingarray(0), display(0),
00057    Nplaneshit(0), ofMplanes(0)
00058 {
00059    <span class="comment">// construct a new "RerootToRawDataModule" JobControl module</span>
00060 
00061    <span class="comment">// we'll use a random # generator to set fake "trigbits"</span>
00062    <span class="comment">// the generator can live as long as the module</span>
00063    <a class="code" href="classRerootToRawDataModule.html#r0">random</a> = <span class="keyword">new</span> TRandom();
00064 
00065    <span class="comment">// initialize detector to non-legal value</span>
00066    <a class="code" href="classRerootToRawDataModule.html#r2">detector</a> = Detector::kUnknown;
00067 
00068    <a class="code" href="classRerootToRawDataModule.html#r4">ncrates</a> = 128;
00069    <a class="code" href="classRerootToRawDataModule.html#r6">cratesizeused</a>  = <span class="keyword">new</span> TArrayI(<a class="code" href="classRerootToRawDataModule.html#r4">ncrates</a>);
00070    <a class="code" href="classRerootToRawDataModule.html#r5">workingcrates</a>  = <span class="keyword">new</span> TArrayI [<a class="code" href="classRerootToRawDataModule.html#r4">ncrates</a>];
00071 
00072    Int_t init_alloc = 5 + 100*3;
00073    <span class="keywordflow">for</span> (Int_t i=0; i&lt;<a class="code" href="classRerootToRawDataModule.html#r4">ncrates</a>; i++) {
00074       <a class="code" href="classRerootToRawDataModule.html#r6">cratesizeused</a>-&gt;AddAt(0,i);
00075       <a class="code" href="classRerootToRawDataModule.html#r5">workingcrates</a>[i].Set(init_alloc);
00076    }
00077 
00078    <a class="code" href="classRerootToRawDataModule.html#r7">nwordsblock</a> = 0;
00079    <a class="code" href="classRerootToRawDataModule.html#r8">workingarray</a> = <span class="keyword">new</span> TArrayI(2);
00080 
00081 
00082 }
00083 
00084 <span class="comment">//......................................................................</span>
00085 
<a name="l00086"></a><a class="code" href="classRerootToRawDataModule.html#a1">00086</a> <a class="code" href="classRerootToRawDataModule.html#a1">RerootToRawDataModule::~RerootToRawDataModule</a>() 
00087 {
00088   <a class="code" href="MsgService_8h.html#a4">MSG</a>(<span class="stringliteral">"Exodus"</span>, Msg::kVerbose) &lt;&lt; <span class="stringliteral">"RerootToRawDataModule::Destructor\n"</span>;
00089 
00090   <span class="keywordflow">if</span> (<a class="code" href="classRerootToRawDataModule.html#r0">random</a>) <span class="keyword">delete</span> <a class="code" href="classRerootToRawDataModule.html#r0">random</a>;
00091   <a class="code" href="classRerootToRawDataModule.html#r0">random</a> = 0;
00092 
00093   <span class="keywordflow">if</span> (<a class="code" href="classRerootToRawDataModule.html#r4">ncrates</a>) {
00094      <span class="keyword">delete</span> [] <a class="code" href="classRerootToRawDataModule.html#r5">workingcrates</a>;
00095      <a class="code" href="classRerootToRawDataModule.html#r5">workingcrates</a> = 0;
00096 
00097      <span class="keyword">delete</span> <a class="code" href="classRerootToRawDataModule.html#r6">cratesizeused</a>;
00098      <a class="code" href="classRerootToRawDataModule.html#r6">cratesizeused</a> = 0;
00099 
00100      <a class="code" href="classRerootToRawDataModule.html#r4">ncrates</a> = 0;
00101   }
00102 
00103   <span class="keywordflow">if</span> (<a class="code" href="classRerootToRawDataModule.html#r8">workingarray</a>) <span class="keyword">delete</span> <a class="code" href="classRerootToRawDataModule.html#r8">workingarray</a>;
00104   <a class="code" href="classRerootToRawDataModule.html#r8">workingarray</a> = 0;
00105 
00106   <span class="keywordflow">if</span> (<a class="code" href="classRerootToRawDataModule.html#r9">display</a>) <span class="keyword">delete</span> <a class="code" href="classRerootToRawDataModule.html#r9">display</a>;
00107   <a class="code" href="classRerootToRawDataModule.html#r9">display</a> = 0;
00108 
00109 }
00110 
00111 <span class="comment">//......................................................................</span>
00112 
<a name="l00113"></a><a class="code" href="classRerootToRawDataModule.html#a2">00113</a> <a class="code" href="classJobCResult.html">JobCResult</a> <a class="code" href="classRerootToRawDataModule.html#a2">RerootToRawDataModule::Get</a>(<a class="code" href="classMomNavigator.html">MomNavigator</a> *mom)
00114 {
00115    <span class="comment">// Create RawRecord from the current REROOT event</span>
00116    <span class="comment">// available via gMINFast.</span>
00117 
00118   <span class="keywordflow">if</span> (!<a class="code" href="MINFast_8cxx.html#a1">gMINFast</a>) {
00119     <span class="keyword">static</span> <span class="keywordtype">int</span> nmsg = 10;
00120     <span class="keywordflow">if</span> (nmsg) {
00121       <a class="code" href="MsgService_8h.html#a4">MSG</a>(<span class="stringliteral">"Exodus"</span>,Msg::kFatal) 
00122         &lt;&lt; <span class="stringliteral">"RerootToRawDataModule lacked gMINFast"</span> &lt;&lt; endl
00123         &lt;&lt; <span class="stringliteral">"   perhaps the input isn't a REROOT file"</span>
00124         &lt;&lt; endl;
00125       nmsg--;
00126       <span class="keywordflow">if</span> (!nmsg) <a class="code" href="MsgService_8h.html#a4">MSG</a>(<span class="stringliteral">"Exodus"</span>,Msg::kFatal) 
00127         &lt;&lt; <span class="stringliteral">" ... last such message"</span> &lt;&lt; endl;
00128     }
00129     <span class="keywordflow">return</span> JobCResult::kError;
00130   }
00131 
00132   <span class="comment">// Prepare to start by getting current REROOT pointers</span>
00133   <span class="comment">// and clearing out the working array</span>
00134   <a class="code" href="classRerootToRawDataModule.html#d0">InitWorkingArray</a>();
00135 
00136   <a class="code" href="classRerootToRawDataModule.html#r10">ndigitsPerPlane</a>.Reset();
00137 
00138   <span class="comment">// For a PlexHandle we need a context</span>
00139   <a class="code" href="classVldContext.html">VldContext</a> vldc = <a class="code" href="classRerootExodus.html#e5">RerootExodus::BuildVldContext</a>();
00140 
00141   <span class="comment">// Get a PlexHandle for PlexStripEndId to RawChannelId conversions</span>
00142   <a class="code" href="classPlexHandle.html">PlexHandle</a> ph(vldc);
00143 
00144   <span class="comment">// Prepare to loop over REROOT digits</span>
00145   <span class="keyword">const</span> TClonesArray *flsdigits   = <a class="code" href="classRerootExodus.html#e45">RerootExodus::GetFLSDigitList</a>();
00146   <a class="code" href="classREROOT__FLSDigit.html">REROOT_FLSDigit</a>    *flsdigit = 0;
00147   TIter diter(flsdigits);
00148 
00149   <a class="code" href="classPlexStripEndId.html">PlexStripEndId</a> seid;
00150   <a class="code" href="classRawChannelId.html">RawChannelId</a>   rcid;
00151   Float_t raw, tdc;
00152   Int_t   isAB;
00153 
00154   <span class="comment">// Keep track of earliest time.</span>
00155   Float_t tearly = 2e9; <span class="comment">// Set to something not crazy, so (int)tearly isn't a fpe.</span>
00156 
00157   <span class="comment">// ADAMO unfilled entries have special values</span>
00158   <span class="comment">// but exact testing doesn't seem to work...</span>
00159   Float_t ADAMO_RNULL =  699050. * (Float_t) (16&lt;&lt;26); <span class="comment">// 699050*16.0**26</span>
00160 
00161   <span class="comment">// loop over all digits</span>
00162   <span class="keywordflow">while</span> ( ( flsdigit = (<a class="code" href="classREROOT__FLSDigit.html">REROOT_FLSDigit</a>*) diter.Next() ) ) {
00163 
00164      <span class="keyword">static</span> <span class="keywordtype">int</span> nmsgIsNull = 20; <span class="comment">// default, limit to 20 messages</span>
00165 
00166      <span class="comment">// process A side</span>
00167      raw  = flsdigit-&gt;<a class="code" href="classREROOT__FLSDigit.html#a13">RawA</a>();
00168      tdc  = flsdigit-&gt;<a class="code" href="classREROOT__FLSDigit.html#a18">TDCA</a>();
00169      isAB = 0;
00170      <span class="keywordflow">if</span> ( raw &gt; 0.0 &amp;&amp; raw &lt; ADAMO_RNULL ) {
00171         seid = <a class="code" href="classRerootExodus.html#e23">RerootExodus::PECAB2SEId</a>(flsdigit-&gt;<a class="code" href="classREROOT__FLSDigit.html#a9">IPln</a>(),flsdigit-&gt;<a class="code" href="classREROOT__FLSDigit.html#a10">IExtr</a>(),
00172                                         flsdigit-&gt;<a class="code" href="classREROOT__FLSDigit.html#a11">ICell</a>(),isAB);
00173         <span class="comment">// make an entry</span>
00174         rcid = ph.<a class="code" href="classPlexHandle.html#a4">GetRawChannelId</a>(seid);
00175         <span class="keywordflow">if</span> (rcid.<a class="code" href="classRawChannelId.html#a35">IsNull</a>()) {
00176            <span class="keywordflow">if</span> (( <a class="code" href="classRerootToRawDataModule.html#r1">fDebugFlags</a> &amp; <a class="code" href="RerootToRawDataModule_8cxx.html#a3">dbg_WarnAllMissingRCId</a>) || nmsgIsNull&gt;0)
00177               <a class="code" href="MsgService_8h.html#a4">MSG</a>(<span class="stringliteral">"Exodus"</span>,Msg::kWarning) 
00178                  &lt;&lt; <span class="stringliteral">"rcid.IsNull() on A side "</span> &lt;&lt; seid.<a class="code" href="classPlexStripEndId.html#a6">AsString</a>() &lt;&lt; endl;
00179            <span class="keywordflow">if</span> (nmsgIsNull==1 &amp; !(<a class="code" href="classRerootToRawDataModule.html#r1">fDebugFlags</a>&amp;<a class="code" href="RerootToRawDataModule_8cxx.html#a3">dbg_WarnAllMissingRCId</a>)) 
00180               <a class="code" href="MsgService_8h.html#a4">MSG</a>(<span class="stringliteral">"Exodus"</span>,Msg::kWarning)
00181                  &lt;&lt; <span class="stringliteral">" ... last IsNull message"</span> &lt;&lt; endl;
00182            nmsgIsNull--;
00183         }
00184         <span class="comment">// add no matter if rcid.IsNull, so we see MC truth</span>
00185         <a class="code" href="classRerootToRawDataModule.html#d1">AddToCrate</a>(seid,rcid,raw,tdc);
00186         <span class="keywordflow">if</span>(tdc &lt; tearly) tearly = tdc;
00187      }
00188 
00189      <span class="comment">// process B side</span>
00190      raw  = flsdigit-&gt;<a class="code" href="classREROOT__FLSDigit.html#a14">RawB</a>();
00191      tdc  = flsdigit-&gt;<a class="code" href="classREROOT__FLSDigit.html#a19">TDCB</a>();
00192      isAB = 1;
00193      <span class="keywordflow">if</span> ( raw &gt; 0.0 &amp;&amp; raw &lt; ADAMO_RNULL ) {
00194         seid = <a class="code" href="classRerootExodus.html#e23">RerootExodus::PECAB2SEId</a>(flsdigit-&gt;<a class="code" href="classREROOT__FLSDigit.html#a9">IPln</a>(),flsdigit-&gt;<a class="code" href="classREROOT__FLSDigit.html#a10">IExtr</a>(),
00195                                         flsdigit-&gt;<a class="code" href="classREROOT__FLSDigit.html#a11">ICell</a>(),isAB);
00196         <span class="comment">// make an entry</span>
00197         rcid = ph.<a class="code" href="classPlexHandle.html#a4">GetRawChannelId</a>(seid);
00198         <span class="keywordflow">if</span> (rcid.<a class="code" href="classRawChannelId.html#a35">IsNull</a>()) {
00199            <span class="keywordflow">if</span> (( <a class="code" href="classRerootToRawDataModule.html#r1">fDebugFlags</a> &amp; <a class="code" href="RerootToRawDataModule_8cxx.html#a3">dbg_WarnAllMissingRCId</a>) || nmsgIsNull&gt;0)
00200               <a class="code" href="MsgService_8h.html#a4">MSG</a>(<span class="stringliteral">"Exodus"</span>,Msg::kWarning) 
00201                  &lt;&lt; <span class="stringliteral">"rcid.IsNull() on B side "</span> &lt;&lt; seid.<a class="code" href="classPlexStripEndId.html#a6">AsString</a>() &lt;&lt; endl;
00202            <span class="keywordflow">if</span> (nmsgIsNull==1 &amp; !(<a class="code" href="classRerootToRawDataModule.html#r1">fDebugFlags</a>&amp;<a class="code" href="RerootToRawDataModule_8cxx.html#a3">dbg_WarnAllMissingRCId</a>)) 
00203               <a class="code" href="MsgService_8h.html#a4">MSG</a>(<span class="stringliteral">"Exodus"</span>,Msg::kWarning)
00204                  &lt;&lt; <span class="stringliteral">" ... last IsNull message"</span> &lt;&lt; endl;
00205            nmsgIsNull--;
00206         }
00207         <span class="comment">// add no matter if rcid.IsNull, so we see MC truth</span>
00208         <a class="code" href="classRerootToRawDataModule.html#d1">AddToCrate</a>(seid,rcid,raw,tdc);
00209         <span class="keywordflow">if</span>(tdc &lt; tearly) tearly = tdc;
00210      }
00211   }
00212 
00213   <span class="comment">// Finalize the working array, produce RawDigitDataBlock</span>
00214   <a class="code" href="classRawDataBlock.html">RawDataBlock</a> *rawblk = <a class="code" href="classRerootToRawDataModule.html#d2">FinalizeWorkingArray</a>();
00215   <a class="code" href="classRawDigitDataBlock.html">RawDigitDataBlock</a> *rrdb = dynamic_cast&lt;RawDigitDataBlock*&gt;(rawblk);
00216 
00217   <span class="keywordflow">if</span> (<a class="code" href="classRerootToRawDataModule.html#r1">fDebugFlags</a> &amp; <a class="code" href="RerootToRawDataModule_8cxx.html#a2">dbg_PrintRawDigitDataBlock</a>) rawblk-&gt;<a class="code" href="classRawDataBlock.html#a11">Print</a>();
00218 
00219   <span class="comment">// produce a RawDaqSnarlHeader (specialized RawHeader)</span>
00220   <span class="comment">// which the RawRecord will adopt</span>
00221 
00222   Int_t   <a class="code" href="do__extrap_8h.html#a34">run</a>      = <a class="code" href="classRerootExodus.html#e10">RerootExodus::GetRunNo</a>();
00223   Int_t   snarl    = <a class="code" href="classRerootExodus.html#e11">RerootExodus::GetEventNo</a>();
00224   Int_t   trigbits = <a class="code" href="classRerootToRawDataModule.html#r0">random</a>-&gt;Integer(0x0fffffff);
00225   Short_t subrun = 0;
00226   Short_t runtype = 0;
00227   Int_t   errcode = 0;
00228   <span class="keyword">static</span> Int_t tf = 0;
00229   Int_t   nrawdigits = (rrdb) ? rrdb-&gt;<a class="code" href="classRawDigitDataBlock.html#a3">GetNumberOfDigits</a>() : -1;
00230   Int_t   spilltype = -1;
00231 
00232   <span class="comment">// Convert tearly to trigger time.</span>
00233   <a class="code" href="classVldTimeStamp.html">VldTimeStamp</a> trigTime(vldc.<a class="code" href="classVldContext.html#a6">GetTimeStamp</a>().<a class="code" href="classVldTimeStamp.html#a11">GetSec</a>(),
00234                         (<span class="keywordtype">int</span>)(tearly));
00235   <span class="comment">// Build a new, slightly different context:</span>
00236   <a class="code" href="classVldContext.html">VldContext</a> trigContext(vldc.<a class="code" href="classVldContext.html#a4">GetDetector</a>(),
00237                          vldc.<a class="code" href="classVldContext.html#a5">GetSimFlag</a>(),
00238                          trigTime);
00239 
00240   <a class="code" href="classRawDaqSnarlHeader.html">RawDaqSnarlHeader</a> *head = 
00241      <span class="keyword">new</span> <a class="code" href="classRawDaqSnarlHeader.html">RawDaqSnarlHeader</a>(trigContext,<a class="code" href="do__extrap_8h.html#a34">run</a>,subrun,runtype,++tf,
00242                            snarl,trigbits,errcode,nrawdigits,spilltype);
00243 
00244   <span class="comment">// produce a RawRecord, have it adopt the header</span>
00245   
00246   <a class="code" href="classRawRecord.html">RawRecord</a> *rawrec = <span class="keyword">new</span> <a class="code" href="classRawRecord.html">RawRecord</a>(head);
00247 
00248   <span class="comment">// give the block to the RawRecord</span>
00249 
00250   rawrec-&gt;<a class="code" href="classRawRecord.html#a7">AdoptRawBlock</a>(rawblk);
00251 
00252   <span class="comment">// tag this RawRecord AS IF it had come from the DaqSnarl stream</span>
00253 
00254   rawrec-&gt;<a class="code" href="classRecMinos.html#a11">GetTempTags</a>().<a class="code" href="classRegistry.html#a37">Set</a>(<span class="stringliteral">"stream"</span>,<span class="stringliteral">"DaqSnarl"</span>);
00255 
00256   <span class="comment">// give the RawRecord to MOM to hold as a "fragment"</span>
00257   
00258   mom-&gt;<a class="code" href="classMomNavigator.html#a2">AdoptFragment</a>(rawrec);
00259 
00260   <span class="comment">// </span>
00261 
00262   <span class="keywordflow">return</span> <a class="code" href="classRerootToRawDataModule.html#d3">ApplyTrigger</a>(); <span class="comment">// result depends on trigger</span>
00263 }
00264 
00265 <span class="comment">//......................................................................</span>
00266 
<a name="l00267"></a><a class="code" href="classRerootToRawDataModule.html#d3">00267</a> <a class="code" href="classJobCResult.html">JobCResult</a> <a class="code" href="classRerootToRawDataModule.html#d3">RerootToRawDataModule::ApplyTrigger</a>()
00268 {
00269   <span class="comment">// Apply the N of M trigger for the Far Eetector</span>
00270   <span class="comment">// Should also work for CalDet</span>
00271   <span class="comment">// Simply punt for Near Detector</span>
00272 
00273   <span class="keywordflow">if</span> (Detector::kNear == <a class="code" href="classRerootToRawDataModule.html#r2">detector</a>) <span class="keywordflow">return</span> JobCResult::kPassed;
00274 
00275   <span class="comment">// if no test then always pass</span>
00276   <span class="keywordflow">if</span> (<a class="code" href="classRerootToRawDataModule.html#r11">Nplaneshit</a>&lt;=0) <span class="keywordflow">return</span> JobCResult::kPassed;
00277 
00278   <span class="comment">// find first &amp; last plane with digits</span>
00279   Int_t first = 0;
00280   Int_t last  = <a class="code" href="classRerootToRawDataModule.html#r10">ndigitsPerPlane</a>.GetSize()-1;
00281   <span class="keywordflow">for</span> ( ; last&gt;first; last-- ) <span class="keywordflow">if</span> (<a class="code" href="classRerootToRawDataModule.html#r10">ndigitsPerPlane</a>[last]&gt;0) <span class="keywordflow">break</span>;
00282   <span class="keywordflow">for</span> ( ; first&lt;last; first++) if (ndigitsPerPlane[first]&gt;0) <span class="keywordflow">break</span>;
00283 
00284   <span class="comment">// if impossibly short then don't bother further, it fails</span>
00285   <span class="keywordflow">if</span> (last-first+1&lt;<a class="code" href="classRerootToRawDataModule.html#r11">Nplaneshit</a>) <span class="keywordflow">return</span> JobCResult::kFailed;  
00286 
00287   Int_t running_total = 0;
00288   Int_t excluded_plns = 0;
00289   <span class="keywordflow">for</span> (Int_t plane = first; plane&lt;=last; plane++) {
00290 
00291     <span class="comment">// check for uninstrumented plane</span>
00292     <a class="code" href="classPlexPlaneId.html">PlexPlaneId</a> pid(<a class="code" href="classRerootToRawDataModule.html#r2">detector</a>,plane);
00293     <span class="keywordflow">if</span> (pid.<a class="code" href="classPlexPlaneId.html#a8">GetPlaneCoverage</a>() == PlaneCoverage::kNoActive) {
00294       excluded_plns++;
00295       <span class="keywordflow">if</span> (<a class="code" href="classRerootToRawDataModule.html#r10">ndigitsPerPlane</a>[plane]&gt;0)
00296         <a class="code" href="MsgService_8h.html#a4">MSG</a>(<span class="stringliteral">"Exodus"</span>,Msg::kWarning)
00297           &lt;&lt; <span class="stringliteral">"saw "</span> &lt;&lt; <a class="code" href="classRerootToRawDataModule.html#r10">ndigitsPerPlane</a>[plane]
00298           &lt;&lt; <span class="stringliteral">" digits in uninstrumented plane "</span>
00299           &lt;&lt; pid &lt;&lt; endl;
00300       <span class="keywordflow">else</span>
00301         <a class="code" href="classRerootToRawDataModule.html#r10">ndigitsPerPlane</a>[plane] = -1; <span class="comment">// mark it as to be excluded</span>
00302     }
00303     
00304     <span class="comment">// if appropriate, add this plane into total</span>
00305     <span class="keywordflow">if</span> (<a class="code" href="classRerootToRawDataModule.html#r10">ndigitsPerPlane</a>[plane]&gt;0) running_total++;
00306 
00307     <span class="comment">// start subtracting</span>
00308     Int_t <a class="code" href="structwindow.html">window</a> = <a class="code" href="classRerootToRawDataModule.html#r12">ofMplanes</a> + excluded_plns;
00309     <span class="keywordflow">if</span> (plane&gt;=window-1 &amp;&amp; plane-window&gt;=0) { <span class="comment">// -1 for zero based indexing</span>
00310       Int_t ngoingout = <a class="code" href="classRerootToRawDataModule.html#r10">ndigitsPerPlane</a>[plane-window];
00311       <span class="keywordflow">if</span>      (ngoingout &lt; 0) excluded_plns--;
00312       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ngoingout &gt; 0) running_total--;
00313     }
00314 
00315     <span class="comment">// test if valid</span>
00316     <span class="keywordflow">if</span> ( running_total &gt;= <a class="code" href="classRerootToRawDataModule.html#r11">Nplaneshit</a> ) <span class="keywordflow">return</span> JobCResult::kPassed;
00317 
00318   }
00319   <span class="comment">// fell through without passing?  failed!</span>
00320   <span class="keywordflow">return</span> JobCResult::kFailed;
00321 }
00322 
00323 <span class="comment">//......................................................................</span>
00324 
<a name="l00325"></a><a class="code" href="classRerootToRawDataModule.html#a3">00325</a> <a class="code" href="classJobCResult.html">JobCResult</a> <a class="code" href="classRerootToRawDataModule.html#a3">RerootToRawDataModule::Reco</a>(<a class="code" href="classMomNavigator.html">MomNavigator</a> *mom)
00326 {
00327   <span class="comment">// A test job for "reconstruction"</span>
00328   <span class="comment">// This example code unpacks the RawDataBlocks in the RawRecord</span>
00329   <span class="comment">// and displays them on a CheezyDisplay using the Plex</span>
00330   <span class="comment">// to convert from RawRecordId into PlexStripEndId's</span>
00331   
00332   <span class="comment">//  MSG("Exodus", Msg::kVerbose) &lt;&lt; "RerootToRawDataModule::Reco\n";</span>
00333 
00334   TObject   *obj;
00335 
00336   <span class="comment">// Get the RawRecord from Mom</span>
00337   <a class="code" href="classRawRecord.html">RawRecord</a> *rawrec = dynamic_cast&lt;RawRecord *&gt;
00338                                         (mom-&gt;<a class="code" href="classMomNavigator.html#a3">GetFragment</a>(<span class="stringliteral">"RawRecord"</span>));
00339   <span class="keywordflow">if</span> ( ! rawrec ) {
00340      <a class="code" href="MsgService_8h.html#a4">MSG</a>(<span class="stringliteral">"Exodus"</span>,Msg::kFatal) &lt;&lt; <span class="stringliteral">"RerootToRawDataModule::Reco"</span> &lt;&lt;
00341         <span class="stringliteral">" failed to fin a \"RawRecord\""</span> &lt;&lt; endl;
00342      <span class="keywordflow">return</span> JobCResult::kError;
00343   }
00344   
00345   <span class="comment">// For a PlexHandle we need a context</span>
00346   <a class="code" href="classVldContext.html">VldContext</a> vldc = rawrec-&gt;<a class="code" href="classRawRecord.html#a3">GetRawHeader</a>()-&gt;<a class="code" href="classRecMinosHdr.html#a3">GetVldContext</a>();
00347 
00348   <span class="comment">// Get a PlexHandle for PlexStripEndId to RawChannelId conversions</span>
00349   <a class="code" href="classPlexHandle.html">PlexHandle</a> ph(vldc);
00350 
00351   <span class="comment">// Create (if necessary) a display</span>
00352   <span class="keywordflow">if</span> ( ! <a class="code" href="classRerootToRawDataModule.html#r9">display</a> ) <a class="code" href="classRerootToRawDataModule.html#r9">display</a> = 
00353                       <span class="keyword">new</span> <a class="code" href="classCheezyDisplay.html">CheezyDisplay</a>(<span class="stringliteral">"RerootToRawDataModule"</span>,
00354                                         <span class="stringliteral">"RerootToRawDataModule display"</span>);
00355   <a class="code" href="classRerootToRawDataModule.html#r9">display</a>-&gt;<a class="code" href="classCheezyDisplay.html#a4">ClearLists</a>();
00356   <a class="code" href="classRerootToRawDataModule.html#r9">display</a>-&gt;<a class="code" href="classCheezyDisplay.html#a3">SetVldContext</a>(vldc);
00357 
00358 
00359   <span class="comment">// from the RawRecord loop over the RawDataBlocks</span>
00360   <a class="code" href="classRawDigitDataBlock.html">RawDigitDataBlock</a>     *digitblk  = 0;
00361   TIter blkiter = rawrec-&gt;<a class="code" href="classRawRecord.html#a6">GetRawBlockIter</a>();
00362   <span class="keywordflow">while</span> ( ( obj = blkiter.Next() ) ) {
00363      digitblk  = dynamic_cast&lt;RawDigitDataBlock*&gt;(obj);
00364      <span class="keywordflow">if</span> (digitblk) {
00365 
00366         <span class="comment">// Loop over the digits make counts</span>
00367         <a class="code" href="classRawDigit.html">RawDigit</a>       *<a class="code" href="CheckGC_8cxx.html#a1">digit</a> = 0;
00368         TIter diter = digitblk-&gt;<a class="code" href="classRawDigitDataBlock.html#a13">GetDatumIter</a>();
00369 
00370         <span class="keywordflow">while</span> ( ( <a class="code" href="CheckGC_8cxx.html#a1">digit</a> = (<a class="code" href="classRawDigit.html">RawDigit</a>*) diter.Next() ) ) {
00371            
00372            <span class="comment">// if it came from a Raw{Qie,Va}MCDigit then there</span>
00373            <span class="comment">// is Truth(TM) info available</span>
00374            <span class="comment">// cast the digit correctly and retrieve it</span>
00375            <a class="code" href="classRawMCDigitMixIn.html">RawMCDigitMixIn</a> *truthDigit = dynamic_cast&lt;RawMCDigitMixIn*&gt;(<a class="code" href="CheckGC_8cxx.html#a1">digit</a>);
00376            <span class="keywordflow">if</span> (truthDigit) {
00377               <a class="code" href="classPlexStripEndId.html">PlexStripEndId</a> seid(truthDigit-&gt;<a class="code" href="classRawMCDigitMixIn.html#a3">GetTrueSEIdEncoded</a>());
00378               <a class="code" href="classRerootToRawDataModule.html#r9">display</a>-&gt;<a class="code" href="classCheezyDisplay.html#a5">AddStripEndId</a>(seid,kTRUE);
00379            }           
00380 
00381            <span class="comment">// ALT LIST</span>
00382            <a class="code" href="classRawChannelId.html">RawChannelId</a> rcid = <a class="code" href="CheckGC_8cxx.html#a1">digit</a>-&gt;GetChannel();
00383            <a class="code" href="classPlexSEIdAltL.html">PlexSEIdAltL</a> altlist = ph.<a class="code" href="classPlexHandle.html#a7">GetSEIdAltL</a>(rcid);
00384            altlist.<a class="code" href="classPlexSEIdAltL.html#a28">SetFirst</a>();
00385            <span class="keywordflow">while</span> ( altlist.<a class="code" href="classPlexSEIdAltL.html#a25">IsValid</a>() ) {
00386               <a class="code" href="classPlexStripEndId.html">PlexStripEndId</a> seid = altlist.<a class="code" href="classPlexSEIdAltL.html#a14">GetCurrentSEId</a>();
00387               <a class="code" href="classRerootToRawDataModule.html#r9">display</a>-&gt;<a class="code" href="classCheezyDisplay.html#a5">AddStripEndId</a>(seid,kFALSE);
00388               altlist.<a class="code" href="classPlexSEIdAltL.html#a26">Next</a>();
00389            }
00390         }
00391 
00392      }
00393   }
00394      
00395   <span class="comment">// Now actually draw these things</span>
00396   <a class="code" href="classRerootToRawDataModule.html#r9">display</a>-&gt;<a class="code" href="classCheezyDisplay.html#a7">Draw</a>();
00397 
00398   <span class="keywordflow">return</span> JobCResult::kAOK;
00399 
00400 }
00401 
00402 <span class="comment">//......................................................................</span>
00403 
<a name="l00404"></a><a class="code" href="classRerootToRawDataModule.html#d0">00404</a> <span class="keywordtype">void</span> <a class="code" href="classRerootToRawDataModule.html#d0">RerootToRawDataModule::InitWorkingArray</a>(<span class="keywordtype">void</span>)
00405 {
00406    <span class="comment">// Initialize for new "Get"</span>
00407 
00408    <span class="comment">// zero out used sizes ...</span>
00409    <span class="keywordflow">for</span> (Int_t i=0; i&lt;<a class="code" href="classRerootToRawDataModule.html#r4">ncrates</a>; i++) {
00410       <a class="code" href="classRerootToRawDataModule.html#r6">cratesizeused</a>-&gt;AddAt(0,i);
00411    }
00412    <a class="code" href="classRerootToRawDataModule.html#r7">nwordsblock</a> = 0;
00413 
00414    <a class="code" href="classRerootToRawDataModule.html#r2">detector</a> = <a class="code" href="classRerootExodus.html#e0">RerootExodus::GetDetector</a>();
00415 }
00416 
00417 <span class="comment">//......................................................................</span>
00418 
<a name="l00419"></a><a class="code" href="classRerootToRawDataModule.html#d1">00419</a> <span class="keywordtype">void</span> <a class="code" href="classRerootToRawDataModule.html#d1">RerootToRawDataModule::AddToCrate</a>(<span class="keyword">const</span> <a class="code" href="classPlexStripEndId.html">PlexStripEndId</a>&amp; seid,
00420                                        <span class="keyword">const</span> <a class="code" href="classRawChannelId.html">RawChannelId</a>&amp;   rcid,
00421                                        Float_t raw, Float_t tdc)
00422 {
00423    <span class="comment">// Add this entry into the crate array</span>
00424 
00425    <span class="comment">// apply the cut if necessary</span>
00426    <span class="keywordflow">if</span> (raw &lt; <a class="code" href="classRerootToRawDataModule.html#r3">fRawPeCut</a> ) {
00427       <span class="keyword">static</span> Float_t last_cut_msg = -1;
00428       <span class="keywordflow">if</span> (last_cut_msg != <a class="code" href="classRerootToRawDataModule.html#r3">fRawPeCut</a>) {
00429          <span class="comment">// one warning for any given cut level</span>
00430          last_cut_msg = <a class="code" href="classRerootToRawDataModule.html#r3">fRawPeCut</a>;
00431          <a class="code" href="MsgService_8h.html#a4">MSG</a>(<span class="stringliteral">"Exodus"</span>,Msg::kInfo)
00432             &lt;&lt; <span class="stringliteral">"::AddToCrate cutting all raw values &lt; "</span>
00433             &lt;&lt; fRawPeCut &lt;&lt; endl;
00434       }
00435       <span class="keywordflow">return</span>;
00436    }
00437 
00438    <span class="comment">// keep track of # of digits in each plane (above threshold)</span>
00439    Int_t plane = seid.<a class="code" href="classPlexPlaneId.html#a7">GetPlane</a>();
00440    <span class="keywordflow">if</span> (<a class="code" href="classRerootToRawDataModule.html#r10">ndigitsPerPlane</a>.GetSize()&lt;plane+1) <a class="code" href="classRerootToRawDataModule.html#r10">ndigitsPerPlane</a>.Set(plane+1);
00441    <a class="code" href="classRerootToRawDataModule.html#r10">ndigitsPerPlane</a>[plane]++;
00442 
00443    Int_t crate = rcid.<a class="code" href="classRawChannelId.html#a14">GetCrate</a>();
00444    <span class="keywordflow">if</span> (crate&gt;=<a class="code" href="classRerootToRawDataModule.html#r4">ncrates</a>) {
00445       <a class="code" href="MsgService_8h.html#a4">MSG</a>(<span class="stringliteral">"Exodus"</span>,Msg::kFatal) 
00446          &lt;&lt; <span class="stringliteral">"RerootToRawDataModule::AddToCrate "</span>
00447          &lt;&lt; crate &lt;&lt; <span class="stringliteral">" larger than allocated "</span> &lt;&lt; <a class="code" href="classRerootToRawDataModule.html#r4">ncrates</a> &lt;&lt; endl;
00448       <span class="keywordflow">return</span>;
00449    }
00450 
00451    TArrayI *wcrate = &amp;<a class="code" href="classRerootToRawDataModule.html#r5">workingcrates</a>[crate];
00452 
00453    <span class="comment">//  Crate block format is:</span>
00454    <span class="comment">//-------------------------</span>
00455    <span class="comment">//   0: Crate #</span>
00456    <span class="comment">//   1: # ndigits in crate (N)</span>
00457    <span class="comment">//   2: GPS T0 sec</span>
00458    <span class="comment">//   3: GPS T0 nsec</span>
00459    <span class="comment">//   4: readout 1 word 1</span>
00460    <span class="comment">//   5: readout 1 word 2</span>
00461    <span class="comment">//   6: PlexStripEndId.fEncoded truth</span>
00462    <span class="comment">//   7: readout 2 word 1</span>
00463    <span class="comment">//   8: readout 2 word 2</span>
00464    <span class="comment">//   9: PlexStripEndId.fEncoded truth</span>
00465 
00466    <span class="keyword">const</span> Int_t hsize        = 4; <span class="comment">// header size</span>
00467    <span class="keyword">const</span> Int_t ndigits_indx = 1; <span class="comment">// index for pair count</span>
00468    <span class="keyword">const</span> Int_t nw_digit     = 3; <span class="comment">// 3 words per digit</span>
00469 
00470    <span class="comment">// if allocated size is too small make it bigger</span>
00471    Int_t used = <a class="code" href="classRerootToRawDataModule.html#r6">cratesizeused</a>-&gt;At(crate);
00472    Int_t need = used + nw_digit;  <span class="comment">// each new entry adds three words</span>
00473    <span class="keywordflow">if</span> (0 == used) need += hsize;
00474 
00475    <span class="keyword">const</span> Int_t slop = 100; <span class="comment">// min extra allocation</span>
00476 
00477    <span class="keywordflow">if</span> (wcrate-&gt;GetSize() &lt; need) {
00478       wcrate-&gt;Set(need+slop);
00479    }
00480 
00481    <span class="comment">// add in header stuff if necessary</span>
00482    <span class="keywordflow">if</span> (0 == used) {
00483       <span class="comment">// crate # + ped/common modes + electronics flag</span>
00484       <span class="keyword">const</span> Int_t modes = 0x07;
00485       Int_t etype = rcid.<a class="code" href="classRawChannelId.html#a10">GetElecType</a>();
00486       Int_t packedCrate = (modes &lt;&lt; 8) |
00487          (etype &lt;&lt; 6) | (crate &amp; 0x0000003f);
00488       wcrate-&gt;AddAt(packedCrate,used++);
00489       <span class="comment">// # digits</span>
00490       <span class="keywordflow">if</span> (used != ndigits_indx) {
00491          <span class="comment">// this should never happen</span>
00492          <a class="code" href="MsgService_8h.html#a4">MSG</a>(<span class="stringliteral">"Exodus"</span>,Msg::kFatal) 
00493             &lt;&lt; <span class="stringliteral">"RerootToRawDataModule::AddToCrate ndigits_indx "</span>
00494             &lt;&lt; ndigits_indx &lt;&lt; <span class="stringliteral">" != "</span> &lt;&lt; used &lt;&lt; endl;
00495       }
00496       wcrate-&gt;AddAt(0,used++);
00497       <span class="comment">// GPS T0 (sec,nsec)</span>
00498       <a class="code" href="classVldTimeStamp.html">VldTimeStamp</a> vts = <a class="code" href="classRerootExodus.html#e5">RerootExodus::BuildVldContext</a>().<a class="code" href="classVldContext.html#a6">GetTimeStamp</a>();
00499       wcrate-&gt;AddAt(vts.<a class="code" href="classVldTimeStamp.html#a11">GetSec</a>(),used++);
00500       <span class="comment">// NT 08/03 The crate T0 measures the time time of the start of the timeframe,</span>
00501       <span class="comment">// NOT the time of the event.</span>
00502       <span class="comment">//wcrate-&gt;AddAt(vts.GetNanoSec(),used++);</span>
00503       wcrate-&gt;AddAt(0,used++);
00504 
00505       <span class="comment">// if flag is set dump what we just did</span>
00506       <span class="keywordflow">if</span> (<a class="code" href="classRerootToRawDataModule.html#r1">fDebugFlags</a> &amp; <a class="code" href="RerootToRawDataModule_8cxx.html#a1">dbg_DumpNewCrate</a>) {
00507          printf(<span class="stringliteral">"new header for crate %3d %#8.8x\n"</span>,crate,packedCrate);
00508       }
00509    }
00510 
00511    <span class="comment">//       3         2         1         0</span>
00512    <span class="comment">//      10987654321098765432109876543210</span>
00513    <span class="comment">//  U:  1PXcccccccccccchhaaaaaaaaaaaaaa   X=common mode,c=chan, h=hdr a=adc</span>
00514    <span class="comment">//  L:  0Pttttttttttttttttttttttttttttt   P=parity, t=tdc</span>
00515    <span class="comment">//  X:  PlexStripEndId::fEncoded</span>
00516 
00517    <span class="keyword">const</span> <span class="keywordtype">int</span> signbit    = 0x80000000;
00518 <span class="comment">//rwh:not_used_yet   const int hdrmask    = 0x0000c000;</span>
00519 <span class="comment">//rwh:not_used_yet   const int parityb    = 0x40000000;</span>
00520 <span class="comment">//rwh:not_used_yet   const int cmodeb     = 0x20000000;</span>
00521    <span class="keyword">const</span> <span class="keywordtype">int</span> chaddmask  = 0x1fff;
00522    <span class="keyword">const</span> <span class="keywordtype">int</span> chaddshift = 16;
00523    <span class="keyword">const</span> <span class="keywordtype">int</span> adcmask    = 0x00003fff;
00524    <span class="keyword">const</span> <span class="keywordtype">int</span> tdcmask    = 0x3fffffff;
00525 
00526    <span class="comment">// ADC = FLSDigit.RawA|B *  60  :  max RawX = (2^17-1)/60  = 2184.5pe</span>
00527    <span class="comment">// TDC = FLSDigit.TdcA|B *  10  :  max TdcX = (2^28-1)/10  = 26.8msec</span>
00528 
00529    <span class="comment">// create the three words we'll be putting in</span>
00530 <span class="comment">//rwh:not_used_yet   Int_t err     = 0;</span>
00531    Int_t chadd   = rcid.<a class="code" href="classRawChannelId.html#a15">GetChAdd</a>();
00532    <span class="keywordflow">if</span> (chadd &gt; chaddmask) {
00533       <span class="comment">// this should never happen</span>
00534       <span class="keyword">static</span> <span class="keywordtype">int</span> nmsg_chadd = 5;
00535       <span class="keywordflow">if</span> (nmsg_chadd) {
00536          <a class="code" href="MsgService_8h.html#a4">MSG</a>(<span class="stringliteral">"Exodus"</span>,Msg::kFatal) 
00537             &lt;&lt; <span class="stringliteral">"RerootToRawDataModule::AddToCrate chadd "</span>
00538             &lt;&lt; hex &lt;&lt; chadd &lt;&lt; dec &lt;&lt; <span class="stringliteral">" truncated from "</span> 
00539             &lt;&lt; hex &lt;&lt; rcid.<a class="code" href="classRawChannelId.html#a15">GetChAdd</a>() &lt;&lt; dec &lt;&lt; endl;
00540          nmsg_chadd--;
00541          <span class="keywordflow">if</span> (nmsg_chadd==0) 
00542             <a class="code" href="MsgService_8h.html#a4">MSG</a>(<span class="stringliteral">"Exodus"</span>,Msg::kFatal) 
00543                &lt;&lt; <span class="stringliteral">" ... last of these messages"</span> &lt;&lt; endl;
00544       }
00545    }
00546    chadd &amp;= chaddmask;
00547 
00548    Int_t iadc     = TMath::Nint( raw * 60.0 );
00549    <span class="keywordflow">if</span>(rcid.<a class="code" href="classRawChannelId.html#a10">GetElecType</a>()==ElecType::kQIE) iadc+=50; <span class="comment">// Add 50 count pedestal to ND data.</span>
00550    <span class="keywordflow">if</span> (iadc &gt; adcmask ) {
00551       <span class="comment">// this should never happen</span>
00552       <span class="keyword">static</span> <span class="keywordtype">int</span> nmsg_adc = 5;
00553       <span class="keywordflow">if</span> (nmsg_adc) {
00554          <a class="code" href="MsgService_8h.html#a4">MSG</a>(<span class="stringliteral">"Exodus"</span>,Msg::kWarning) 
00555             &lt;&lt; <span class="stringliteral">"RerootToRawDataModule::AddToCrate iadc "</span>
00556             &lt;&lt; iadc &lt;&lt; <span class="stringliteral">" does not fit in field  (max "</span> 
00557             &lt;&lt; adcmask &lt;&lt; <span class="stringliteral">")"</span> &lt;&lt; endl;
00558          nmsg_adc--;
00559          <span class="keywordflow">if</span> (nmsg_adc==0)
00560             <a class="code" href="MsgService_8h.html#a4">MSG</a>(<span class="stringliteral">"Exodus"</span>,Msg::kWarning) 
00561                &lt;&lt; <span class="stringliteral">" ... last of these messages"</span> &lt;&lt; endl;
00562       }     
00563       iadc = TMath::Max(0,TMath::Min(iadc,adcmask));
00564    }
00565    iadc &amp;= adcmask;
00566 
00567 <span class="comment">// Convert from 0.1*Munits:ns to standard Munits base time units (sec).</span>
00568    Float_t tdc_convert = 0.1; <span class="comment">// REROOT, non-VA, non-QIE scale factor</span>
00569    <span class="keywordflow">switch</span> (rcid.<a class="code" href="classRawChannelId.html#a10">GetElecType</a>()) {
00570    <span class="keywordflow">case</span> (ElecType::kVA):  
00571      <span class="comment">// VA electronics, tick = 1.5625 ns (640MHz)</span>
00572      tdc_convert = 1.5625;
00573      <span class="keywordflow">break</span>;
00574    <span class="keywordflow">case</span> (ElecType::kQIE):
00575      <span class="comment">// QIE electronics, tick = 18.832 ns (RF clock)</span>
00576      tdc_convert =  1000./53.1;  <span class="comment">// clock is 53.1MHz</span>
00577      <span class="comment">// CalDet has yet a different clock frequency</span>
00578      <span class="keywordflow">if</span> (rcid.<a class="code" href="classRawChannelId.html#a9">GetDetector</a>() == Detector::kCalDet)
00579        tdc_convert = 1.5625*16.0*58.0/77.0;
00580      <span class="keywordflow">break</span>;
00581    <span class="keywordflow">default</span>: <span class="comment">// handle non-VA, non-QIE by original initialization</span>
00582       <span class="keywordflow">break</span>;
00583    }
00584    Int_t itdc     = TMath::Nint( tdc / tdc_convert );
00585 
00586    <span class="keywordflow">if</span> (itdc &gt; tdcmask ) {
00587       <span class="comment">// this should never happen</span>
00588       <span class="keyword">static</span> <span class="keywordtype">int</span> nmsg_tdc = 5;
00589       <span class="keywordflow">if</span> (nmsg_tdc) {
00590          <a class="code" href="MsgService_8h.html#a4">MSG</a>(<span class="stringliteral">"Exodus"</span>,Msg::kWarning) 
00591             &lt;&lt; <span class="stringliteral">"RerootToRawDataModule::AddToCrate itdc "</span>
00592             &lt;&lt; itdc &lt;&lt; <span class="stringliteral">" does not fit in field (max "</span> 
00593             &lt;&lt; tdcmask &lt;&lt; <span class="stringliteral">")"</span> &lt;&lt; endl;
00594          nmsg_tdc--;
00595          <span class="keywordflow">if</span> (nmsg_tdc==0)
00596             <a class="code" href="MsgService_8h.html#a4">MSG</a>(<span class="stringliteral">"Exodus"</span>,Msg::kWarning) 
00597                &lt;&lt; <span class="stringliteral">" ... last of these messages"</span> &lt;&lt; endl;
00598       }     
00599       itdc = TMath::Max(0,TMath::Min(itdc,tdcmask));
00600    }
00601    itdc &amp;= tdcmask;
00602 
00603    <span class="comment">// if flag is set dump what we're about to do</span>
00604    <span class="keywordflow">if</span> (<a class="code" href="classRerootToRawDataModule.html#r1">fDebugFlags</a> &amp; <a class="code" href="RerootToRawDataModule_8cxx.html#a0">dbg_DumpAddToCrate</a>) {
00605       <a class="code" href="MsgService_8h.html#a4">MSG</a>(<span class="stringliteral">"Exodus"</span>,Msg::kInfo) 
00606          &lt;&lt; <span class="stringliteral">"AddToCrate "</span> &lt;&lt; rcid.<a class="code" href="classRawChannelId.html#a8">AsString</a>() 
00607          &lt;&lt; <span class="stringliteral">" seid "</span> &lt;&lt; seid.<a class="code" href="classPlexStripEndId.html#a6">AsString</a>(<span class="stringliteral">"c"</span>) 
00608          &lt;&lt; <span class="stringliteral">" raw "</span> &lt;&lt; raw &lt;&lt; <span class="stringliteral">" time "</span> &lt;&lt; tdc 
00609          &lt;&lt; endl
00610          &lt;&lt; hex &lt;&lt; setfill(<span class="charliteral">'0'</span>)
00611          &lt;&lt; <span class="stringliteral">" stored as adc 0x"</span> &lt;&lt; setw(8) &lt;&lt; iadc
00612          &lt;&lt; <span class="stringliteral">" tdc 0x"</span> &lt;&lt; setw(8) &lt;&lt; itdc
00613          &lt;&lt; setfill(<span class="charliteral">' '</span>) &lt;&lt; dec
00614          &lt;&lt; endl;
00615    }
00616 
00617 
00618    <span class="comment">// missing parity bits and "hrd"</span>
00619    Int_t upper = signbit | (chadd&lt;&lt;chaddshift) | iadc;
00620    Int_t lower = itdc;
00621    Int_t extra = seid.<a class="code" href="classPlexStripEndId.html#a5">GetEncoded</a>();
00622       
00623    <span class="comment">// push the words in</span>
00624    wcrate-&gt;AddAt(upper,used++);
00625    wcrate-&gt;AddAt(lower,used++);
00626    wcrate-&gt;AddAt(extra,used++);
00627 
00628    <span class="comment">// update pair count</span>
00629    Int_t npairs = (used-hsize)/nw_digit;
00630    wcrate-&gt;AddAt(npairs,ndigits_indx);
00631 
00632    <span class="comment">// update used size</span>
00633    <a class="code" href="classRerootToRawDataModule.html#r6">cratesizeused</a>-&gt;AddAt(used,crate);
00634 
00635 }
00636 
00637 <span class="comment">//......................................................................</span>
00638 
<a name="l00639"></a><a class="code" href="classRerootToRawDataModule.html#d2">00639</a> <a class="code" href="classRawDataBlock.html">RawDataBlock</a>* <a class="code" href="classRerootToRawDataModule.html#d2">RerootToRawDataModule::FinalizeWorkingArray</a>(<span class="keywordtype">void</span>)
00640 {
00641    <span class="comment">// Build final array from crate arrays</span>
00642 
00643    <span class="comment">//  Block format is:</span>
00644    <span class="comment">//---------------------</span>
00645    <span class="comment">//  # words in block</span>
00646    <span class="comment">//  checksum</span>
00647    <span class="comment">//  Block Id</span>
00648    <span class="comment">//  Crate #</span>
00649    <span class="comment">//  GPS T0 sec</span>
00650    <span class="comment">//  GPS T0 nsec</span>
00651    <span class="comment">//  Crate status</span>
00652    <span class="comment">//  # pairs in crate (N)</span>
00653    <span class="comment">//  readout 1 word 1</span>
00654    <span class="comment">//  readout 1 word 2</span>
00655    <span class="comment">//   &lt; truth PlexStripEndId if Reroot data&gt;</span>
00656    <span class="comment">//  readout 2 word 1</span>
00657    <span class="comment">//  readout 2 word 2</span>
00658    <span class="comment">//  ...</span>
00659    <span class="comment">//  readout N word 1</span>
00660    <span class="comment">//  readout N word 2</span>
00661    <span class="comment">//  Crate #</span>
00662    <span class="comment">//  GPS T0 sec</span>
00663    <span class="comment">//  GPS T0 nsec</span>
00664    <span class="comment">//  Crate status</span>
00665    <span class="comment">//  # pairs in crate (N)</span>
00666    <span class="comment">//  readout 1 word 1</span>
00667 
00668    Int_t need = 3;  <span class="comment">// #words, checksum, blockid</span>
00669    <span class="keywordflow">for</span> (Int_t crate=0; crate &lt; <a class="code" href="classRerootToRawDataModule.html#r4">ncrates</a>; crate++) {
00670       need += <a class="code" href="classRerootToRawDataModule.html#r6">cratesizeused</a>-&gt;At(crate);
00671    }
00672 
00673    <span class="comment">// float to highwater mark without copying contents</span>
00674    <span class="keywordflow">if</span> (<a class="code" href="classRerootToRawDataModule.html#r8">workingarray</a>-&gt;GetSize() &lt; need) {
00675       <a class="code" href="classRerootToRawDataModule.html#r8">workingarray</a>-&gt;Set(0);    <span class="comment">// deletes old array</span>
00676       <a class="code" href="classRerootToRawDataModule.html#r8">workingarray</a>-&gt;Set(need); <span class="comment">// set to necessary size</span>
00677    }
00678 
00679    <a class="code" href="classRawBlockRegistry.html">RawBlockRegistry</a>&amp; rbr = <a class="code" href="classRawBlockRegistry.html#e0">RawBlockRegistry::Instance</a>();
00680    <a class="code" href="classRawBlockProxy.html">RawBlockProxy</a>*    rbp = rbr.<a class="code" href="classRawBlockRegistry.html#a2">LookUp</a>(<span class="stringliteral">"RawDigitDataBlock"</span>);
00681 
00682    Bool_t isDCS   = rbp-&gt;<a class="code" href="classRawBlockProxy.html#a3">IsDCS</a>();
00683    Int_t  majorId = rbp-&gt;<a class="code" href="classRawBlockProxy.html#a4">GetMajorId</a>();
00684 
00685    <a class="code" href="classRawBlockProxy.html">RawBlockProxy</a>*    rbp2 = rbr.<a class="code" href="classRawBlockRegistry.html#a2">LookUp</a>(isDCS,majorId);
00686    <span class="keywordflow">if</span> ( rbp2 != rbp ) cout &lt;&lt; <span class="stringliteral">"RawBlockProxy cross check failed"</span> &lt;&lt; endl;
00687 
00688    Int_t  minorId = 0;
00689    <a class="code" href="classRawBlockId.html">RawBlockId</a> rbid(majorId,minorId,isDCS,<a class="code" href="classRerootToRawDataModule.html#r2">detector</a>,SimFlag::kReroot);
00690    <a class="code" href="MsgService_8h.html#a4">MSG</a>(<span class="stringliteral">"Exodus"</span>, Msg::kDebug)
00691       &lt;&lt; <span class="stringliteral">" to be stored with RawBlockId "</span> 
00692       &lt;&lt; <span class="stringliteral">" 0x"</span> &lt;&lt; hex &lt;&lt; rbid.<a class="code" href="classRawBlockId.html#a4">GetEncoded</a>() &lt;&lt; dec
00693       &lt;&lt; <span class="stringliteral">" == "</span> &lt;&lt; rbid.<a class="code" href="classRawBlockId.html#a5">AsString</a>() &lt;&lt; endl
00694       &lt;&lt; <span class="stringliteral">" majorId "</span> &lt;&lt; majorId &lt;&lt; <span class="stringliteral">" minorId "</span> &lt;&lt; minorId
00695       &lt;&lt; ((isDCS) ? <span class="stringliteral">" DCS "</span> : <span class="stringliteral">" DAQ "</span>)
00696       &lt;&lt; <span class="stringliteral">" "</span> &lt;&lt; <a class="code" href="namespaceDetector.html#a1">Detector::AsString</a>(<a class="code" href="classRerootToRawDataModule.html#r2">detector</a>) &lt;&lt; endl;
00697 
00698    Int_t checksum = 0xdeadbeef;
00699 
00700    Int_t&amp; indx = <a class="code" href="classRerootToRawDataModule.html#r7">nwordsblock</a>;  <span class="comment">// set "next" index to # words in block</span>
00701    indx = 0;
00702    <a class="code" href="classRerootToRawDataModule.html#r8">workingarray</a>-&gt;AddAt(need,indx++);
00703    <a class="code" href="classRerootToRawDataModule.html#r8">workingarray</a>-&gt;AddAt(checksum,indx++);
00704    <a class="code" href="classRerootToRawDataModule.html#r8">workingarray</a>-&gt;AddAt(rbid.<a class="code" href="classRawBlockId.html#a4">GetEncoded</a>(),indx++);
00705    <span class="keywordflow">for</span> (Int_t crate=0; crate&lt;ncrates; crate++) {
00706       Int_t csize = <a class="code" href="classRerootToRawDataModule.html#r6">cratesizeused</a>-&gt;At(crate);
00707       TArrayI *wcrate = &amp;<a class="code" href="classRerootToRawDataModule.html#r5">workingcrates</a>[crate];
00708       Int_t   *array  = wcrate-&gt;GetArray();  <span class="comment">// gawd, it's guts are public</span>
00709       <span class="keywordflow">for</span> (Int_t i=0; i&lt;csize; i++) {
00710          <a class="code" href="classRerootToRawDataModule.html#r8">workingarray</a>-&gt;AddAt(array[i],indx++);
00711       }
00712    }     
00713    
00714    <span class="comment">// fill in the true checksum</span>
00715    <span class="keywordtype">int</span> xsum_version = 0;
00716    <a class="code" href="rdChecksum_8h.html#a1">rdxsum_fill</a>((<span class="keywordtype">long</span>*)<a class="code" href="classRerootToRawDataModule.html#r8">workingarray</a>-&gt;GetArray(),xsum_version);
00717    
00718    <span class="comment">// use the proxy to actually create a block</span>
00719    <span class="keywordflow">return</span> rbp-&gt;<a class="code" href="classRawBlockProxy.html#a5">CreateRawDataBlock</a>(<a class="code" href="classRerootToRawDataModule.html#r8">workingarray</a>-&gt;GetArray());
00720 
00721 }
00722 
00723 <span class="comment">//......................................................................</span>
00724 
<a name="l00725"></a><a class="code" href="classRerootToRawDataModule.html#a4">00725</a> <span class="keywordtype">void</span> <a class="code" href="classRerootToRawDataModule.html#a4">RerootToRawDataModule::HandleCommand</a>(<a class="code" href="classJobCommand.html">JobCommand</a> *command) 
00726 {
00727 <span class="comment">//</span>
00728 <span class="comment">// Process configuration commands</span>
00729 <span class="comment">//</span>
00730   TString cmd = command-&gt;<a class="code" href="classJobCommand.html#a5">PopCmd</a>();
00731   <span class="keywordflow">if</span> (cmd == <span class="stringliteral">"Set"</span>) {
00732      TString opt = command-&gt;<a class="code" href="classJobCommand.html#a6">PopOpt</a>();
00733      <span class="keywordflow">if</span>      (opt == <span class="stringliteral">"fRawPeCut"</span>)   <a class="code" href="classRerootToRawDataModule.html#r3">fRawPeCut</a>   = command-&gt;<a class="code" href="classJobCommand.html#a10">PopFloatOpt</a>();
00734      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (opt ==  <span class="stringliteral">"RawPeCut"</span>)   <a class="code" href="classRerootToRawDataModule.html#r3">fRawPeCut</a>   = command-&gt;<a class="code" href="classJobCommand.html#a10">PopFloatOpt</a>();
00735      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (opt == <span class="stringliteral">"fDebugFlags"</span>) <a class="code" href="classRerootToRawDataModule.html#r1">fDebugFlags</a> = command-&gt;<a class="code" href="classJobCommand.html#a9">PopIntOpt</a>();
00736      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (opt == <span class="stringliteral">"Trigger"</span>) {
00737        <a class="code" href="classRerootToRawDataModule.html#r11">Nplaneshit</a> = command-&gt;<a class="code" href="classJobCommand.html#a9">PopIntOpt</a>();
00738        <a class="code" href="classRerootToRawDataModule.html#r12">ofMplanes</a>  = command-&gt;<a class="code" href="classJobCommand.html#a9">PopIntOpt</a>();
00739        <a class="code" href="MsgService_8h.html#a4">MSG</a>(<span class="stringliteral">"Exodus"</span>, Msg::kInfo)
00740            &lt;&lt; <span class="stringliteral">"RerootToRawDataModule: Trigger is "</span> 
00741            &lt;&lt; <a class="code" href="classRerootToRawDataModule.html#r11">Nplaneshit</a> &lt;&lt; <span class="stringliteral">" of "</span> &lt;&lt; <a class="code" href="classRerootToRawDataModule.html#r12">ofMplanes</a> &lt;&lt; endl;
00742      }
00743      <span class="keywordflow">else</span> {
00744         <a class="code" href="MsgService_8h.html#a4">MSG</a>(<span class="stringliteral">"Exodus"</span>, Msg::kWarning)
00745            &lt;&lt; <span class="stringliteral">"RerootToRawDataModule: Unrecognized option "</span> &lt;&lt; opt &lt;&lt; endl;
00746      }
00747   } <span class="keywordflow">else</span> {
00748      <a class="code" href="MsgService_8h.html#a4">MSG</a>(<span class="stringliteral">"Exodus"</span>, Msg::kWarning)
00749         &lt;&lt; <span class="stringliteral">"RerootToRawDataModule: Unrecognized command "</span> &lt;&lt; cmd &lt;&lt; endl;
00750   }
00751 }
00752 
00753 <span class="comment">//......................................................................</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Sat Feb 14 22:48:33 2009 for loon by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.5 </small></address>
</body>
</html>
