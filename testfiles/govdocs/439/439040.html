<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>loon: MakeAlignmentModule.cxx Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.5 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>MakeAlignmentModule.cxx</h1><a href="MakeAlignmentModule_8cxx.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 
00002 <span class="comment">//</span>
00003 <span class="comment">//</span>
00004 <span class="comment">// MakeAlignmentModule</span>
00005 <span class="comment">//</span>
00006 <span class="comment">// Package: DetectorAlignment</span>
00007 <span class="comment">//</span>
00008 <span class="comment">// Alignment engine that processes ntuples files</span>
00009 <span class="comment">//</span>
00010 <span class="comment">// Contact: rustem@fnal.gov</span>
00011 <span class="comment">//</span>
00012 <span class="comment">// Created on: Fri Sep 24 15:26:05 2004</span>
00013 <span class="comment">//</span>
00015 <span class="comment"></span>
00016 <span class="comment">//Local package headers</span>
00017 <span class="preprocessor">#include "<a class="code" href="MakeAlignmentModule_8h.html">MakeAlignmentModule.h</a>"</span>
00018 <span class="preprocessor">#include "<a class="code" href="NtpAlignmentRecord_8h.html">NtpAlignmentRecord.h</a>"</span>
00019 <span class="preprocessor">#include "<a class="code" href="NtpAlignTrackStrip_8h.html">NtpAlignTrackStrip.h</a>"</span>
00020 <span class="preprocessor">#include "<a class="code" href="NtpAlignCandStrip_8h.html">NtpAlignCandStrip.h</a>"</span>
00021 
00022 <span class="comment">//MINOS headers</span>
00023 <span class="preprocessor">#include "<a class="code" href="JobCModuleRegistry_8h.html">JobControl/JobCModuleRegistry.h</a>"</span>
00024 <span class="preprocessor">#include "<a class="code" href="MsgService_8h.html">MessageService/MsgService.h</a>"</span>
00025 <span class="preprocessor">#include "<a class="code" href="MsgFormat_8h.html">MessageService/MsgFormat.h</a>"</span>
00026 <span class="preprocessor">#include "<a class="code" href="MomNavigator_8h.html">MinosObjectMap/MomNavigator.h</a>"</span>
00027 <span class="preprocessor">#include "<a class="code" href="UgliGeomHandle_8h.html">UgliGeometry/UgliGeomHandle.h</a>"</span>
00028 
00029 <span class="comment">//ROOT headers</span>
00030 <span class="preprocessor">#include "TFile.h"</span>
00031 
00032 <span class="comment">//C++ headers</span>
00033 <span class="preprocessor">#include &lt;cassert&gt;</span>
00034 <span class="preprocessor">#include &lt;sstream&gt;</span>
00035 <span class="preprocessor">#include &lt;cmath&gt;</span>
00036 
00037 
00038 <a class="code" href="MsgService_8h.html#a3">CVSID</a>(<span class="stringliteral">"$Id: MakeAlignmentModule.cxx,v 1.7 2007/11/11 08:04:30 rhatcher Exp $"</span>);
00039 
00040 <a class="code" href="JobCModuleRegistry_8h.html#a0">JOBMODULE</a>(<a class="code" href="classMakeAlignmentModule.html">MakeAlignmentModule</a>,<span class="stringliteral">"MakeAlignmentModule"</span>,<span class="stringliteral">"MakeAlignmentModule"</span>);
00041 
00042 <span class="keyword">using</span> <span class="keyword">namespace </span>std;
00043 
<a name="l00044"></a><a class="code" href="classMakeAlignmentModule.html#a0">00044</a> <a class="code" href="classMakeAlignmentModule.html#a0">MakeAlignmentModule::MakeAlignmentModule</a>()
00045    :fAlgorithm(0),
00046     fHistogram(0),
00047     fNearCoilOn(2004, 12, 9, 0, 0, 0), <span class="comment">//Time when ND coil was first turned on</span>
00048     fIteration(0),                      <span class="comment">//Alignment iteration number</span>
00049     fCurrentRun(0),
00050     fCurrentSubRun(0),
00051     fNProcessedSubruns(0),
00052     fNSubRunsPerSubset(41),
00053     fMaxTrackChargeCut(60000.0),        <span class="comment">//cut on max 2d track charge used for alignment</span>
00054     fMinTrackChargeCut(4000.0),         <span class="comment">//cut on min 2d track charge used for alignment</span>
00055     fMaxSigmaOfTPosCut(0.03),           <span class="comment">//cut on uncertainty in tpos from 2d track fit</span>
00056     fTrackChargeRatioCut(0.5),          <span class="comment">//min 3d track's charge ratio to total snarl charge</span>
00057     fMinCosZCut(0.25),                  <span class="comment">//min fabs(cosz) of 3d track angle with Z axis</span>
00058     fMinTrackStripChargeCut(100.0),     <span class="comment">//min charge in a alternative track strip </span>
00059     fMaxTrackStripChargeCut(5000.0),    <span class="comment">//max charge in a hit alignment strip</span>
00060     fSpecialNDRunNumber(5845),          <span class="comment">//ND run # used in 1st ND alignment with magnetic field</span>
00061     fRecalculateResidual(false),
00062     fApplyCuts(false),
00063     fStatisticalSubsetSize(1000000),    <span class="comment">//Number of records in a statistical subset</span>
00064     fNFailedFit(0),
00065     fNRecords(0),
00066     fNPassedRecords(0),
00067     fNSubsetRecords(0),
00068     fNFailedRead(0),
00069     fNMissedVPlane(0),
00070     fNMissedUPlane(0),
00071     fTotalVPlaneHits(0),
00072     fTotalUPlaneHits(0),
00073     fFailedCut(0),
00074     fNHitsOutsideStrip(0),
00075     fNFailedCutMaxVStripCharge(0),
00076     fNFailedCutMaxUStripCharge(0),
00077     fMissedVPlaneMeanCharge(0.0),
00078     fMissedUPlaneMeanCharge(0.0),
00079     fMissedVPlaneChargeSigma(0.0),
00080     fMissedUPlaneChargeSigma(0.0),
00081     fNFailedTrackChargeCut(0),
00082     fNFailedStripChargeCut(0),
00083     fNFailedCosZCut(0),
00084     fNFailedChargeRatioCut(0),
00085     fNFailedSigmaTPosCut(0)
00086 {
00087 }
00088 
<a name="l00089"></a><a class="code" href="classMakeAlignmentModule.html#a2">00089</a> <span class="keywordtype">void</span> <a class="code" href="classMakeAlignmentModule.html#a2">MakeAlignmentModule::BeginJob</a>()
00090 { 
00091    <a class="code" href="MsgService_8h.html#a4">MSG</a>(<span class="stringliteral">"Align"</span>, Msg::kDebug) &lt;&lt; <span class="stringliteral">"MakeAlignmentModule::BeginJob()"</span>&lt;&lt; endl;
00092    <a class="code" href="MsgService_8h.html#a4">MSG</a>(<span class="stringliteral">"Align"</span>, Msg::kInfo) &lt;&lt; <span class="stringliteral">"Initializing variables and histograms..."</span> &lt;&lt; endl;
00093 
00094    <span class="keyword">const</span> <span class="keywordtype">char</span>* strENV_ALIGN_ITER = getenv(<span class="stringliteral">"ENV_ALIGN_ITER"</span>);
00095    <span class="keywordflow">if</span> ( strENV_ALIGN_ITER == 0 || strlen(strENV_ALIGN_ITER) == 0 )
00096    {
00097       <a class="code" href="MsgService_8h.html#a4">MSG</a>(<span class="stringliteral">"Align"</span>, Msg::kFatal) &lt;&lt; <span class="stringliteral">"ENV_ALIGN_ITER is not set!"</span> &lt;&lt;endl
00098                                 &lt;&lt; <span class="stringliteral">" Program is terminating now."</span> &lt;&lt;endl;
00099       abort();
00100    } <span class="keywordflow">else</span> 
00101       <a class="code" href="classMakeAlignmentModule.html#r5">fIteration</a> = atoi(strENV_ALIGN_ITER);
00102    
00103    string alignmentpath;
00104    <span class="keyword">const</span> <span class="keywordtype">char</span>* strENV_ALIGN_DIR = getenv(<span class="stringliteral">"ENV_ALIGN_DIR"</span>);
00105    <span class="keywordflow">if</span> ( strENV_ALIGN_DIR == 0 || strlen(strENV_ALIGN_DIR) == 0 )
00106    {
00107       <a class="code" href="MsgService_8h.html#a4">MSG</a>(<span class="stringliteral">"Align"</span>, Msg::kFatal) &lt;&lt; <span class="stringliteral">"ENV_ALIGN_DIR is not set!"</span>
00108                                 &lt;&lt; <span class="stringliteral">" Program is terminating now."</span> &lt;&lt;endl;
00109       abort();
00110    } <span class="keywordflow">else</span>
00111       alignmentpath = string(strENV_ALIGN_DIR);
00112    
00113    <span class="keyword">const</span> <span class="keywordtype">char</span>* strENV_ALIGN_APPLYCUTS = getenv(<span class="stringliteral">"ENV_ALIGN_APPLYCUTS"</span>);
00114    <span class="keywordflow">if</span> ( strENV_ALIGN_APPLYCUTS == 0 || strlen(strENV_ALIGN_APPLYCUTS) == 0 )
00115    {
00116       <a class="code" href="MsgService_8h.html#a4">MSG</a>(<span class="stringliteral">"Align"</span>, Msg::kWarning) &lt;&lt; <span class="stringliteral">"ENV_ALIGN_APPLYCUTS is not set!"</span>
00117                                   &lt;&lt; <span class="stringliteral">" Using default value: fApplyCuts=false"</span> &lt;&lt;endl;
00118    } <span class="keywordflow">else</span> 
00119       <span class="keywordflow">if</span>(atoi(strENV_ALIGN_APPLYCUTS) == 1)
00120          <a class="code" href="classMakeAlignmentModule.html#r24">fApplyCuts</a> = <span class="keyword">true</span>;
00121       
00122    <span class="keyword">const</span> <span class="keywordtype">char</span>* strENV_ALIGN_RECALCULATE = getenv(<span class="stringliteral">"ENV_ALIGN_RECALCULATE"</span>);
00123    <span class="keywordflow">if</span> ( strENV_ALIGN_RECALCULATE == 0 || strlen(strENV_ALIGN_RECALCULATE) == 0 )
00124    {
00125       <a class="code" href="MsgService_8h.html#a4">MSG</a>(<span class="stringliteral">"Align"</span>, Msg::kWarning) &lt;&lt; <span class="stringliteral">"ENV_ALIGN_RECALCULATE is not set!"</span>
00126                                   &lt;&lt; <span class="stringliteral">" Using default value: fRecalculateResidual=false"</span> &lt;&lt;endl;
00127    } <span class="keywordflow">else</span> 
00128       <span class="keywordflow">if</span>(atoi(strENV_ALIGN_RECALCULATE)==1)
00129          <a class="code" href="classMakeAlignmentModule.html#r23">fRecalculateResidual</a> = <span class="keyword">true</span>;
00130 
00131    <a class="code" href="MsgService_8h.html#a4">MSG</a>(<span class="stringliteral">"Align"</span>, Msg::kInfo) &lt;&lt; endl &lt;&lt; <span class="stringliteral">"fIteration = "</span> &lt;&lt; <a class="code" href="classMakeAlignmentModule.html#r5">fIteration</a> &lt;&lt; endl
00132                             &lt;&lt; <span class="stringliteral">"Alignment path: "</span> &lt;&lt; alignmentpath &lt;&lt; endl
00133                             &lt;&lt; <span class="stringliteral">"fApplyCuts = "</span> &lt;&lt; <a class="code" href="classMakeAlignmentModule.html#r24">fApplyCuts</a> &lt;&lt;endl
00134                             &lt;&lt; <span class="stringliteral">"fRecalculateResidual = "</span> &lt;&lt; <a class="code" href="classMakeAlignmentModule.html#r23">fRecalculateResidual</a> &lt;&lt;endl &lt;&lt; endl;
00135    
00136    stringstream ss;
00137    <span class="keywordflow">if</span>(<a class="code" href="classMakeAlignmentModule.html#r24">fApplyCuts</a>)
00138       ss &lt;&lt; alignmentpath &lt;&lt; <span class="stringliteral">"/new_alignment_"</span> &lt;&lt; <a class="code" href="classMakeAlignmentModule.html#r5">fIteration</a> &lt;&lt; <span class="stringliteral">".root"</span>;
00139    <span class="keywordflow">else</span>
00140       ss &lt;&lt; alignmentpath &lt;&lt; <span class="stringliteral">"/new_alignment_no_cuts_"</span> &lt;&lt; fIteration &lt;&lt; <span class="stringliteral">".root"</span>;         
00141    
00142    <a class="code" href="classMakeAlignmentModule.html#r4">fRootFile</a> = <span class="keyword">new</span> TFile(ss.str().c_str(),<span class="stringliteral">"RECREATE"</span>);
00143    
00144    <a class="code" href="classMakeAlignmentModule.html#r48">fTimer</a>.Start();
00145    <a class="code" href="classMakeAlignmentModule.html#r49">fTimerInterval</a>.Start();
00146 }
00147 
00148 
<a name="l00149"></a><a class="code" href="classMakeAlignmentModule.html#a3">00149</a> <a class="code" href="classJobCResult.html">JobCResult</a> <a class="code" href="classMakeAlignmentModule.html#a3">MakeAlignmentModule::Ana</a>(<span class="keyword">const</span> <a class="code" href="classMomNavigator.html">MomNavigator</a>* mom)
00150 {
00151    <a class="code" href="classMakeAlignmentModule.html#r27">fNRecords</a>++;        
00152 
00153    <a class="code" href="classNtpAlignmentRecord.html">NtpAlignmentRecord</a>* ntprec = dynamic_cast&lt;NtpAlignmentRecord*&gt;(mom-&gt;<a class="code" href="classMomNavigator.html#a3">GetFragment</a>(<span class="stringliteral">"NtpAlignmentRecord"</span>));
00154    <span class="keywordflow">if</span>(!ntprec) <span class="keywordflow">return</span> JobCResult::kAOK;   
00155 
00156    <span class="keyword">const</span> <a class="code" href="classRecCandHeader.html">RecCandHeader</a> candheader = ntprec-&gt;<a class="code" href="classRecRecordImp.html#a3">GetHeader</a>();
00157    <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="do__extrap_8h.html#a34">run</a>    = candheader.<a class="code" href="classRecDataHeader.html#a3">GetRun</a>();
00158    <span class="keyword">const</span> <span class="keywordtype">int</span> subrun = candheader.<a class="code" href="classRecDataHeader.html#a4">GetSubRun</a>();
00159    <a class="code" href="classVldContext.html">VldContext</a> vldc  = candheader.<a class="code" href="classRecHeader.html#a3">GetVldContext</a>();
00160 
00161    <span class="keywordflow">if</span>(<a class="code" href="classMakeAlignmentModule.html#r27">fNRecords</a> % 10000 == 0)
00162    {
00163       <a class="code" href="classMsgFormat.html">MsgFormat</a> f(<span class="stringliteral">"%10d"</span>);      
00164       <a class="code" href="MsgService_8h.html#a4">MSG</a>(<span class="stringliteral">"Align"</span>, Msg::kInfo) &lt;&lt; <span class="stringliteral">"Found NtpAlignmentRecord #"</span> &lt;&lt; f(<a class="code" href="classMakeAlignmentModule.html#r27">fNRecords</a>)
00165                                &lt;&lt; <span class="stringliteral">" run #"</span> &lt;&lt; <a class="code" href="do__extrap_8h.html#a34">run</a> &lt;&lt; <span class="stringliteral">", subrun #"</span> &lt;&lt; subrun
00166                                &lt;&lt; <span class="stringliteral">", cpu time = "</span> &lt;&lt; <a class="code" href="classMakeAlignmentModule.html#r49">fTimerInterval</a>.RealTime() &lt;&lt;endl;
00167       <a class="code" href="classMakeAlignmentModule.html#r49">fTimerInterval</a>.Reset();
00168       <a class="code" href="classMakeAlignmentModule.html#r49">fTimerInterval</a>.Start();
00169    }    
00170 
00171    <span class="keywordflow">if</span>(!<a class="code" href="classMakeAlignmentModule.html#r0">fAlgorithm</a> &amp;&amp; !<a class="code" href="classMakeAlignmentModule.html#r1">fHistogram</a>)
00172    { 
00173       <a class="code" href="classMakeAlignmentModule.html#r6">fValidityContext</a> = vldc;
00174       <a class="code" href="classMakeAlignmentModule.html#r1">fHistogram</a> = <span class="keyword">new</span> <a class="code" href="classAlignmentHistograms.html">AlignmentHistograms</a>(<a class="code" href="classMakeAlignmentModule.html#r4">fRootFile</a>, <a class="code" href="classMakeAlignmentModule.html#r6">fValidityContext</a>);
00175       <a class="code" href="classMakeAlignmentModule.html#r0">fAlgorithm</a> = <span class="keyword">new</span> <a class="code" href="classAlignmentAlgorithm.html">AlignmentAlgorithm</a>(<a class="code" href="classMakeAlignmentModule.html#r4">fRootFile</a>, <a class="code" href="classMakeAlignmentModule.html#r6">fValidityContext</a>);
00176    }
00177    
00178    <span class="keywordflow">if</span>(<a class="code" href="classMakeAlignmentModule.html#r6">fValidityContext</a>.<a class="code" href="classVldContext.html#a4">GetDetector</a>() != vldc.<a class="code" href="classVldContext.html#a4">GetDetector</a>())
00179    {
00180       <a class="code" href="MsgService_8h.html#a4">MSG</a>(<span class="stringliteral">"Align"</span>, Msg::kError) &lt;&lt; <span class="stringliteral">"The data in current record is for the different detector!"</span> &lt;&lt; endl;
00181       <span class="keywordflow">return</span> JobCResult::kAOK;
00182    } <span class="keywordflow">else</span>
00183       <a class="code" href="classMakeAlignmentModule.html#r6">fValidityContext</a> = vldc;   
00184 
00185    <span class="comment">//Fill run summary object</span>
00186    <a class="code" href="classMakeAlignmentModule.html#r2">fRunSummary</a>.<a class="code" href="classAlignmentRunSummary.html#a2">Fill</a>(ntprec); 
00187 
00188    <span class="keywordflow">if</span>(<a class="code" href="classMakeAlignmentModule.html#r24">fApplyCuts</a> &amp;&amp; !<a class="code" href="classMakeAlignmentModule.html#d3">GetTrackQuality</a>(ntprec))
00189    {
00190       <a class="code" href="classMakeAlignmentModule.html#r35">fFailedCut</a>++;
00191       <span class="keywordflow">return</span> JobCResult::kAOK;   
00192    }      
00193       
00194    <span class="comment">//Read residuals and other strips' info to vectors of AlignmentStrips</span>
00195    <span class="keywordflow">if</span>(!<a class="code" href="classMakeAlignmentModule.html#d0">ReadRecord</a>(ntprec))
00196    {
00197       <a class="code" href="classMakeAlignmentModule.html#r35">fFailedCut</a>++;
00198       <a class="code" href="classMakeAlignmentModule.html#r30">fNFailedRead</a>++;
00199       <span class="keywordflow">return</span> JobCResult::kAOK;      
00200    }   
00201 
00202    <span class="keywordflow">if</span>(<a class="code" href="classMakeAlignmentModule.html#r23">fRecalculateResidual</a> &amp;&amp; !<a class="code" href="classMakeAlignmentModule.html#d2">RecalculateResiduals</a>()) 
00203    {
00204       <span class="keywordflow">return</span> JobCResult::kAOK;
00205    }
00206    
00207    <a class="code" href="classMakeAlignmentModule.html#d1">ProcessRecord</a>(ntprec);
00208 
00209    <a class="code" href="classMakeAlignmentModule.html#r1">fHistogram</a> -&gt; FillPlanePlex(<a class="code" href="classMakeAlignmentModule.html#r11">fTrackVStrip</a>, <a class="code" href="classMakeAlignmentModule.html#r13">fCandVStrip</a>);
00210    <a class="code" href="classMakeAlignmentModule.html#r1">fHistogram</a> -&gt; FillPlanePlex(<a class="code" href="classMakeAlignmentModule.html#r12">fTrackUStrip</a>, <a class="code" href="classMakeAlignmentModule.html#r14">fCandUStrip</a>);
00211 
00212    <a class="code" href="classMakeAlignmentModule.html#r28">fNPassedRecords</a>++;
00213    <a class="code" href="classMakeAlignmentModule.html#r29">fNSubsetRecords</a>++;
00214    
00215    <span class="keywordflow">if</span>(<a class="code" href="classMakeAlignmentModule.html#r7">fCurrentRun</a> != <a class="code" href="do__extrap_8h.html#a34">run</a> || <a class="code" href="classMakeAlignmentModule.html#r8">fCurrentSubRun</a> != subrun)
00216    {
00217       <a class="code" href="classMakeAlignmentModule.html#r7">fCurrentRun</a>    = <a class="code" href="do__extrap_8h.html#a34">run</a>;
00218       <a class="code" href="classMakeAlignmentModule.html#r8">fCurrentSubRun</a> = subrun;
00219       <a class="code" href="classMakeAlignmentModule.html#r9">fNProcessedSubruns</a>++;      
00220       <span class="keywordflow">if</span>(<a class="code" href="classMakeAlignmentModule.html#r9">fNProcessedSubruns</a> % <a class="code" href="classMakeAlignmentModule.html#r10">fNSubRunsPerSubset</a> == 0)
00221       {
00222          <span class="keywordflow">if</span>(<a class="code" href="classMakeAlignmentModule.html#r7">fCurrentRun</a> != <a class="code" href="classMakeAlignmentModule.html#r22">fSpecialNDRunNumber</a> ||
00223             <a class="code" href="classMakeAlignmentModule.html#r6">fValidityContext</a>.<a class="code" href="classVldContext.html#a4">GetDetector</a>() != Detector::kNear)
00224          {
00225             <a class="code" href="classMakeAlignmentModule.html#r0">fAlgorithm</a> -&gt; ResetSubset(<a class="code" href="classMakeAlignmentModule.html#r6">fValidityContext</a>, <a class="code" href="classMakeAlignmentModule.html#r29">fNSubsetRecords</a>);
00226             <a class="code" href="classMakeAlignmentModule.html#r29">fNSubsetRecords</a> = 0;
00227          }      
00228       }
00229       <span class="keywordflow">if</span>(<a class="code" href="classMakeAlignmentModule.html#r7">fCurrentRun</a> == <a class="code" href="classMakeAlignmentModule.html#r22">fSpecialNDRunNumber</a> &amp;&amp;
00230          <a class="code" href="classMakeAlignmentModule.html#r6">fValidityContext</a>.<a class="code" href="classVldContext.html#a4">GetDetector</a>() == Detector::kNear)
00231          <span class="keywordflow">if</span>(<a class="code" href="classMakeAlignmentModule.html#r8">fCurrentSubRun</a> == 0 || <a class="code" href="classMakeAlignmentModule.html#r8">fCurrentSubRun</a> == 24)
00232          {
00233             <a class="code" href="classMakeAlignmentModule.html#r0">fAlgorithm</a> -&gt; ResetSubset(<a class="code" href="classMakeAlignmentModule.html#r6">fValidityContext</a>, <a class="code" href="classMakeAlignmentModule.html#r29">fNSubsetRecords</a>);
00234             <a class="code" href="classMakeAlignmentModule.html#r29">fNSubsetRecords</a> = 0;
00235          }
00236    }
00237    
00238    <span class="keywordflow">return</span> JobCResult::kAOK;   
00239 }
00240 
<a name="l00241"></a><a class="code" href="classMakeAlignmentModule.html#a4">00241</a> <span class="keywordtype">void</span> <a class="code" href="classMakeAlignmentModule.html#a4">MakeAlignmentModule::EndJob</a>()
00242 { 
00243    <a class="code" href="classMakeAlignmentModule.html#d6">PrintJobStatistics</a>();   
00244 
00245    <span class="keywordflow">if</span>(<a class="code" href="classMakeAlignmentModule.html#r1">fHistogram</a>) <span class="keyword">delete</span> <a class="code" href="classMakeAlignmentModule.html#r1">fHistogram</a>;
00246 
00247    <span class="keywordflow">if</span>(<a class="code" href="classMakeAlignmentModule.html#r0">fAlgorithm</a>)
00248    {
00249       <a class="code" href="classMakeAlignmentModule.html#r0">fAlgorithm</a> -&gt; ResetSubset(<a class="code" href="classMakeAlignmentModule.html#r6">fValidityContext</a>, <a class="code" href="classMakeAlignmentModule.html#r29">fNSubsetRecords</a>);
00250       <a class="code" href="classMakeAlignmentModule.html#r0">fAlgorithm</a> -&gt; RunAlgorithm();
00251       <span class="keyword">delete</span> <a class="code" href="classMakeAlignmentModule.html#r0">fAlgorithm</a>;
00252    }
00253 
00254    <a class="code" href="classMakeAlignmentModule.html#r2">fRunSummary</a>.<a class="code" href="classAlignmentRunSummary.html#a3">FillSummaryTree</a>(<a class="code" href="classMakeAlignmentModule.html#r4">fRootFile</a>);
00255 
00256    <a class="code" href="MsgService_8h.html#a4">MSG</a>(<span class="stringliteral">"Align"</span>, Msg::kInfo) &lt;&lt; <span class="stringliteral">"Saving root file "</span> &lt;&lt; <a class="code" href="classMakeAlignmentModule.html#r4">fRootFile</a> -&gt; <a class="code" href="classJobCModule.html#a2">GetName</a>() &lt;&lt; endl;
00257    <a class="code" href="classMakeAlignmentModule.html#r4">fRootFile</a> -&gt; Write();
00258    <a class="code" href="classMakeAlignmentModule.html#r4">fRootFile</a> -&gt; Close();
00259 
00260    <a class="code" href="MsgService_8h.html#a4">MSG</a>(<span class="stringliteral">"Align"</span>, Msg::kInfo) &lt;&lt; <span class="stringliteral">"MakeAlignmentModule is done."</span> &lt;&lt; endl;
00261 }
00262 
00263 
00264 <span class="comment">//__________________________________________________________________________________________________</span>
<a name="l00265"></a><a class="code" href="classMakeAlignmentModule.html#d3">00265</a> <span class="keywordtype">bool</span> <a class="code" href="classMakeAlignmentModule.html#d3">MakeAlignmentModule::GetTrackQuality</a>(<span class="keyword">const</span> <a class="code" href="classNtpAlignmentRecord.html">NtpAlignmentRecord</a>* ntprec)
00266 {
00267    <span class="comment">//Check that: 1) Ratio of track charge to total charge in the current </span>
00268    <span class="comment">//            record is greater than fTrackChargeRatioCut</span>
00269    <span class="comment">//            2) Uncertainty in tpos of a fit is less that fSigmaOfTPosCut</span>
00270    <span class="comment">//            3) Charge of 2d tracks is less that fTrackChargeCut</span>
00271 
00272    <span class="comment">//Cut on 2d track charge</span>
00273    <span class="keywordflow">if</span>(ntprec-&gt;<a class="code" href="classNtpAlignmentRecord.html#o5">vcharge</a> &gt; <a class="code" href="classMakeAlignmentModule.html#r15">fMaxTrackChargeCut</a> || ntprec-&gt;<a class="code" href="classNtpAlignmentRecord.html#o5">vcharge</a> &lt; <a class="code" href="classMakeAlignmentModule.html#r16">fMinTrackChargeCut</a> ||
00274       ntprec-&gt;<a class="code" href="classNtpAlignmentRecord.html#o6">ucharge</a> &gt; <a class="code" href="classMakeAlignmentModule.html#r15">fMaxTrackChargeCut</a> || ntprec-&gt;<a class="code" href="classNtpAlignmentRecord.html#o6">ucharge</a> &lt; <a class="code" href="classMakeAlignmentModule.html#r16">fMinTrackChargeCut</a>)
00275    {
00276       <a class="code" href="classMakeAlignmentModule.html#r43">fNFailedTrackChargeCut</a>++;
00277       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00278    }
00279 
00280    <span class="comment">//Cut in tpos uncertainty from linear fit to a track</span>
00281    <span class="keywordflow">if</span>(ntprec-&gt;<a class="code" href="classNtpAlignmentRecord.html#o19">vsigmaoftpos</a> &gt; <a class="code" href="classMakeAlignmentModule.html#r17">fMaxSigmaOfTPosCut</a> || ntprec-&gt;<a class="code" href="classNtpAlignmentRecord.html#o20">usigmaoftpos</a> &gt; <a class="code" href="classMakeAlignmentModule.html#r17">fMaxSigmaOfTPosCut</a>)
00282    {
00283       <a class="code" href="classMakeAlignmentModule.html#r47">fNFailedSigmaTPosCut</a>++;
00284       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00285    }
00286 
00287    <span class="comment">//Cut on 3d track Hough cos with horizontal z axis</span>
00288    <span class="keywordflow">if</span>(fabs(ntprec-&gt;<a class="code" href="classNtpAlignmentRecord.html#o25">hcosz</a>) &lt; <a class="code" href="classMakeAlignmentModule.html#r19">fMinCosZCut</a>)
00289    {
00290       <a class="code" href="classMakeAlignmentModule.html#r45">fNFailedCosZCut</a>++;
00291       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00292    }
00293 
00294    <span class="keyword">const</span> <span class="keywordtype">double</span> allcharge = ntprec -&gt; vcharge + ntprec -&gt; ucharge
00295       + ntprec -&gt; vcandcharge + ntprec -&gt; ucandcharge;
00296 
00297    <span class="keywordflow">if</span>(allcharge &lt; 1.0)
00298       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00299    
00300    Double_t ratio = (ntprec -&gt; vcharge + ntprec -&gt; ucharge)/allcharge;
00301    
00302    <span class="keywordflow">if</span>(ratio &lt; <a class="code" href="classMakeAlignmentModule.html#r18">fTrackChargeRatioCut</a>)
00303    {
00304       <a class="code" href="classMakeAlignmentModule.html#r46">fNFailedChargeRatioCut</a>++;
00305       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00306    }   
00307 
00308    <span class="keywordflow">return</span> <span class="keyword">true</span>;
00309 }
00310 
00311 
00312 <span class="comment">//__________________________________________________________________________________________________</span>
<a name="l00313"></a><a class="code" href="classMakeAlignmentModule.html#d0">00313</a> <span class="keywordtype">bool</span> <a class="code" href="classMakeAlignmentModule.html#d0">MakeAlignmentModule::ReadRecord</a>(<span class="keyword">const</span> <a class="code" href="classNtpAlignmentRecord.html">NtpAlignmentRecord</a>* ntprec)
00314 {
00315    <a class="code" href="classMakeAlignmentModule.html#r11">fTrackVStrip</a>.clear();
00316    <a class="code" href="classMakeAlignmentModule.html#r12">fTrackUStrip</a>.clear();
00317    <a class="code" href="classMakeAlignmentModule.html#r13">fCandVStrip</a>.clear();
00318    <a class="code" href="classMakeAlignmentModule.html#r14">fCandUStrip</a>.clear();
00319 
00320    <a class="code" href="classUgliGeomHandle.html">UgliGeomHandle</a> ugh(<a class="code" href="classMakeAlignmentModule.html#r6">fValidityContext</a>);
00321 
00322    <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; ntprec -&gt; ntrackvstrip; ++i)
00323    {
00324       <a class="code" href="classNtpAlignTrackStrip.html">NtpAlignTrackStrip</a>* strip = dynamic_cast&lt;NtpAlignTrackStrip*&gt;(ntprec-&gt;<a class="code" href="classNtpAlignmentRecord.html#o29">trackvstrip</a>-&gt;At(i));
00325       assert(strip);
00326       
00327       <a class="code" href="classAlignmentStrip.html">AlignmentStrip</a> astrip(strip);
00328       <span class="keywordflow">if</span>(<a class="code" href="classMakeAlignmentModule.html#r24">fApplyCuts</a> &amp;&amp; astrip.<a class="code" href="classAlignmentStrip.html#o4">charge</a> &gt; <a class="code" href="classMakeAlignmentModule.html#r21">fMaxTrackStripChargeCut</a>){
00329          <a class="code" href="classMakeAlignmentModule.html#r37">fNFailedCutMaxVStripCharge</a>++;
00330          <a class="code" href="classMakeAlignmentModule.html#r44">fNFailedStripChargeCut</a>++;
00331          <span class="keywordflow">return</span> <span class="keyword">false</span>;
00332       }
00333       
00334       <a class="code" href="classPlexStripEndId.html">PlexStripEndId</a> plexid(astrip.<a class="code" href="classAlignmentStrip.html#o0">plexseid</a>);
00335       <a class="code" href="classUgliStripHandle.html">UgliStripHandle</a> ush = ugh.<a class="code" href="classUgliGeomHandle.html#a12">GetStripHandle</a>(plexid);
00336 
00337       astrip.<a class="code" href="classAlignmentStrip.html#o1">plane</a> = plexid.<a class="code" href="classPlexPlaneId.html#a7">GetPlane</a>();
00338       astrip.<a class="code" href="classAlignmentStrip.html#o2">strip</a> = plexid.<a class="code" href="classPlexStripEndId.html#a8">GetStrip</a>();
00339       astrip.<a class="code" href="classAlignmentStrip.html#o6">tpos</a> = ush.<a class="code" href="classUgliStripHandle.html#a13">GetTPos</a>();
00340       astrip.<a class="code" href="classAlignmentStrip.html#o9">zpos</a> = ush.<a class="code" href="classUgliStripHandle.html#a26">GetScintPlnHandle</a>().<a class="code" href="classUgliPlnHandle.html#a16">GetZ0</a>();
00341       astrip.<a class="code" href="classAlignmentStrip.html#o7">tposrelmdl</a> = ush.<a class="code" href="classUgliStripHandle.html#a29">GetTPosRelMdl</a>();
00342       astrip.<a class="code" href="classAlignmentStrip.html#o8">lposrelmdl</a> = ush.<a class="code" href="classUgliStripHandle.html#a28">GetLPosRelMdl</a>();
00343       astrip.<a class="code" href="classAlignmentStrip.html#o5">charge_pc</a>  = astrip.<a class="code" href="classAlignmentStrip.html#o4">charge</a> * ntprec -&gt; hcosz;
00344 
00345       <span class="comment">//use fit results in opposite view to get longitudinal position</span>
00346       astrip.<a class="code" href="classAlignmentStrip.html#o15">ghitpos</a> = (ntprec -&gt; ufita)*astrip.<a class="code" href="classAlignmentStrip.html#o9">zpos</a> + ntprec -&gt; ufitb;      
00347 
00348       <a class="code" href="classMakeAlignmentModule.html#d5">ConvertToLocal</a>(astrip, plexid, ugh, ush);
00349       <a class="code" href="classMakeAlignmentModule.html#r11">fTrackVStrip</a>.push_back(astrip);
00350    }
00351 
00352 
00353    <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; ntprec -&gt; ntrackustrip; ++i)
00354    {
00355       <a class="code" href="classNtpAlignTrackStrip.html">NtpAlignTrackStrip</a>* strip = dynamic_cast&lt;NtpAlignTrackStrip*&gt;(ntprec-&gt;<a class="code" href="classNtpAlignmentRecord.html#o30">trackustrip</a>-&gt;At(i));
00356       assert(strip);
00357       
00358       <a class="code" href="classAlignmentStrip.html">AlignmentStrip</a> astrip(strip);      
00359       <span class="keywordflow">if</span>(<a class="code" href="classMakeAlignmentModule.html#r24">fApplyCuts</a> &amp;&amp; astrip.<a class="code" href="classAlignmentStrip.html#o4">charge</a> &gt; <a class="code" href="classMakeAlignmentModule.html#r21">fMaxTrackStripChargeCut</a>){
00360          <a class="code" href="classMakeAlignmentModule.html#r38">fNFailedCutMaxUStripCharge</a>++;
00361          <a class="code" href="classMakeAlignmentModule.html#r44">fNFailedStripChargeCut</a>++;
00362          <span class="keywordflow">return</span> <span class="keyword">false</span>;
00363       }
00364 
00365       <a class="code" href="classPlexStripEndId.html">PlexStripEndId</a> plexid(astrip.<a class="code" href="classAlignmentStrip.html#o0">plexseid</a>);
00366       <a class="code" href="classUgliStripHandle.html">UgliStripHandle</a> ush = ugh.<a class="code" href="classUgliGeomHandle.html#a12">GetStripHandle</a>(plexid);
00367 
00368       astrip.<a class="code" href="classAlignmentStrip.html#o1">plane</a> = plexid.<a class="code" href="classPlexPlaneId.html#a7">GetPlane</a>();
00369       astrip.<a class="code" href="classAlignmentStrip.html#o2">strip</a> = plexid.<a class="code" href="classPlexStripEndId.html#a8">GetStrip</a>(); 
00370       astrip.<a class="code" href="classAlignmentStrip.html#o6">tpos</a> = ush.<a class="code" href="classUgliStripHandle.html#a13">GetTPos</a>();
00371       astrip.<a class="code" href="classAlignmentStrip.html#o9">zpos</a> = ush.<a class="code" href="classUgliStripHandle.html#a26">GetScintPlnHandle</a>().<a class="code" href="classUgliPlnHandle.html#a16">GetZ0</a>();
00372       astrip.<a class="code" href="classAlignmentStrip.html#o7">tposrelmdl</a> = ush.<a class="code" href="classUgliStripHandle.html#a29">GetTPosRelMdl</a>();
00373       astrip.<a class="code" href="classAlignmentStrip.html#o8">lposrelmdl</a> = ush.<a class="code" href="classUgliStripHandle.html#a28">GetLPosRelMdl</a>();
00374       astrip.<a class="code" href="classAlignmentStrip.html#o5">charge_pc</a>  = astrip.<a class="code" href="classAlignmentStrip.html#o4">charge</a> * ntprec -&gt; hcosz;
00375 
00376       <span class="comment">//use fit results in opposite view to get longitudinal position</span>
00377       astrip.<a class="code" href="classAlignmentStrip.html#o15">ghitpos</a> = (ntprec -&gt; vfita)*astrip.<a class="code" href="classAlignmentStrip.html#o9">zpos</a> + ntprec -&gt; vfitb;
00378       
00379       <a class="code" href="classMakeAlignmentModule.html#d5">ConvertToLocal</a>(astrip, plexid, ugh, ush);
00380       <a class="code" href="classMakeAlignmentModule.html#r12">fTrackUStrip</a>.push_back(astrip);
00381    }
00382 
00383 
00384    <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; ntprec -&gt; ncandvstrip; ++i)
00385    {
00386       <a class="code" href="classNtpAlignCandStrip.html">NtpAlignCandStrip</a>* strip = dynamic_cast&lt;NtpAlignCandStrip*&gt;(ntprec-&gt;<a class="code" href="classNtpAlignmentRecord.html#o31">candvstrip</a>-&gt;At(i));
00387       assert(strip);
00388       
00389       <a class="code" href="classAlignmentStrip.html">AlignmentStrip</a> astrip(strip);
00390       <a class="code" href="classPlexStripEndId.html">PlexStripEndId</a> plexid(astrip.<a class="code" href="classAlignmentStrip.html#o0">plexseid</a>);
00391       <a class="code" href="classUgliStripHandle.html">UgliStripHandle</a> ush = ugh.<a class="code" href="classUgliGeomHandle.html#a12">GetStripHandle</a>(plexid);
00392 
00393       astrip.<a class="code" href="classAlignmentStrip.html#o6">tpos</a> = ush.<a class="code" href="classUgliStripHandle.html#a13">GetTPos</a>();
00394       astrip.<a class="code" href="classAlignmentStrip.html#o9">zpos</a> = ush.<a class="code" href="classUgliStripHandle.html#a26">GetScintPlnHandle</a>().<a class="code" href="classUgliPlnHandle.html#a16">GetZ0</a>();
00395       astrip.<a class="code" href="classAlignmentStrip.html#o7">tposrelmdl</a> = ush.<a class="code" href="classUgliStripHandle.html#a29">GetTPosRelMdl</a>();
00396       astrip.<a class="code" href="classAlignmentStrip.html#o8">lposrelmdl</a> = ush.<a class="code" href="classUgliStripHandle.html#a28">GetLPosRelMdl</a>();
00397       astrip.<a class="code" href="classAlignmentStrip.html#o1">plane</a> = plexid.<a class="code" href="classPlexPlaneId.html#a7">GetPlane</a>();
00398       astrip.<a class="code" href="classAlignmentStrip.html#o2">strip</a> = plexid.<a class="code" href="classPlexStripEndId.html#a8">GetStrip</a>();
00399       <a class="code" href="classMakeAlignmentModule.html#r13">fCandVStrip</a>.push_back(astrip);
00400 
00401       <a class="code" href="classMakeAlignmentModule.html#r0">fAlgorithm</a> -&gt; FillCandStrip(astrip);
00402    }
00403 
00404    <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; ntprec -&gt; ncandustrip; ++i)
00405    {
00406       <a class="code" href="classNtpAlignCandStrip.html">NtpAlignCandStrip</a>* strip = dynamic_cast&lt;NtpAlignCandStrip*&gt;(ntprec-&gt;<a class="code" href="classNtpAlignmentRecord.html#o32">candustrip</a>-&gt;At(i));
00407       assert(strip);
00408 
00409       <a class="code" href="classAlignmentStrip.html">AlignmentStrip</a> astrip(strip);
00410       <a class="code" href="classPlexStripEndId.html">PlexStripEndId</a> plexid(astrip.<a class="code" href="classAlignmentStrip.html#o0">plexseid</a>);
00411       <a class="code" href="classUgliStripHandle.html">UgliStripHandle</a> ush = ugh.<a class="code" href="classUgliGeomHandle.html#a12">GetStripHandle</a>(plexid);
00412 
00413       astrip.<a class="code" href="classAlignmentStrip.html#o6">tpos</a> = ush.<a class="code" href="classUgliStripHandle.html#a13">GetTPos</a>();
00414       astrip.<a class="code" href="classAlignmentStrip.html#o9">zpos</a> = ush.<a class="code" href="classUgliStripHandle.html#a26">GetScintPlnHandle</a>().<a class="code" href="classUgliPlnHandle.html#a16">GetZ0</a>();
00415       astrip.<a class="code" href="classAlignmentStrip.html#o7">tposrelmdl</a> = ush.<a class="code" href="classUgliStripHandle.html#a29">GetTPosRelMdl</a>();
00416       astrip.<a class="code" href="classAlignmentStrip.html#o8">lposrelmdl</a> = ush.<a class="code" href="classUgliStripHandle.html#a28">GetLPosRelMdl</a>();
00417       astrip.<a class="code" href="classAlignmentStrip.html#o1">plane</a> = plexid.<a class="code" href="classPlexPlaneId.html#a7">GetPlane</a>();
00418       astrip.<a class="code" href="classAlignmentStrip.html#o2">strip</a> = plexid.<a class="code" href="classPlexStripEndId.html#a8">GetStrip</a>();
00419       <a class="code" href="classMakeAlignmentModule.html#r14">fCandUStrip</a>.push_back(astrip);
00420 
00421       <a class="code" href="classMakeAlignmentModule.html#r0">fAlgorithm</a> -&gt; FillCandStrip(astrip);
00422    }
00423 
00424    <a class="code" href="classMakeAlignmentModule.html#r33">fTotalVPlaneHits</a> += <a class="code" href="classMakeAlignmentModule.html#r11">fTrackVStrip</a>.size();
00425    <a class="code" href="classMakeAlignmentModule.html#r34">fTotalUPlaneHits</a> += <a class="code" href="classMakeAlignmentModule.html#r12">fTrackUStrip</a>.size();
00426    <span class="keywordflow">return</span> <span class="keyword">true</span>;
00427 }
00428 
00429 
00430 <span class="comment">//__________________________________________________________________________________________________</span>
<a name="l00431"></a><a class="code" href="classMakeAlignmentModule.html#d1">00431</a> <span class="keywordtype">void</span> <a class="code" href="classMakeAlignmentModule.html#d1">MakeAlignmentModule::ProcessRecord</a>(<span class="keyword">const</span> <a class="code" href="classNtpAlignmentRecord.html">NtpAlignmentRecord</a>* ntprec)
00432 {
00433    <span class="keywordflow">for</span>(<a class="code" href="classstd_1_1vector.html">vector&lt;AlignmentStrip&gt;</a>::const_iterator vit = <a class="code" href="classMakeAlignmentModule.html#r11">fTrackVStrip</a>.begin(); 
00434        vit != <a class="code" href="classMakeAlignmentModule.html#r11">fTrackVStrip</a>.end(); ++vit)
00435    {
00436       <span class="keyword">const</span> <a class="code" href="classAlignmentStrip.html">AlignmentStrip</a> &amp;astrip = *vit;
00437       <a class="code" href="classMakeAlignmentModule.html#r0">fAlgorithm</a> -&gt; Fill(astrip);
00438       <a class="code" href="classMakeAlignmentModule.html#r1">fHistogram</a> -&gt; Fill(astrip, ntprec);
00439    }
00440 
00441    <span class="keywordflow">for</span>(<a class="code" href="classstd_1_1vector.html">vector&lt;AlignmentStrip&gt;</a>::const_iterator uit = <a class="code" href="classMakeAlignmentModule.html#r12">fTrackUStrip</a>.begin(); 
00442        uit != <a class="code" href="classMakeAlignmentModule.html#r12">fTrackUStrip</a>.end(); ++uit)
00443    {
00444       <span class="keyword">const</span> <a class="code" href="classAlignmentStrip.html">AlignmentStrip</a> &amp;astrip = *uit;
00445       <a class="code" href="classMakeAlignmentModule.html#r0">fAlgorithm</a> -&gt; Fill(astrip);
00446       <a class="code" href="classMakeAlignmentModule.html#r1">fHistogram</a> -&gt; Fill(astrip, ntprec);
00447    }
00448 
00449 }
00450 
00451 <span class="comment">//__________________________________________________________________________________________________</span>
<a name="l00452"></a><a class="code" href="classMakeAlignmentModule.html#d2">00452</a> <span class="keywordtype">bool</span> <a class="code" href="classMakeAlignmentModule.html#d2">MakeAlignmentModule::RecalculateResiduals</a>()
00453 {
00454    
00455    <a class="code" href="classUgliGeomHandle.html">UgliGeomHandle</a> ugh(<a class="code" href="classMakeAlignmentModule.html#r6">fValidityContext</a>);
00456 
00457    <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classMakeAlignmentModule.html#r11">fTrackVStrip</a>.size(); ++i){
00458       <a class="code" href="classAlignmentStrip.html">AlignmentStrip</a> &amp;astrip = <a class="code" href="classMakeAlignmentModule.html#r11">fTrackVStrip</a>[i];
00459       <a class="code" href="classPlexStripEndId.html">PlexStripEndId</a> plexid(astrip.<a class="code" href="classAlignmentStrip.html#o0">plexseid</a>);
00460       <a class="code" href="classUgliStripHandle.html">UgliStripHandle</a> ush = ugh.<a class="code" href="classUgliGeomHandle.html#a12">GetStripHandle</a>(plexid);    
00461       TVector3 local(astrip.<a class="code" href="classAlignmentStrip.html#o16">lhitpos</a>, 0, 0);
00462       TVector3 globalxyz = ush.<a class="code" href="classUgliStripHandle.html#a20">GlobalPos</a>(astrip.<a class="code" href="classAlignmentStrip.html#o16">lhitpos</a>);
00463       TVector3 globaluvz = ugh.<a class="code" href="classUgliGeomHandle.html#a34">xyz2uvz</a>(globalxyz);
00464       <span class="keywordtype">double</span> tpos = globaluvz.y();
00465       <span class="keywordtype">double</span> zpos = globaluvz.z();
00466       <span class="keywordflow">if</span>(fabs(astrip.<a class="code" href="classAlignmentStrip.html#o6">tpos</a>-tpos) &gt; 0.001){
00467          <a class="code" href="classMsgFormat.html">MsgFormat</a> f(<span class="stringliteral">"%10.9f"</span>);
00468          <a class="code" href="MsgService_8h.html#a4">MSG</a>(<span class="stringliteral">"Align"</span>,Msg::kError) &lt;&lt; <span class="stringliteral">"global tpos - local tpos = "</span> &lt;&lt; f(astrip.<a class="code" href="classAlignmentStrip.html#o6">tpos</a>-tpos) &lt;&lt;endl;
00469       }
00470       <span class="keywordflow">if</span>(fabs(astrip.<a class="code" href="classAlignmentStrip.html#o9">zpos</a>-zpos) &gt; 0.001){
00471          <a class="code" href="classMsgFormat.html">MsgFormat</a> f(<span class="stringliteral">"%10.9f"</span>);
00472          <a class="code" href="MsgService_8h.html#a4">MSG</a>(<span class="stringliteral">"Align"</span>,Msg::kError) &lt;&lt; <span class="stringliteral">"zpos before - zpos after = "</span> &lt;&lt; f(astrip.<a class="code" href="classAlignmentStrip.html#o9">zpos</a>-zpos) &lt;&lt;endl;
00473       }
00474       astrip.<a class="code" href="classAlignmentStrip.html#o6">tpos</a> = globaluvz.y();
00475    }
00476    
00477    <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classMakeAlignmentModule.html#r12">fTrackUStrip</a>.size(); ++i){
00478       <a class="code" href="classAlignmentStrip.html">AlignmentStrip</a> &amp;astrip = <a class="code" href="classMakeAlignmentModule.html#r12">fTrackUStrip</a>[i];
00479       <a class="code" href="classPlexStripEndId.html">PlexStripEndId</a> plexid(astrip.<a class="code" href="classAlignmentStrip.html#o0">plexseid</a>);
00480       <a class="code" href="classUgliStripHandle.html">UgliStripHandle</a> ush = ugh.<a class="code" href="classUgliGeomHandle.html#a12">GetStripHandle</a>(plexid);      
00481       TVector3 local(astrip.<a class="code" href="classAlignmentStrip.html#o16">lhitpos</a>, 0, 0);
00482       TVector3 globalxyz = ush.<a class="code" href="classUgliStripHandle.html#a20">GlobalPos</a>(astrip.<a class="code" href="classAlignmentStrip.html#o16">lhitpos</a>);
00483       TVector3 globaluvz = ugh.<a class="code" href="classUgliGeomHandle.html#a34">xyz2uvz</a>(globalxyz);
00484       <span class="keywordtype">double</span> tpos = globaluvz.x();
00485       <span class="keywordtype">double</span> zpos = globaluvz.z();
00486       <span class="keywordflow">if</span>(fabs(astrip.<a class="code" href="classAlignmentStrip.html#o6">tpos</a>-tpos) &gt; 0.001){
00487          <a class="code" href="classMsgFormat.html">MsgFormat</a> f(<span class="stringliteral">"%10.9f"</span>);
00488          <a class="code" href="MsgService_8h.html#a4">MSG</a>(<span class="stringliteral">"Align"</span>,Msg::kError) &lt;&lt; <span class="stringliteral">"global tpos - local tpos = "</span> &lt;&lt; f(astrip.<a class="code" href="classAlignmentStrip.html#o6">tpos</a>-tpos) &lt;&lt;endl;
00489       }
00490       <span class="keywordflow">if</span>(fabs(astrip.<a class="code" href="classAlignmentStrip.html#o9">zpos</a>-zpos) &gt; 0.001){
00491          <a class="code" href="classMsgFormat.html">MsgFormat</a> f(<span class="stringliteral">"%10.9f"</span>);
00492          <a class="code" href="MsgService_8h.html#a4">MSG</a>(<span class="stringliteral">"Align"</span>,Msg::kError) &lt;&lt; <span class="stringliteral">"zpos before - zpos after = "</span> &lt;&lt; f(astrip.<a class="code" href="classAlignmentStrip.html#o9">zpos</a>-zpos) &lt;&lt;endl;
00493       }
00494 
00495       astrip.<a class="code" href="classAlignmentStrip.html#o6">tpos</a> = globaluvz.x();
00496    }
00497 
00498    <span class="keywordflow">for</span>(<a class="code" href="classstd_1_1vector.html">vector&lt;AlignmentStrip&gt;</a>::iterator vit = <a class="code" href="classMakeAlignmentModule.html#r11">fTrackVStrip</a>.begin(); 
00499        vit != <a class="code" href="classMakeAlignmentModule.html#r11">fTrackVStrip</a>.end(); ++vit){
00500       <span class="keywordtype">double</span> residual = <a class="code" href="classMakeAlignmentModule.html#d4">FitTrackLessOne</a>(<a class="code" href="classMakeAlignmentModule.html#r11">fTrackVStrip</a>.begin(),   <a class="code" href="classMakeAlignmentModule.html#r11">fTrackVStrip</a>.end(), vit);
00501       <span class="keywordflow">if</span>(fabs(residual) &gt; 1.0)
00502          <span class="keywordflow">return</span> <span class="keyword">false</span>;
00503       <a class="code" href="classAlignmentStrip.html">AlignmentStrip</a> &amp;astrip = *vit;
00504       <span class="keywordflow">if</span>(fabs(astrip.<a class="code" href="classAlignmentStrip.html#o14">residual</a>-residual) &gt; 0.00001){
00505          <a class="code" href="classMsgFormat.html">MsgFormat</a> ffrt(<span class="stringliteral">"%7.6f"</span>);
00506          <a class="code" href="MsgService_8h.html#a4">MSG</a>(<span class="stringliteral">"Align"</span>, Msg::kError) &lt;&lt; <span class="stringliteral">"V residual diff after tpos correction for "</span> 
00507                                    &lt;&lt; <a class="code" href="classPlexStripEndId.html">PlexStripEndId</a>(astrip.<a class="code" href="classAlignmentStrip.html#o0">plexseid</a>) &lt;&lt; <span class="stringliteral">" = "</span>
00508                                    &lt;&lt; ffrt(residual - astrip.<a class="code" href="classAlignmentStrip.html#o14">residual</a>) &lt;&lt; endl;
00509       }
00510       astrip.<a class="code" href="classAlignmentStrip.html#o14">residual</a> = residual;
00511    }
00512    
00513    <span class="keywordflow">for</span>(<a class="code" href="classstd_1_1vector.html">vector&lt;AlignmentStrip&gt;</a>::iterator uit = <a class="code" href="classMakeAlignmentModule.html#r12">fTrackUStrip</a>.begin(); 
00514        uit != <a class="code" href="classMakeAlignmentModule.html#r12">fTrackUStrip</a>.end(); ++uit){
00515       <span class="keywordtype">double</span> residual = <a class="code" href="classMakeAlignmentModule.html#d4">FitTrackLessOne</a>(<a class="code" href="classMakeAlignmentModule.html#r12">fTrackUStrip</a>.begin(),   <a class="code" href="classMakeAlignmentModule.html#r12">fTrackUStrip</a>.end(), uit);
00516       <span class="keywordflow">if</span>(fabs(residual) &gt; 1.0)
00517          <span class="keywordflow">return</span> <span class="keyword">false</span>;
00518       <a class="code" href="classAlignmentStrip.html">AlignmentStrip</a> &amp;astrip = *uit;
00519       <span class="keywordflow">if</span>(fabs(astrip.<a class="code" href="classAlignmentStrip.html#o14">residual</a>-residual) &gt; 0.00001){
00520          <a class="code" href="classMsgFormat.html">MsgFormat</a> ffrt(<span class="stringliteral">"%7.6f"</span>);
00521          <a class="code" href="MsgService_8h.html#a4">MSG</a>(<span class="stringliteral">"Align"</span>, Msg::kError) &lt;&lt; <span class="stringliteral">"U residual diff after tpos correction for "</span> 
00522                                    &lt;&lt; <a class="code" href="classPlexStripEndId.html">PlexStripEndId</a>(astrip.<a class="code" href="classAlignmentStrip.html#o0">plexseid</a>) &lt;&lt; <span class="stringliteral">" = "</span>
00523                                    &lt;&lt; ffrt(residual - astrip.<a class="code" href="classAlignmentStrip.html#o14">residual</a>) &lt;&lt; endl;
00524       }
00525 
00526       astrip.<a class="code" href="classAlignmentStrip.html#o14">residual</a> = residual;
00527    }
00528    <span class="keywordflow">return</span> <span class="keyword">true</span>;
00529 }
00530 
00531 <span class="comment">// Fits a linear track to the straigh track's hits between "run" and</span>
00532 <span class="comment">// "end" while skipping the hit "skip".  </span>
00533 <span class="comment">//__________________________________________________________________________________________________</span>
<a name="l00534"></a><a class="code" href="classMakeAlignmentModule.html#d4">00534</a> <span class="keywordtype">double</span> <a class="code" href="classMakeAlignmentModule.html#d4">MakeAlignmentModule::FitTrackLessOne</a>(<a class="code" href="classstd_1_1vector.html">vector&lt;AlignmentStrip&gt;</a>::const_iterator begin,
00535                                             <a class="code" href="classstd_1_1vector.html">vector&lt;AlignmentStrip&gt;</a>::const_iterator end, 
00536                                             <a class="code" href="classstd_1_1vector.html">vector&lt;AlignmentStrip&gt;</a>::const_iterator skip)
00537 {
00538 
00539    
00540    <a class="code" href="MsgService_8h.html#a4">MSG</a>(<span class="stringliteral">"Align"</span>, Msg::kVerbose) &lt;&lt; <span class="stringliteral">"FitTrackLessOne..."</span> &lt;&lt; endl;
00541    <span class="comment">// Linear regression parameters least squares method. See for eg. Num Rec Ch 15</span>
00542    <span class="comment">// Fit y = ax + b, as in W. R. Leo, Techniques for ..., Section 4.7.2</span>
00543    <span class="comment">// x is strip's Z position, y is strip's transverse position (U or V).</span>
00544    <span class="keywordtype">double</span> <a class="code" href="classA.html">A</a>=0.0, <a class="code" href="classB.html">B</a>=0.0, <a class="code" href="classC.html">C</a>=0.0, D=0.0, E=0.0, <a class="code" href="novascon_8c.html#a8">F</a>=0.0;
00545 
00546    <span class="keywordflow">for</span> (<a class="code" href="classstd_1_1vector.html">vector&lt;AlignmentStrip&gt;</a>::const_iterator <a class="code" href="do__extrap_8h.html#a34">run</a> = begin; <a class="code" href="do__extrap_8h.html#a34">run</a> != end; ++<a class="code" href="do__extrap_8h.html#a34">run</a>) 
00547       <span class="keywordflow">if</span> (<a class="code" href="do__extrap_8h.html#a34">run</a> != skip){
00548          <span class="keywordtype">double</span> x = <a class="code" href="do__extrap_8h.html#a34">run</a> -&gt; zpos;
00549          <span class="keywordtype">double</span> y = <a class="code" href="do__extrap_8h.html#a34">run</a> -&gt; tpos;
00550          A += x;
00551          <a class="code" href="classB.html">B</a> += 1.0;
00552          <a class="code" href="classC.html">C</a> += y;
00553          D += x*x;
00554          E += x*y;
00555          <a class="code" href="novascon_8c.html#a8">F</a> += y*y;
00556       }
00557    
00558    <span class="keywordtype">double</span> det = <a class="code" href="classB.html">B</a>*D - A*A; <span class="comment">//determinant of error matrix</span>
00559    <span class="keywordflow">if</span>(fabs(det) &lt; 0.000001){
00560       <a class="code" href="MsgService_8h.html#a4">MSG</a>(<span class="stringliteral">"Align"</span>, Msg::kWarning) &lt;&lt; <span class="stringliteral">"Linear fit failed!"</span> &lt;&lt; endl;
00561       <span class="keywordflow">return</span> -100.0;
00562    }
00563    
00564    <span class="comment">// The linear fit: y = ax + b</span>
00565    <span class="keywordtype">double</span> a  = (E*<a class="code" href="classB.html">B</a>-<a class="code" href="classC.html">C</a>*A)/det;
00566    <span class="keywordtype">double</span> b  = (D*<a class="code" href="classC.html">C</a>-E*A)/det;
00567 
00568    <span class="keywordtype">double</span> skipped_x = skip -&gt; zpos;
00569    <span class="keywordtype">double</span> skipped_y = skip -&gt; tpos;
00570    <span class="keywordtype">double</span> predict   = a*skipped_x + b;       
00571     
00572    <a class="code" href="MsgService_8h.html#a4">MSG</a>(<span class="stringliteral">"Align"</span>, Msg::kVerbose) &lt;&lt; <span class="stringliteral">"FitTrackLessOne Done!"</span> &lt;&lt; endl;
00573    <span class="keywordflow">return</span> (predict - skipped_y);
00574     
00575 }
00576 
00577 <span class="comment">//__________________________________________________________________________________________________</span>
<a name="l00578"></a><a class="code" href="classMakeAlignmentModule.html#d5">00578</a> <span class="keywordtype">void</span> <a class="code" href="classMakeAlignmentModule.html#d5">MakeAlignmentModule::ConvertToLocal</a>(<a class="code" href="classAlignmentStrip.html">AlignmentStrip</a> &amp;astrip,
00579                                          <a class="code" href="classPlexStripEndId.html">PlexStripEndId</a> &amp;plexid, 
00580                                          <a class="code" href="classUgliGeomHandle.html">UgliGeomHandle</a> &amp;ugh,
00581                                          <a class="code" href="classUgliStripHandle.html">UgliStripHandle</a> &amp;ush)
00582 {
00583    <span class="comment">// calculate the position of strip ends in (strip) local co-ordinates</span>
00584    <span class="comment">// x = distance along the strip, y=distance in +tpos coordinate</span>
00585    <span class="comment">// the "logical" strip is the one as-if there were no coil/bypass</span>
00586    Double_t halflen = ush.<a class="code" href="classUgliStripHandle.html#a10">GetHalfLength</a>();
00587    <span class="comment">//   TVector3 localCenter(0,0,0);  // center of the "logical" strip</span>
00588    <span class="comment">//   TVector3 localEastEnd(-halflen,0,0);</span>
00589    TVector3 localWestEnd(+halflen, 0.0, 0.0);
00590    <span class="comment">//   TVector3 localHitLPos(astrip.lhitpos,0,0);</span>
00591    
00592    <span class="comment">// calculate the positions in global XYZ space</span>
00593    <span class="comment">//TVector3 xyz0 = ush.LocalToGlobal(localCenter);</span>
00594    <span class="comment">//TVector3 xyzE = ush.LocalToGlobal(localEastEnd);</span>
00595    <span class="comment">//TVector3 xyzW = ush.LocalToGlobal(localWestEnd);</span>
00596 
00597    Double_t u = 0.0, v = 0.0;
00598 
00599    <span class="keywordflow">if</span>(plexid.<a class="code" href="classPlexPlaneId.html#a9">GetPlaneView</a>() == PlaneView::kU){
00600       v = astrip.<a class="code" href="classAlignmentStrip.html#o15">ghitpos</a>;
00601       u = astrip.<a class="code" href="classAlignmentStrip.html#o14">residual</a> + astrip.<a class="code" href="classAlignmentStrip.html#o6">tpos</a>;
00602    } <span class="keywordflow">else</span> {
00603       u = astrip.<a class="code" href="classAlignmentStrip.html#o15">ghitpos</a>;
00604       v = astrip.<a class="code" href="classAlignmentStrip.html#o14">residual</a> + astrip.<a class="code" href="classAlignmentStrip.html#o6">tpos</a>;
00605    }
00606    
00607 
00608    TVector3 ghituvz(u, v, astrip.<a class="code" href="classAlignmentStrip.html#o9">zpos</a>);
00609    TVector3 ghitxyz = ugh.<a class="code" href="classUgliGeomHandle.html#a33">uvz2xyz</a>(ghituvz);
00610    TVector3 lhitxyz = ush.<a class="code" href="classUgliStripHandle.html#a21">GlobalToLocal</a>(ghitxyz);
00611       
00612    astrip.<a class="code" href="classAlignmentStrip.html#o17">length</a> = 2.0*halflen;
00613    astrip.<a class="code" href="classAlignmentStrip.html#o16">lhitpos</a> = lhitxyz.x();
00614    astrip.<a class="code" href="classAlignmentStrip.html#o10">pigtail</a> = ush.<a class="code" href="classUgliStripHandle.html#a16">WlsPigtail</a>(StripEnd::kWest);
00615    astrip.<a class="code" href="classAlignmentStrip.html#o11">wlsbypass</a> = ush.<a class="code" href="classUgliStripHandle.html#a17">WlsBypass</a>();
00616 
00617    <span class="keywordflow">if</span>(fabs(lhitxyz.x()) &gt; halflen){
00618       astrip.<a class="code" href="classAlignmentStrip.html#o18">goodhit</a> = <span class="keyword">false</span>;
00619       <a class="code" href="classMakeAlignmentModule.html#r36">fNHitsOutsideStrip</a>++;
00620    }
00621 }
00622 
00623 
00624 <span class="comment">//__________________________________________________________________________________________________</span>
<a name="l00625"></a><a class="code" href="classMakeAlignmentModule.html#d6">00625</a> <span class="keywordtype">void</span> <a class="code" href="classMakeAlignmentModule.html#d6">MakeAlignmentModule::PrintJobStatistics</a>()
00626 {
00627    <a class="code" href="MsgService_8h.html#a4">MSG</a>(<span class="stringliteral">"Align"</span>, Msg::kInfo) &lt;&lt; <span class="stringliteral">"MakeAlignmentModule::EndJob()"</span>&lt;&lt; endl &lt;&lt; endl;    
00628 
00629    <a class="code" href="MsgService_8h.html#a4">MSG</a>(<span class="stringliteral">"Align"</span>, Msg::kInfo) &lt;&lt; <span class="stringliteral">"Cpu time = "</span> &lt;&lt; <a class="code" href="classMakeAlignmentModule.html#r48">fTimer</a>.CpuTime() &lt;&lt;endl;
00630    <a class="code" href="MsgService_8h.html#a4">MSG</a>(<span class="stringliteral">"Align"</span>, Msg::kInfo) &lt;&lt; <span class="stringliteral">"Real time = "</span> &lt;&lt; <a class="code" href="classMakeAlignmentModule.html#r48">fTimer</a>.RealTime() &lt;&lt;endl;
00631    <a class="code" href="MsgService_8h.html#a4">MSG</a>(<span class="stringliteral">"Align"</span>, Msg::kInfo) &lt;&lt; <span class="stringliteral">"fNPassedRecords  = "</span> &lt;&lt; <a class="code" href="classMakeAlignmentModule.html#r28">fNPassedRecords</a> &lt;&lt; endl;
00632    <a class="code" href="MsgService_8h.html#a4">MSG</a>(<span class="stringliteral">"Align"</span>, Msg::kInfo) &lt;&lt; <span class="stringliteral">"fNRecords  = "</span> &lt;&lt; <a class="code" href="classMakeAlignmentModule.html#r27">fNRecords</a> &lt;&lt; endl;
00633    <a class="code" href="MsgService_8h.html#a4">MSG</a>(<span class="stringliteral">"Align"</span>, Msg::kInfo) &lt;&lt; <span class="stringliteral">"fFailedCut = "</span> &lt;&lt; <a class="code" href="classMakeAlignmentModule.html#r35">fFailedCut</a> &lt;&lt; endl;
00634    <a class="code" href="MsgService_8h.html#a4">MSG</a>(<span class="stringliteral">"Align"</span>, Msg::kInfo) &lt;&lt; <span class="stringliteral">"fNFailedFit = "</span> &lt;&lt; <a class="code" href="classMakeAlignmentModule.html#r26">fNFailedFit</a> &lt;&lt; endl;
00635    <a class="code" href="MsgService_8h.html#a4">MSG</a>(<span class="stringliteral">"Align"</span>, Msg::kInfo) &lt;&lt; <span class="stringliteral">"fNFailedRead = "</span> &lt;&lt; <a class="code" href="classMakeAlignmentModule.html#r30">fNFailedRead</a> &lt;&lt; endl;
00636    <a class="code" href="MsgService_8h.html#a4">MSG</a>(<span class="stringliteral">"Align"</span>, Msg::kInfo) &lt;&lt; <span class="stringliteral">"fNMissedVPlane = "</span> &lt;&lt; <a class="code" href="classMakeAlignmentModule.html#r31">fNMissedVPlane</a> &lt;&lt; endl;
00637    <a class="code" href="MsgService_8h.html#a4">MSG</a>(<span class="stringliteral">"Align"</span>, Msg::kInfo) &lt;&lt; <span class="stringliteral">"fNMissedUPlane = "</span> &lt;&lt; <a class="code" href="classMakeAlignmentModule.html#r32">fNMissedUPlane</a> &lt;&lt; endl;
00638    <a class="code" href="MsgService_8h.html#a4">MSG</a>(<span class="stringliteral">"Align"</span>, Msg::kInfo) &lt;&lt; <span class="stringliteral">"fTotalVPlaneHits = "</span> &lt;&lt; <a class="code" href="classMakeAlignmentModule.html#r33">fTotalVPlaneHits</a> &lt;&lt; endl;
00639    <a class="code" href="MsgService_8h.html#a4">MSG</a>(<span class="stringliteral">"Align"</span>, Msg::kInfo) &lt;&lt; <span class="stringliteral">"fTotalUPlaneHits = "</span> &lt;&lt; <a class="code" href="classMakeAlignmentModule.html#r34">fTotalUPlaneHits</a> &lt;&lt; endl;
00640    <a class="code" href="MsgService_8h.html#a4">MSG</a>(<span class="stringliteral">"Align"</span>, Msg::kInfo) &lt;&lt; <span class="stringliteral">"fNHitsOutsideStrip = "</span>      &lt;&lt; <a class="code" href="classMakeAlignmentModule.html#r36">fNHitsOutsideStrip</a> &lt;&lt; endl;
00641    <span class="keywordflow">if</span>(<a class="code" href="classMakeAlignmentModule.html#r24">fApplyCuts</a>)
00642    {
00643       <a class="code" href="MsgService_8h.html#a4">MSG</a>(<span class="stringliteral">"Align"</span>, Msg::kInfo) &lt;&lt; <span class="stringliteral">"fNFailedCutMaxVStripCharge = "</span> &lt;&lt; <a class="code" href="classMakeAlignmentModule.html#r37">fNFailedCutMaxVStripCharge</a> &lt;&lt;endl;
00644       <a class="code" href="MsgService_8h.html#a4">MSG</a>(<span class="stringliteral">"Align"</span>, Msg::kInfo) &lt;&lt; <span class="stringliteral">"fNFailedCutMaxUStripCharge = "</span> &lt;&lt; <a class="code" href="classMakeAlignmentModule.html#r38">fNFailedCutMaxUStripCharge</a> &lt;&lt;endl;
00645       <a class="code" href="MsgService_8h.html#a4">MSG</a>(<span class="stringliteral">"Align"</span>, Msg::kInfo) &lt;&lt; <span class="stringliteral">"fNFailedTrackChargeCut  = "</span> &lt;&lt; <a class="code" href="classMakeAlignmentModule.html#r43">fNFailedTrackChargeCut</a> &lt;&lt; endl;
00646       <a class="code" href="MsgService_8h.html#a4">MSG</a>(<span class="stringliteral">"Align"</span>, Msg::kInfo) &lt;&lt; <span class="stringliteral">"fNFailedCosZCut  = "</span>        &lt;&lt; <a class="code" href="classMakeAlignmentModule.html#r45">fNFailedCosZCut</a> &lt;&lt; endl;
00647       <a class="code" href="MsgService_8h.html#a4">MSG</a>(<span class="stringliteral">"Align"</span>, Msg::kInfo) &lt;&lt; <span class="stringliteral">"fNFailedSigmaTPosCut  = "</span>   &lt;&lt; <a class="code" href="classMakeAlignmentModule.html#r47">fNFailedSigmaTPosCut</a> &lt;&lt; endl;
00648       <a class="code" href="MsgService_8h.html#a4">MSG</a>(<span class="stringliteral">"Align"</span>, Msg::kInfo) &lt;&lt; <span class="stringliteral">"fNFailedChargeRatioCut  = "</span> &lt;&lt; <a class="code" href="classMakeAlignmentModule.html#r46">fNFailedChargeRatioCut</a> &lt;&lt; endl;
00649       <a class="code" href="MsgService_8h.html#a4">MSG</a>(<span class="stringliteral">"Align"</span>, Msg::kInfo) &lt;&lt; <span class="stringliteral">"fNFailedStripChargeCut  = "</span> &lt;&lt; <a class="code" href="classMakeAlignmentModule.html#r44">fNFailedStripChargeCut</a> &lt;&lt; endl;
00650    }
00651 
00652    <a class="code" href="MsgService_8h.html#a4">MSG</a>(<span class="stringliteral">"Align"</span>, Msg::kInfo) &lt;&lt; endl;
00653    
00654    <span class="keywordflow">if</span>(<a class="code" href="classMakeAlignmentModule.html#r31">fNMissedVPlane</a> &gt; 1){
00655       Double_t size = <a class="code" href="classMakeAlignmentModule.html#r31">fNMissedVPlane</a>;
00656       <a class="code" href="classMakeAlignmentModule.html#r39">fMissedVPlaneMeanCharge</a> = <a class="code" href="classMakeAlignmentModule.html#r39">fMissedVPlaneMeanCharge</a>/size;
00657       <a class="code" href="classMakeAlignmentModule.html#r41">fMissedVPlaneChargeSigma</a> = <a class="code" href="nrutil__val_8h.html#a22">pow</a>(<a class="code" href="classMakeAlignmentModule.html#r41">fMissedVPlaneChargeSigma</a>/size -
00658                                      <a class="code" href="classMakeAlignmentModule.html#r39">fMissedVPlaneMeanCharge</a>*<a class="code" href="classMakeAlignmentModule.html#r39">fMissedVPlaneMeanCharge</a>, 0.5);
00659       <a class="code" href="MsgService_8h.html#a4">MSG</a>(<span class="stringliteral">"Align"</span>, Msg::kInfo) &lt;&lt; <span class="stringliteral">"fMissedVPlaneMeanCharge = "</span> &lt;&lt; fMissedVPlaneMeanCharge
00660                                &lt;&lt; <span class="stringliteral">" +/- "</span> &lt;&lt; <a class="code" href="classMakeAlignmentModule.html#r41">fMissedVPlaneChargeSigma</a> &lt;&lt;endl;
00661    }
00662    
00663    <span class="keywordflow">if</span>(<a class="code" href="classMakeAlignmentModule.html#r32">fNMissedUPlane</a> &gt; 1){
00664       Double_t size = <a class="code" href="classMakeAlignmentModule.html#r32">fNMissedUPlane</a>;
00665       <a class="code" href="classMakeAlignmentModule.html#r40">fMissedUPlaneMeanCharge</a> = <a class="code" href="classMakeAlignmentModule.html#r40">fMissedUPlaneMeanCharge</a>/size;
00666       <a class="code" href="classMakeAlignmentModule.html#r42">fMissedUPlaneChargeSigma</a> = <a class="code" href="nrutil__val_8h.html#a22">pow</a>(<a class="code" href="classMakeAlignmentModule.html#r42">fMissedUPlaneChargeSigma</a>/size -
00667                                      <a class="code" href="classMakeAlignmentModule.html#r40">fMissedUPlaneMeanCharge</a>*<a class="code" href="classMakeAlignmentModule.html#r40">fMissedUPlaneMeanCharge</a>, 0.5);
00668       <a class="code" href="MsgService_8h.html#a4">MSG</a>(<span class="stringliteral">"Align"</span>, Msg::kInfo) &lt;&lt; <span class="stringliteral">"fMissedUPlaneMeanCharge = "</span> &lt;&lt; fMissedUPlaneMeanCharge
00669                                &lt;&lt; <span class="stringliteral">" +/- "</span> &lt;&lt; <a class="code" href="classMakeAlignmentModule.html#r42">fMissedUPlaneChargeSigma</a> &lt;&lt;endl;
00670    }     
00671 
00672     <a class="code" href="MsgService_8h.html#a4">MSG</a>(<span class="stringliteral">"Align"</span>, Msg::kInfo) &lt;&lt; endl;
00673 }
00674 
00675 
00676 <span class="comment">//__________________________________________________________________________________________________</span>
<a name="l00677"></a><a class="code" href="classMakeAlignmentModule.html#d7">00677</a> <span class="keywordtype">void</span>  <a class="code" href="classMakeAlignmentModule.html#d7">MakeAlignmentModule::PrintAlignmentStrip</a>(<span class="keyword">const</span> <a class="code" href="classAlignmentStrip.html">AlignmentStrip</a>&amp; astrip)
00678 {   
00679    <span class="comment">//Format msg service so that time and charge can be properly deisplayed</span>
00680    <a class="code" href="classMsgFormat.html">MsgFormat</a> ffmt(<span class="stringliteral">"%10.9f"</span>);
00681    <a class="code" href="classMsgFormat.html">MsgFormat</a> ffrt(<span class="stringliteral">"%5.4f"</span>);
00682    <a class="code" href="classMsgFormat.html">MsgFormat</a> fimt(<span class="stringliteral">"%5d"</span>);
00683    
00684    <a class="code" href="MsgService_8h.html#a4">MSG</a>(<span class="stringliteral">"Align"</span>, Msg::kVerbose) &lt;&lt; <a class="code" href="classPlexStripEndId.html">PlexStripEndId</a>(astrip.<a class="code" href="classAlignmentStrip.html#o0">plexseid</a>)
00685                                &lt;&lt; <span class="stringliteral">" charge = "</span> &lt;&lt; fimt(astrip.<a class="code" href="classAlignmentStrip.html#o4">charge</a>)
00686                                &lt;&lt; <span class="stringliteral">" begtime = "</span> &lt;&lt; ffmt(astrip.<a class="code" href="classAlignmentStrip.html#o12">begtime</a>)
00687                                &lt;&lt; <span class="stringliteral">" ndigit = "</span> &lt;&lt; astrip.<a class="code" href="classAlignmentStrip.html#o3">ndigit</a>
00688                                &lt;&lt; <span class="stringliteral">" residual = "</span> &lt;&lt; ffrt(astrip.<a class="code" href="classAlignmentStrip.html#o14">residual</a>) &lt;&lt; endl;
00689 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Mon Feb 16 04:51:09 2009 for loon by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.5 </small></address>
</body>
</html>
