<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>StraightTrackAlignment.cxx Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.16 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>StraightTrackAlignment.cxx</h1><a href="StraightTrackAlignment_8cxx.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="preprocessor">#include "<a class="code" href="StraightTrackAlignment_8h.html">Alignment/StraightTrackAlignment.h</a>"</font>
00002 <font class="preprocessor">#include "<a class="code" href="ScintModule_8h.html">Alignment/ScintModule.h</a>"</font>
00003 <font class="preprocessor">#include "<a class="code" href="AlignHists_8h.html">Alignment/AlignHists.h</a>"</font>
00004 
00005 <font class="preprocessor">#include "<a class="code" href="CandTrackHandle_8h.html">RecoBase/CandTrackHandle.h</a>"</font>
00006 <font class="preprocessor">#include "<a class="code" href="UgliScintPlnHandle_8h.html">UgliGeometry/UgliScintPlnHandle.h</a>"</font>
00007 <font class="preprocessor">#include "<a class="code" href="NavSet_8h.html">Navigation/NavSet.h</a>"</font>
00008 
00009 <font class="preprocessor">#include &lt;vector&gt;</font>
00010 <font class="preprocessor">#include &lt;fstream&gt;</font>
00011 
<a name="l00012"></a><a class="code" href="classStraightTrackAlignment.html#a0">00012</a> <a class="code" href="classStraightTrackAlignment.html#a0">StraightTrackAlignment::StraightTrackAlignment</a>()
00013     : fHister(0)
00014       ,fMinPlanes(14)            <font class="comment">// hard code for now.</font>
00015       ,fHistName(0)
00016 {
00017 }
00018 
<a name="l00019"></a><a class="code" href="classStraightTrackAlignment.html#a1">00019</a> <a class="code" href="classStraightTrackAlignment.html#a1">StraightTrackAlignment::~StraightTrackAlignment</a>()
00020 {
00021     <font class="keywordflow">if</font> (fHister) <font class="keyword">delete</font> <a class="code" href="classStraightTrackAlignment.html#o2">fHister</a>;
00022 }
00023 
00024 <font class="comment">// Create the histogrammer</font>
<a name="l00025"></a><a class="code" href="classStraightTrackAlignment.html#a2">00025</a> <font class="keywordtype">void</font> <a class="code" href="classStraightTrackAlignment.html#a2">StraightTrackAlignment::Init</a>(<a class="code" href="classUgliGeomHandle.html">UgliGeomHandle</a>&amp; ugh, <font class="keyword">const</font> <font class="keywordtype">char</font>* histname)
00026 {
00027     <a class="code" href="classStraightTrackAlignment.html#o6">fHistName</a> = histname;
00028     vector&lt;UgliScintPlnHandle&gt; planevec = ugh.<a class="code" href="classUgliGeomHandle.html#a11">GetScintPlnHandleVector</a>();
00029     <a class="code" href="classStraightTrackAlignment.html#o4">fNplanes</a> = planevec.size();
00030     <a class="code" href="classStraightTrackAlignment.html#o5">fNmdlperplane</a> = planevec[0].GetScintMdlHandleVector().size();
00031 }
00032 
00033 <font class="comment">// return the ScintModule containing the given USH.</font>
<a name="l00034"></a><a class="code" href="classStraightTrackAlignment.html#c2">00034</a> <a class="code" href="classScintModule.html">ScintModule</a>* <a class="code" href="classStraightTrackAlignment.html#c2">StraightTrackAlignment::LookupScintModule</a>(<a class="code" href="classUgliStripHandle.html">UgliStripHandle</a> ush)
00035 {
00036     <a class="code" href="classUgliScintMdlHandle.html">UgliScintMdlHandle</a> usmh = ush.<a class="code" href="classUgliStripHandle.html#a21">GetScintMdlHandle</a>();
00037     <a class="code" href="classPlexScintMdlId.html">PlexScintMdlId</a> smid = usmh.<a class="code" href="classUgliScintMdlHandle.html#a7">GetPlexScintMdlId</a>();
00038 
00039     ScintModuleLookup::iterator it = <a class="code" href="classStraightTrackAlignment.html#o1">fSMLookup</a>.find(smid);
00040     <font class="keywordflow">if</font> (it == <a class="code" href="classStraightTrackAlignment.html#o1">fSMLookup</a>.end()) {  <font class="comment">// D.N.E.</font>
00041         <a class="code" href="classScintModule.html">ScintModule</a>* smod = <font class="keyword">new</font> <a class="code" href="classScintModule.html">ScintModule</a>(usmh);
00042         assert(smod);
00043         <a class="code" href="classStraightTrackAlignment.html#o1">fSMLookup</a>[smid] = smod;
00044         <font class="keywordflow">return</font> smod;
00045     }
00046 
00047     assert(it-&gt;second);
00048     <font class="keywordflow">return</font> it-&gt;second;
00049 }
00050 
00051 <font class="comment">// Save any tracks</font>
<a name="l00052"></a><a class="code" href="classStraightTrackAlignment.html#a3">00052</a> <font class="keywordtype">void</font> <a class="code" href="classStraightTrackAlignment.html#a3">StraightTrackAlignment::AddTrack</a> (<font class="keyword">const</font> <a class="code" href="classCandTrackHandle.html">CandTrackHandle</a>&amp; track_handle)
00053 {
00054     <font class="keywordtype">int</font> nhits = track_handle.<a class="code" href="classCandHandle.html#a19">GetNDaughters</a>();
00055     <font class="keywordflow">if</font> (nhits &lt; <a class="code" href="classStraightTrackAlignment.html#o3">fMinPlanes</a>) <font class="keywordflow">return</font>;
00056 
00057 <font class="comment">//    cerr &lt;&lt; nhits &lt;&lt; " hits\n";</font>
00058 
00059     <a class="code" href="classUgliGeomHandle.html">UgliGeomHandle</a> ugh(*(track_handle.<a class="code" href="classCandHandle.html#a24">GetVldContext</a>()));
00060     CandStripHandleItr sitr(track_handle.<a class="code" href="classCandHandle.html#a15">GetDaughterIterator</a>());
00061     
00062     <a class="code" href="classStraightTrackAlignment.html#s0">StraightTrack</a> st[2];
00063     <a class="code" href="classCandStripHandle.html">CandStripHandle</a>* csh = 0;
00064     <font class="keywordflow">while</font> ((csh = sitr())) {
00065         cerr &lt;&lt; <font class="stringliteral">"."</font>;
00066         <a class="code" href="classPlexStripEndId.html">PlexStripEndId</a> seid = csh-&gt;<a class="code" href="classCandStripHandle.html#a16">GetStripEndId</a>();
00067         <font class="keywordtype">int</font> view = 0;
00068         <font class="keywordflow">if</font> (seid.<a class="code" href="classPlexPlaneId.html#a9">GetPlaneView</a>() != <a class="code" href="classPlaneView.html#s13s4">PlaneView::kV</a>) view = 1;
00069         st[view].push_back(ugh.<a class="code" href="classUgliGeomHandle.html#a10">GetStripHandle</a>(seid));
00070     }
00071     cerr &lt;&lt; endl;
00072 
00073     <font class="keywordflow">if</font> (st[0].size()) {
00074         <a class="code" href="classStraightTrackAlignment.html#o0">fTracks</a>[0].push_back(st[0]);
00075     }
00076     <font class="keywordflow">if</font> (st[1].size()) {
00077         <a class="code" href="classStraightTrackAlignment.html#o0">fTracks</a>[1].push_back(st[1]);
00078     }
00079 }
00080 
00081 
00082 <font class="comment">// Fits a linear track to the StraighTrack's hits between "lit" and</font>
00083 <font class="comment">// "end" while skipping the hit "skip".  The predicted transverse</font>
00084 <font class="comment">// position of "skip" is fed to skip's ScintModule.</font>
00085 <font class="keywordtype">double</font>
<a name="l00086"></a><a class="code" href="classStraightTrackAlignment.html#c3">00086</a> <a class="code" href="classStraightTrackAlignment.html#c3">StraightTrackAlignment::FitTrackLessOne</a>(StraightTrack::iterator lit,
00087                                         StraightTrack::iterator end,
00088                                         StraightTrack::iterator skip)
00089 {
00090     <font class="comment">// Linear regression parameters.  See for eg. Num Rec Ch 15.</font>
00091     <font class="comment">// x is Z, y is TPos (U or V).</font>
00092     <font class="keywordtype">double</font> S, Sx, Sy, Sxx, Sxy;
00093     S=Sx=Sy=Sxx=Sxy=0.0;
00094 
00095     <font class="keywordtype">int</font> count = 0;
00096 
00097     <font class="keywordflow">for</font> (;lit != end; ++lit) {
00098         <font class="keywordflow">if</font> (lit == skip) <font class="keywordflow">continue</font>;
00099 
00100         <a class="code" href="classUgliStripHandle.html">UgliStripHandle</a> ush = (*lit);
00101         <a class="code" href="classScintModule.html">ScintModule</a>* smod = this-&gt;<a class="code" href="classStraightTrackAlignment.html#c2">LookupScintModule</a>(ush);
00102 
00103         <font class="keywordtype">float</font> x = ush.<a class="code" href="classUgliStripHandle.html#a16">GlobalPos</a>(0)(2);
00104         <font class="keywordtype">float</font> y = ush.<a class="code" href="classUgliStripHandle.html#a11">GetTPos</a>() + smod-&gt;<a class="code" href="classScintModule.html#a6">GetOffset</a>();
00105         
00106         Sx += x;
00107         Sy += y;
00108         Sxx += x*x;
00109         Sxy += x*y;        
00110 
00111         ++count;
00112     }
00113     S = count;
00114 
00115     <font class="comment">// Note, since I assume a constant uncertainty in the transverse</font>
00116     <font class="comment">// position measurement, it drops out of hte final result.</font>
00117 
00118     <font class="comment">// The linear fit: y = a + bx</font>
00119     <font class="keywordtype">double</font> delta = S*Sxx - Sx*Sx;
00120     <font class="keywordtype">double</font> <a class="code" href="TCL_8cxx.html#a8">a</a> = (Sxx*Sy - Sx*Sxy)/delta;
00121     <font class="keywordtype">double</font> <a class="code" href="TCL_8cxx.html#a9">b</a> = (S*Sxy - Sx*Sy)/delta;
00122 
00123     <font class="keywordtype">double</font> predict = <a class="code" href="TCL_8cxx.html#a8">a</a> + <a class="code" href="TCL_8cxx.html#a9">b</a>*(*skip).GlobalPos(0)(2);
00124     predict -= (*skip).GetTPos();
00125     <a class="code" href="classScintModule.html">ScintModule</a>* smod = this-&gt;<a class="code" href="classStraightTrackAlignment.html#c2">LookupScintModule</a>(*skip);
00126     <font class="keywordflow">if</font> (smod) smod-&gt;<a class="code" href="classScintModule.html#a5">AccumResid</a>(predict);
00127     <font class="keywordflow">else</font> {
00128         cerr &lt;&lt; <font class="stringliteral">"Failed to lookup scint module!\n"</font>;
00129     }
00130     <font class="keywordflow">return</font> predict;
00131 }
00132 
00133 <font class="comment">// Fits track once for each digit.</font>
<a name="l00134"></a><a class="code" href="classStraightTrackAlignment.html#a4">00134</a> <font class="keywordtype">double</font> <a class="code" href="classStraightTrackAlignment.html#a4">StraightTrackAlignment::ApplyTrack</a>(StraightTrack st, 
00135                                           <a class="code" href="classPlaneView.html#s0">PlaneView::PlaneView_t</a> view)
00136 {
00137     <font class="keywordtype">double</font> tot = 0;
00138     StraightTrack::iterator lit, first=st.begin(), end = st.end();
00139 
00140     vector&lt;int&gt; planev, mdlv, stripv;
00141     vector&lt;double&gt; residv;
00142 
00143     <font class="keywordtype">int</font> count = 0;
00144     <font class="keywordflow">for</font> (lit = first; lit != end; ++lit) {
00145 <font class="comment">//        cerr &lt;&lt; ".";</font>
00146         <font class="keywordtype">double</font> resid = this-&gt;<a class="code" href="classStraightTrackAlignment.html#c3">FitTrackLessOne</a>(first,end,lit);
00147         <font class="keywordflow">if</font> (fHister) {
00148             <a class="code" href="classUgliScintMdlHandle.html">UgliScintMdlHandle</a> usmh = (*lit).GetScintMdlHandle();
00149             <a class="code" href="classPlexPlaneId.html">PlexPlaneId</a> ppid = usmh.<a class="code" href="classUgliScintMdlHandle.html#a8">GetPlexPlaneId</a>();
00150             residv.push_back(resid);
00151             planev.push_back(ppid.<a class="code" href="classPlexPlaneId.html#a7">GetPlane</a>());
00152             stripv.push_back((*lit).GetSEId().GetStrip());
00153             mdlv.push_back(usmh.<a class="code" href="classUgliScintMdlHandle.html#a9">GetModuleNum</a>());
00154         }
00155         tot += resid;
00156         ++count;
00157     }
00158     <font class="keywordflow">if</font> (fHister) <a class="code" href="classStraightTrackAlignment.html#o2">fHister</a>-&gt;<a class="code" href="classAlignHists.html#a3">ApplyTrack</a>(view,stripv,planev,mdlv,residv);
00159     
00160     <font class="keywordflow">return</font> count ? tot/count : 0;
00161 }
00162 
00163 
<a name="l00164"></a><a class="code" href="classStraightTrackAlignment.html#a6">00164</a> <font class="keywordtype">double</font> <a class="code" href="classStraightTrackAlignment.html#a5">StraightTrackAlignment::ApplyAllTracks</a>(<a class="code" href="classPlaneView.html#s0">PlaneView::PlaneView_t</a> the_view)
00165 {
00166     <font class="keywordtype">int</font> view = 0;
00167     <font class="keywordflow">if</font> (the_view == <a class="code" href="classPlaneView.html#s13s4">PlaneView::kV</a>) view = 1;
00168     list&lt;StraightTrack&gt;::iterator lit, end = <a class="code" href="classStraightTrackAlignment.html#o0">fTracks</a>[view].end();
00169 
00170     cerr &lt;&lt; <font class="stringliteral">"Applying "</font> &lt;&lt; <a class="code" href="classStraightTrackAlignment.html#o0">fTracks</a>[view].size() &lt;&lt; <font class="stringliteral">" tracks in view "</font> 
00171          &lt;&lt; view &lt;&lt; endl;
00172 
00173     <font class="keywordtype">double</font> tot = 0;
00174     <font class="keywordtype">int</font> count = 0;
00175     <font class="keywordflow">for</font> (lit=<a class="code" href="classStraightTrackAlignment.html#o0">fTracks</a>[view].begin(); lit != end; ++lit) {
00176         tot += this-&gt;<a class="code" href="classStraightTrackAlignment.html#a4">ApplyTrack</a>(*lit,the_view);
00177         ++ count;
00178     }
00179     cerr &lt;&lt; <font class="stringliteral">"Done applying tracks\n"</font>;
00180     <font class="keywordflow">return</font> count ? tot/count : 0;
00181 }
<a name="l00182"></a><a class="code" href="classStraightTrackAlignment.html#a5">00182</a> <font class="keywordtype">double</font> <a class="code" href="classStraightTrackAlignment.html#a5">StraightTrackAlignment::ApplyAllTracks</a>()
00183 {
00184     <font class="keyword">static</font> <font class="keywordtype">bool</font> been_here = <font class="keyword">false</font>;
00185     <font class="keywordflow">if</font> (! been_here) {
00186         <a class="code" href="classStraightTrackAlignment.html#o2">fHister</a> = <font class="keyword">new</font> <a class="code" href="classAlignHists.html">AlignHists</a>(<a class="code" href="classStraightTrackAlignment.html#o4">fNplanes</a>,<a class="code" href="classStraightTrackAlignment.html#o5">fNmdlperplane</a>,<a class="code" href="classStraightTrackAlignment.html#o6">fHistName</a>);
00187         been_here = <font class="keyword">true</font>;
00188     }
00189                                  
00190 
00191     <font class="keywordtype">double</font> ret = 0;
00192     ret += this-&gt;<a class="code" href="classStraightTrackAlignment.html#a5">ApplyAllTracks</a>(<a class="code" href="classPlaneView.html#s13s3">PlaneView::kU</a>);
00193     ret += this-&gt;<a class="code" href="classStraightTrackAlignment.html#a5">ApplyAllTracks</a>(<a class="code" href="classPlaneView.html#s13s4">PlaneView::kV</a>);
00194     <font class="keywordflow">return</font> ret/2.0;
00195 }
00196 
<a name="l00197"></a><a class="code" href="classStraightTrackAlignment.html#a7">00197</a> <font class="keywordtype">void</font> <a class="code" href="classStraightTrackAlignment.html#a7">StraightTrackAlignment::ApplyAllOffsets</a>(<font class="keywordtype">void</font>)
00198 {
00199     ScintModuleLookup::iterator mit, end = <a class="code" href="classStraightTrackAlignment.html#o1">fSMLookup</a>.end();
00200     <font class="keywordflow">for</font> (mit = <a class="code" href="classStraightTrackAlignment.html#o1">fSMLookup</a>.begin(); mit != end; ++mit) {
00201         <a class="code" href="classScintModule.html">ScintModule</a>* sm = mit-&gt;second;
00202         <font class="keywordflow">if</font> (!sm) {
00203             cerr &lt;&lt; <font class="stringliteral">"Bad ScintModule in lookup\n"</font>;
00204             <font class="keywordflow">continue</font>;
00205         }
00206         sm-&gt;<a class="code" href="classScintModule.html#a3">UpdateOffsets</a>();
00207         sm-&gt;<a class="code" href="classScintModule.html#a4">ClearStatistics</a>();
00208     }
00209     <font class="keywordflow">if</font> (fHister) <a class="code" href="classStraightTrackAlignment.html#o2">fHister</a>-&gt;<a class="code" href="classAlignHists.html#a4">IncrementIteration</a>();
00210 }
00211 
</pre></div><hr><address align="right"><small>Generated on Wed Sep 4 19:01:20 2002 for loon by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.16 </small></address>
</body>
</html>
